<!DOCTYPE html>

<html lang="en">
<head>
    <title>7.2 - Physical storage &mdash; Apache Directory</title>

    <link href="/css/common.css" rel="stylesheet" type="text/css"/>
    <link href="/css/turquoise.css" rel="stylesheet" type="text/css"/>

    <link rel="shortcut icon" href="/images/mavibot-icon_16x16.png">
</head>
<body>
<div id="container">
    <div id="header">
    <div id="subProjectsNavBar">
        <a href="/">
             
                Main
            
        </a>
        &nbsp;|&nbsp;
        <a href="/apacheds/">
             
                ApacheDS
            
        </a>
        &nbsp;|&nbsp;
        <a href="/studio/">
             
                Studio
            
        </a>
        &nbsp;|&nbsp;
        <a href="/api/">
             
                LDAP API
            
        </a>
        &nbsp;|&nbsp;
        <a href="/mavibot/">
            
                <strong>Mavibot</strong>
            
        </a>
        &nbsp;|&nbsp;
        <a href="/scimple/">
             
                SCIMple
            
        </a>
        &nbsp;|&nbsp;
        <a href="/fortress/">
             
                Fortress
            
        </a>
        &nbsp;|&nbsp;
        <a href="/kerby/">
             
                Kerby
            
        </a>
    </div>
</div>


    <div id="content">
        <div id="leftColumn">
            <div id="navigation">
                
                <h5>Mavibot 1.0</h5>
                <ul>
                    <li><a href="/mavibot/">Home</a></li>
                    <li><a href="/mavibot/news.html">News</a></li>
                </ul>

                <h5>Downloads</h5>
                <ul>
                    <li><a href="/mavibot/downloads.html">Version 1.0.0-M8</a>&nbsp;&nbsp;<img src="/images/new_badge.gif" alt="" style="margin-bottom:-3px;" border="0"></li>
                    <li><a href="/mavibot/download-old-versions.html">Older versions</a></li>
                </ul>

                <h5>Getting Started</h5>
                <ul>
                    <li><a href="/mavibot/vision.html">Vision</a></li>
                </ul>

                <h5>Documentation</h5>
                <ul>
                    <li><a href="/mavibot/five-minutes-tutorial.html">Five minutes tutorial</a></li>
                    <li><a href="/mavibot/user-guide.html">User Guide</a></li>
                    <li><a href="/mavibot/gen-docs/latest/apidocs/">JavaDocs</a></li>
                    <li><a href="/mavibot/gen-docs/latest/xref/">Cross-Reference</a></li>
                    
                    <li><a href="/mavibot/developer-guide.html">Developer Guide</a></li>
                </ul>

                <h5>Support</h5>
<ul>
    <li><a href="/mailing-lists-and-irc.html">Mailing Lists &amp; IRC</a></li>
    <li><a href="/sources.html">Sources</a></li>
    <li><a href="/issue-tracking.html">Issue Tracking</a></li>
    <li><a href="/commercial-support.html">Commercial Support</a></li>
</ul>

<h5>Community</h5>
<ul>
    <li><a href="/contribute.html">How to Contribute</a></li>
    <li><a href="/team.html">Team</a></li>
    <li><a href="/original-project-proposal.html">Original Project Proposal</a></li>
    <li><a href="/special-thanks.html" class="external-link" rel="nofollow">Special Thanks</a></li>
</ul>

<h5>About Apache</h5>
<ul>
    <li><a href="http://www.apache.org/">Apache</a></li>
    <li><a href="http://www.apache.org/licenses/">License</a></li>
    <li><a href="http://www.apache.org/foundation/sponsorship.html">Sponsorship</a></li>
    <li><a href="http://www.apache.org/foundation/thanks.html">Thanks</a></li>
    <li><a href="http://www.apache.org/security/">Security</a></li>
</ul>

            </div>
        </div>
        <div id="rightColumn">
            
    <div class="nav">
        <div class="nav_prev">
            
                
                <a href="7.1-logical-structure.html">7.1 - Logical Structure</a>
            
        </div>
        <div class="nav_up">
            
                
                <a href="7-btree-internals.html">7 - Mavibot Internals</a>
            
        </div>
        <div class="nav_next">
            
                
                <a href="7.3-serializations.html">7.3 - Serializations</a>
            
        </div>
        <div class="clearfix"></div>
    </div>


            
	<h1 id="72---physical-storage">7.2 - Physical storage</h1>
<p>When associated with a RecordManager, Mavibot stores all the Btrees in one single file, which is split in many physical pages, all having the same size.</p>
<blockquote>
<p><strong>Note</strong>
Currently, the choice was to use same size for all the pages, regardless of the data stored into them. The rationnal is to
get close to the OS page size (frequently 512 bytes or 4096 bytes). This is not necessarily the best choice though, let&rsquo;s say
it&rsquo;s something we might want to change later.</p>
</blockquote>
<h2 id="general-file-structure">General file structure</h2>
<p>The data is stored in a pure binary file. All btrees are stored in this single file.</p>
<p>This file is considered as a FileSystem, with fixed size &lsquo;pages&rsquo; (a page is an array of bytes). The page size is fixed when the RecordManager is created. The data represented in a logical page may spread across many physical pages.</p>
<h3 id="pageio">PageIO</h3>
<p>A <em>PageIO</em> represents a physical block of the database file and contains complete or a part of the logical page&rsquo;s data. PageIOs of a logical page are linked together.</p>
<p>Each <em>PageIO</em> has an eight byte pointer at the beginning, pointing to the next PageIO (or to nothing, if it is the last <em>PageIO</em> in the chain), plus an extra 4 bytes on the first <em>PageIO</em> to define the number of bytes stored in the chain of PageIO. Here is the mapping between a logical page and some PageIOs :</p>
<p><img src="images/PageIOLogical.png" alt="PageIO mapping"></p>
<p>All <em>PageIO</em>s are contiguous on disk, but the <em>PageIO</em>s used to store a logical page may be located anywhere on the disk, they don&rsquo;t have to be continuous.</p>
<p>Here is the structure of a <em>PageIO</em> on disk :</p>
<ul>
<li>next page offset (8 bytes) : the offset of the next <em>PageIO</em>, or -1 if it is the last <em>PageIO</em></li>
<li>data size (4 bytes) : the size of the data stored, this is only set in the first <em>PageIO</em> of the chain of <em>PageIO</em>s used to store a logical page.</li>
<li>data (N bytes) : a block of data, whose size will be min( PageSize - offset - data size, data size) for the first <em>PageIO</em> or min( PageSize - offset, data size) for any other <em>PageIO</em>s</li>
</ul>
<h2 id="logical-structure-mapping-on-disk">Logical structure mapping on disk</h2>
<p>We will now describe how each logical structure is serialized on disk.</p>
<h3 id="recordmanager-header">RecordManager header</h3>
<p>A few bytes at the beginning of the file are used to store some critical information about the RecordManager. Here is the list of stored information details :</p>
<ul>
<li>The <em>PageIO</em> size (in bytes)</li>
<li>The number of managed B-Trees</li>
<li>The offset of the first free page</li>
<li>The offset of the current B-tree of B-trees</li>
<li>The offset of the previous B-tree of B-trees, if an update operation was performed</li>
<li>The offset of the current CopiedPages B-tree</li>
<li>The offset of the previous CopiedPages B-tree, if an update operation was performed</li>
</ul>
<p>Here is a picture that shows the header content in two different cases (when an update operation is not completed, and when it&rsquo;s completed) :</p>
<p><img src="images/RMHeader.png" alt="RecordManager header"></p>
<p>Recordmanager tracks the free pages (a free page is a PageIO that is not in use, for instance when a key was deleted). This is done by linking each unused PageIO together and finally updating the references of fisrt and last free pages. When there are no free pages these pointers contain -1 as the offset value.</p>
<p>This header is stored in a <em>PageIO</em>, at the very beginning of the file.</p>
<h3 id="the-recordmanager-structure">The RecordManager structure</h3>
<p>Each <em>BTree</em> has a header that contains many details about it, and points to a <em>rootPage</em> which is the current root (i.e., the root of the latest revision).</p>
<p>The special BTree called &lsquo;btree of btrees&rsquo;(a.k.a BoB) contains the names and revisions of each managed BTree. To load the managed btrees during startup, this BoB is read to find the latest revision of each BTree and the associated root page&rsquo;s offset based on which the btree will be loaded.</p>
<h4 id="the-b-tree-info">The B-tree info</h4>
<p>Each <em>B-tree</em> has some metadata that will never change after creation. Here is the list of the details stored :</p>
<ul>
<li>pageSize (4 bytes) : the number of elements we cans store in a <em>Node</em> or a <em>Leaf</em>. It&rsquo;s not related in any way with the <em>PageIO</em> size.</li>
<li>nameSize (4 bytes) : The <em>BTree</em> name size</li>
<li>name (nameSize bytes) : the <em>BTree</em> name</li>
<li>keySerializerSize (4 bytes) : The size of the java <em>FQCN</em> for the key serializer</li>
<li>keySerializer (keySerializerSize bytes) : The java <em>FQCN</em> for the key serializer</li>
<li>valueSerializerSize (4 bytes) : The size of the java <em>FQCN</em> for the value serializer</li>
<li>valueSerializer (valueSerializerSize bytes): The java <em>FQCN</em> for the value serializer</li>
<li>dupsAllowed (1 byte): tells if the <em>BTree</em> can have duplicated values.</li>
</ul>
<p>Note that a <em>B-tree</em> info can be stored in one or many <em>IOPage</em>s, depending on its size.</p>
<h4 id="the-btree-header">The BTree header</h4>
<p>There will be one <em>B-tree</em> header per revision.</p>
<p>Each <em>BTree</em> has to maintain many details, such as :</p>
<ul>
<li>revision (8 bytes) : the current revision of the <em>BTree</em>. This value is updated after each modification in the <em>BTree</em>.</li>
<li>nbElems (8 bytes) : the total number of elements we have in the <em>BTree</em>. This is updated after each modification.</li>
<li>rootPage offset (8 bytes) : the position in the file where the <em>rootPage</em> is stored</li>
<li>btreeInfo offset (8 bytes) : the position of the <em>B-tree</em> info page in the file</li>
</ul>
<p>Here is a diagram which represents the <em>B-tree header</em> and the <em>B-tree info</em> data structures on disk :</p>
<p><img src="images/btreeHeader.png" alt="BTreeHeader"></p>
<p>Note that they can be stored on one or more <em>IOPage</em>s, depending on the size.</p>
<p>The below picture shows the contents of the btree headers present in the database file when more than one btree is stored.</p>
<p><img src="images/BTree.png" alt="BTrees"></p>
<p>Note that each <em>B-tree Header</em> has one root page, even if it contains no data. In this picture, the root page is shown just after the <em>BTree</em> it is associated with, but after a few updates, the root page may be stored elsewhere on the disk.</p>
<h4 id="the-nodes-and-leaves">The Nodes and Leaves</h4>
<p>Nodes and Leaves are logical <em>BTree</em> pages which are stored in one or more <em>PageIO</em>s. They have slightly different data structures, as <em>Node</em>s contain pointers to <em>Leaves</em>, and no data, while <em>Leaves</em> contain data, but both contain the keys. The number of keys present in a <em>Node</em> is higher
than that of a <em>Leaf</em> by one.</p>
<p>On disk, a <em>Node</em> will have pointers to some other logical pages, those pointers will be offset of the first <em>PageIO</em> used to store the logical page it points to.</p>
<p>The below picture shows a <em>Node</em> and <em>Leaf</em> after serialized to disk :</p>
<p><img src="images/nodeLeaf.png" alt="Node and Leaf"></p>
<p>Note that this is necessary to store the size of the serialized data in order to know how many <em>PageIO</em>s will be needed to store the logical page.</p>
<p>The <em>rootPage</em> can be either a <em>Node</em> or a <em>Leaf</em>.</p>
<h4 id="potential-improvement">Potential improvement</h4>
<p>We can get better performance by serializing the data differently. Instead of storing keys and values as byte arrays prefixed by their length, we could store an array of keys and values&rsquo; offsets before the associated byte[]. Here is the resulting data structure, once serialized :</p>
<p><img src="images/nodeLeaf2.png" alt="Node and Leaf, improved"></p>
<p>(The <em>Node</em> is not described, as it&rsquo;s basically the same data structure, but with one extra value).</p>
<p>It does not need more space to serialize the data this way, as the offsets are ints, and in the previous version, those ints are used to store the length of the keys and values anyway.</p>
<p>The gain is that we can have access to a given key and value without having to read all the previous keys and values. Also we can now read a leaf or a node without having to deserialize all the keys and values they contain.</p>


            
    <div class="nav">
        <div class="nav_prev">
            
                
                <a href="7.1-logical-structure.html">7.1 - Logical Structure</a>
            
        </div>
        <div class="nav_up">
            
                
                <a href="7-btree-internals.html">7 - Mavibot Internals</a>
            
        </div>
        <div class="nav_next">
            
                
                <a href="7.3-serializations.html">7.3 - Serializations</a>
            
        </div>
        <div class="clearfix"></div>
    </div>


        </div>
        <div id="endContent"></div>
    </div>

    <div id="footer">
    &copy; 2003-2020, <a href="http://www.apache.org">The Apache Software Foundation</a> - <a href="/privacy-policy.html">Privacy Policy</a><br />
    Apache Directory, ApacheDS, Apache Directory Server, Apache Directory Studio, Apache LDAP API, Apache Triplesec,
    Triplesec, Apache Mavibot, Mavibot, Apache eSCIMo, eSCIMo, Apache SCIMple, SCIMple,Fortress, Apache Fortress, EnMasse,
    Apache EnMasse, Apache Kerby, Kerby, Apache, the Apache feather logo, and the Apache Directory project logos are
    trademarks of The Apache Software Foundation.
</div>

</div>

</body>

</html>
