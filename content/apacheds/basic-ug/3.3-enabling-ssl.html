<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="utf-8">
    <title>3.3 - How to enable SSL &mdash; Apache Directory</title>

    <link href="/css/common.css" rel="stylesheet" type="text/css"/>
    <link href="/css/green.css" rel="stylesheet" type="text/css"/>

    <link rel="shortcut icon" href="/images/server-icon_16x16.png" />
    <script src="https://www.apachecon.com/event-images/snippet.js"></script>
</head>

<body>
<div id="container">
    <div id="header">
    <div id="subProjectsNavBar">
        <a href="/">
             
                Main
            
        </a>
        &nbsp;|&nbsp;
        <a href="/apacheds/">
            
                <strong>ApacheDS</strong>
            
        </a>
        &nbsp;|&nbsp;
        <a href="/studio/">
             
                Studio
            
        </a>
        &nbsp;|&nbsp;
        <a href="/api/">
             
                LDAP API
            
        </a>
        &nbsp;|&nbsp;
        <a href="/mavibot/">
             
                Mavibot
            
        </a>
        &nbsp;|&nbsp;
        <a href="/scimple/">
             
                SCIMple
            
        </a>
        &nbsp;|&nbsp;
        <a href="/fortress/">
             
                Fortress
            
        </a>
        &nbsp;|&nbsp;
        <a href="/kerby/">
             
                Kerby
            
        </a>
    </div>
</div>


    <div id="content">
        <div id="leftColumn">
            <div id="navigation">
                
                <a class="acevent" data-format="wide" data-width="170"></a>
                <h5>ApacheDS 2.0</h5>
                <ul>
                    <li><a href="/apacheds/">Home</a></li>
                    <li><a href="/apacheds/news.html">News</a></li>
                    <li><a href="/apacheds/features.html">Features</a></li>
                    <li><a href="/apacheds/production-readiness.html">Production Readiness</a></li>
                </ul>

                <h5>Downloads</h5>
                <ul>
                    <li><a href="/apacheds/downloads.html">ApacheDS 2.0.0.AM26</a>&nbsp;&nbsp;<img src="/images/new_badge.gif" alt="" style="margin-bottom:-3px;" border="0"></li>
                    <li><a href="/apacheds/download-old-versions.html">Older versions</a></li>
                </ul>

                <h5>Documentation</h5>
                <ul>
                    <li><a href="/apacheds/basic-user-guide.html">Basic User Guide </a></li>
                    <li><a href="/apacheds/advanced-user-guide.html">Advanced User Guide</a></li>
                    <li><a href="/apacheds/developer-guide.html">Developer Guide</a></li>
                    <li><a href="/apacheds/kerberos-user-guide.html">Kerberos User Guide</a></li>
                    <li><a href="/apacheds/configuration/ads-2.0-configuration.html">Configuration</a></li>
                    <li><a href="/apacheds/gen-docs/latest/apidocs">JavaDocs</a></li>
                    <li><a href="/apacheds/gen-docs/latest/xref">Cross-Reference</a></li>
                </ul>

                <h5>Support</h5>
<ul>
    <li><a href="/mailing-lists-and-irc.html">Mailing Lists &amp; IRC</a></li>
    <li><a href="/sources.html">Sources</a></li>
    <li><a href="/issue-tracking.html">Issue Tracking</a></li>
    <li><a href="/commercial-support.html">Commercial Support</a></li>
</ul>

<h5>Community</h5>
<ul>
    <li><a href="/contribute.html">How to Contribute</a></li>
    <li><a href="/team.html">Team</a></li>
    <li><a href="/original-project-proposal.html">Original Project Proposal</a></li>
    <li><a href="/special-thanks.html" class="external-link" rel="nofollow">Special Thanks</a></li>
</ul>

<h5>About Apache</h5>
<ul>
    <li><a href="https://www.apache.org/">Apache</a></li>
    <li><a href="https://www.apache.org/licenses/">License</a></li>
    <li><a href="https://www.apache.org/foundation/sponsorship.html">Sponsorship</a></li>
    <li><a href="https://www.apache.org/foundation/thanks.html">Thanks</a></li>
    <li><a href="https://www.apache.org/security/">Security</a></li>
</ul>

            </div>
        </div>
        <div id="rightColumn">
            
    <div class="nav">
        <div class="nav_prev">
            
                
                <a href="3.2-basic-authorization.html">3.2 - Basic authorization</a>
            
        </div>
        <div class="nav_up">
            
                
                <a href="3-basic-security.html">3 - Basic Security</a>
            
        </div>
        <div class="nav_next">
            
                
                <a href="4-integrating-apacheds.html">4 - Integrating ApacheDS with other programs</a>
            
        </div>
        <div class="clearfix"></div>
    </div>


            
	<h1 id="33---how-to-enable-ssl">3.3 - How to enable SSL</h1>
<p>This section describes the transport layer security options for LDAP, and especially how to enable LDAPS on ApacheDS.</p>
<nav id="TableOfContents">
  <ul>
    <li><a href="#transport-layer-security-and-ldap">Transport layer security and LDAP</a></li>
    <li><a href="#server-configuration">Server configuration</a>
      <ul>
        <li><a href="#in-case-you-want-ads-to-generate-the-certificate">In case you want ADS to generate the certificate</a></li>
        <li><a href="#in-case-you-want-to-use-an-external-keystore">In case you want to use an external keystore</a></li>
      </ul>
    </li>
    <li><a href="#verification-clients">Verification, Clients</a>
      <ul>
        <li><a href="#using-apache-directory-studio-to-connect">Using Apache Directory Studio to connect</a></li>
        <li><a href="#other-clients-java-programs-using-jndi">Other clients, Java programs using JNDI</a></li>
      </ul>
    </li>
    <li><a href="#resources">Resources</a></li>
  </ul>
</nav>
<h2 id="transport-layer-security-and-ldap">Transport layer security and LDAP</h2>
<p>Several requirements related to security can be easily accomplished with the help of <em>SSL</em> technology (Secure Socket Layer) or its standardized successor <em>TLS</em> (Transport Layer Security, RFC 2246). Among these are the protection of data against eavesdropping and modification, when on transit between client and server (data integrity), and the authentication of a server toward a client with the help of a certificate.</p>
<p>There are two approaches to utilize these technologies in the LDAP world.</p>
<ul>
<li>ldaps (LDAP over SSL/TLS, generally on port 636)</li>
<li>StartTLS (extended operation)</li>
</ul>
<p>The first option is comparable to HTTPS and inserts an SSL/TLS layer between the TCP/IP protocol and LDAP. Establishing a connection like this is normally provided via a different server port (port 636 is common, it is a well-known port, like port 389 is for LDAP). In URIs the schema &ldquo;ldaps&rdquo; is specified  (for instance <em>ldaps://zanzibar:636/</em>) instead of &ldquo;ldap&rdquo;. It is possible to write programs which switch between ldap and ldaps without changes in the source, if the connection data is configured external.</p>
<p>In the second option a client establishes at first a &ldquo;normal&rdquo; LDAP connection. With a special request (extended operation StartTLS) it tries to switch to secure communication afterwards. It is not necessary to change the port for this, the communication continues on the established connection. The client may go back to the original connection state (&ldquo;TLS Closure Alert&rdquo;), in doing so protecting only selected parts of the communication.</p>
<p>Both ways to utilize SSL/TLS within LDAP require the configuration of the server with an appropriate certificate.</p>
<DIV class="warning" markdown="1">
**LDAPS** is considered as deprecated. You should always favor startTLS instead.
</DIV>
<h2 id="server-configuration">Server configuration</h2>
<p>ApacheDS 2.0 supports both options and requires a JDK 1.5 or above. The feature is enabled by default, but you may need to configure it. There are some steps to follow in order to obtain a SSL enabled server.</p>
<DIV class="note" markdown="1">
In order to keep it simple for beginners, you don't need any certificate to get LDAPS working. The latest version generates its own self signed certificate. From the user point of view, it's just a matter of enabling the ldaps service to get it working.
<p>However, if one wants to use a signed certificate, another configuration is needed, where you tell the server about the keystore to use, and the certificate password to use.</p>
</DIV>
<h3 id="in-case-you-want-ads-to-generate-the-certificate">In case you want ADS to generate the certificate</h3>
<p>There is nothing to do but enabling SSL and specifying the port to use in the server configuration file :</p>
<p><img src="images/studio-apacheds-configuration-ldaps.png" alt="LDAPS configuration"></p>
<p>As soon as the &ldquo;Enable LDAPS server&rdquo; checkbox is checked, your server is LDAPS capable !</p>
<h3 id="in-case-you-want-to-use-an-external-keystore">In case you want to use an external keystore</h3>
<p>A certificate is a signed public key (signed normally by a third party, a certificate authority, CA).</p>
<p>There are different options</p>
<ul>
<li>either you buy a certificate from a Certificate Authority (like Verisign, etc.), or you obtain one from your enterprise CA, if available</li>
<li>or you ask for a free certificate from <a href="http://www.cacert.org/">CACERT organisation</a></li>
<li>or you create your own certificate, self-signed or signed by your private CA, which will not be trusted.</li>
</ul>
<p>We will do it the last way (self-signed), primarily because it&rsquo;s easy and fast (you won&rsquo;t have to pay nor to wait to obtain your certificate)</p>
<h4 id="key-creation">Key creation</h4>
<p>First it is necessary to create a key pair (public/private key) for your server, <em>zanzibar</em> in our case.  One option is to use the JDK tool <em>keytool</em> for this task. In the following example, we use these options</p>
<table>
<thead>
<tr>
<th align="center">Command Option</th>
<th align="center">Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">-genkey</td>
<td align="center">-</td>
<td>Command to generate a key pair</td>
</tr>
<tr>
<td align="center">-keyalg</td>
<td align="center">&ldquo;RSA&rdquo;</td>
<td>Algorithm to be used to generate the key pair,  in our case, default is &ldquo;DSA&rdquo;</td>
</tr>
<tr>
<td align="center">-dname</td>
<td align="center">&ldquo;cn=zanzibar, ou=ApacheDS, o=ASF, c=US&rdquo;</td>
<td>The X.500 Distinguished Name to be associated with alias, used as the issuer and subject fields in the self-signed certificate</td>
</tr>
<tr>
<td align="center">-alias</td>
<td align="center">zanzibar</td>
<td>Name to refer the entry within the keystore</td>
</tr>
<tr>
<td align="center">-keystore</td>
<td align="center">zanzibar.ks</td>
<td>Keystore file location</td>
</tr>
<tr>
<td align="center">-storepass</td>
<td align="center">secret</td>
<td>Password used to protect the integrity of the keystore</td>
</tr>
<tr>
<td align="center">-validity</td>
<td align="center">730</td>
<td>Number of days for which the certificate should be considered valid, default is 90</td>
</tr>
</tbody>
</table>
<p>Learn more about keytool at the <a href="https://java.sun.com/j2se/1.5.0/docs/tooldocs/solaris/keytool.html">manpage</a>.</p>
<pre><code>$ keytool -genkey -keyalg &quot;RSA&quot; -dname &quot;cn=zanzibar, ou=ApacheDS, o=ASF, c=US&quot; \\
    -alias zanzibar -keystore zanzibar.ks -storepass secret -validity 730
Enter key password for &lt;zanzibar&gt;
    (RETURN if same as keystore password):
$ ls -l
total 4
-rw-r--r--   1 stefan   users       1275 Jun 10 20:42 zanzibar.ks
$ keytool -list -keystore zanzibar.ks
Enter keystore password:  secret

Keystore type: jks
Keystore provider: SUN

Your keystore contains 1 entry

zanzibar, Jun 10, 2007, keyEntry,
Certificate fingerprint (MD5): 95:4A:90:3D:69:09:64:84:C7:21:FD:F7:B8:82:11:8C
$
</code></pre>
<p>Another option is to use graphical tools for key creation like <a href="https://portecle.sourceforge.net/">Portecle</a>, which is basically a user-friendly front-end for keytool with comparable functionality. For a first impression see a screen shot below.</p>
<p><img src="images/portecle-with-keystore.png" alt="Portecle Keystore"></p>
<h4 id="configuring-apacheds-to-use-this-external-keystore">Configuring ApacheDS to use this external keystore</h4>
<p>Enabling SSL in Apache Directory Server and using the key pair created as above is quite easy. Simply put the keystore file in the <em>conf</em> directory of ApacheDS, and enable ldaps. Then you just have to setup the configuration using <em>Apache Directory Studio</em>, feeling the required input boxes, as shown on the following picture :</p>
<p><img src="images/keystore-configuration.png" alt="Keystore Configuration"></p>
<p>The following properties were used :</p>
<table>
<thead>
<tr>
<th align="center">Property</th>
<th align="center">Default Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">keystoreFile</td>
<td align="center">none</td>
<td>Path of the X509 (or JKS) certificate file for LDAPS</td>
</tr>
<tr>
<td align="center">certificatePassword</td>
<td align="center">changeit</td>
<td>Password which is used to load the LDAPS certificate file</td>
</tr>
<tr>
<td align="center">port</td>
<td align="center">10636</td>
<td>LDAPS TCP/IP port number to listen to</td>
</tr>
<tr>
<td align="center">enableSSL</td>
<td align="center">true</td>
<td>Sets if SSL is enabled or not</td>
</tr>
</tbody>
</table>
<p>After modification of the configuration, the server has to be restarted in order to take effect.</p>
<h2 id="verification-clients">Verification, Clients</h2>
<p>After restarting the server, you should have a server offering both ldap and ldaps. How to verify whether it works?</p>
<h3 id="using-apache-directory-studio-to-connect">Using Apache Directory Studio to connect</h3>
<p>Apache Directory Studio happily supports ldaps connections. Enter the connection data (hostname and port) and select &ldquo;Use SSL encryption&rdquo; from the dropdown, if you create or modify a connection:</p>
<p><img src="images/studio-ssl.png" alt="Studio SSL"></p>
<p>Afterwards the connection behaves like LDAP does. No difference in functionality, but the transmission is secured by SSL.</p>
<p>Because our self-signed certificate is not trustworthy, many tools will present a warning (as Studio). You will likely be able to view the certificate, and decide to continue (accepting the certificate always or this session only), like with web browsers.</p>
<h3 id="other-clients-java-programs-using-jndi">Other clients, Java programs using JNDI</h3>
<p>If you use other graphical clients, the behavior will be comparable. Sometimes clients don&rsquo;t allow to connect to a server, if the certificate is not trustworthy. This is for instance the case for Java clients using JNDI.</p>
<p>The following simple Java program tries to connect via JNDI/JSSE (Java Secure Socket Extension) and LDAPS to <em>ldaps://zanzibar:10636</em></p>
<pre><code>import java.util.Hashtable;
import javax.naming.*;
import javax.naming.directory.*;

public class ConnectWithLdaps {
	
    public static void main(String[] args) throws NamingException {
		
        Hashtable env = new Hashtable();
		
        // Simple bind
        env.put(Context.SECURITY_AUTHENTICATION, &quot;simple&quot;);
        env.put(Context.SECURITY_PRINCIPAL,
                &quot;cn=Horatio Hornblower,ou=people,o=sevenSeas&quot;);
        env.put(Context.SECURITY_CREDENTIALS, &quot;pass&quot;);
		
        env.put(Context.INITIAL_CONTEXT_FACTORY,
            &quot;com.sun.jndi.ldap.LdapCtxFactory&quot;);
        env.put(Context.PROVIDER_URL, &quot;ldaps://zanzibar:636/o=sevenSeas&quot;);
		
        DirContext ctx = new InitialDirContext(env);
        NamingEnumeration enm = ctx.list(&quot;&quot;);
		
        while (enm.hasMore()) {
            System.out.println(enm.next());
        }
		
        enm.close();
        ctx.close();
    }
}
</code></pre>
<p>It causes a <em>CommunicationException</em>, if the certificate is not trusted:</p>
<pre><code>$ java ConnectWithLdaps
Exception in thread &quot;main&quot; javax.naming.CommunicationException: 
  simple bind failed: zanzibar:636 
    [Root exception is javax.net.ssl.SSLHandshakeException: 
       sun.security.validator.ValidatorException: PKIX path building failed:    
       sun.security.provider.certpath.SunCertPathBuilderException: 
       unable to find valid certification path to requested target]
       at com.sun.jndi.ldap.LdapClient.authenticate(Unknown Source)
       ...
</code></pre>
<p>In order to make the client trust our server, one option is to share a self signed certificate.
So we export the certificate (DER format) using keytool like this:</p>
<pre><code>$ keytool -export -keystore zanzibar.ks -alias zanzibar -file zanzibar.cer
Enter keystore password:  secret
Certificate stored in file &lt;zanzibar.cer&gt;
$ ls -l
total 6
-rw-r--r--   1 stefan   users        504 Jun 10 21:51 zanzibar.cer
-rw-r--r--   1 stefan   users       1275 Jun 10 20:42 zanzibar.ks
$ 
</code></pre>
<p>Please note that you don&rsquo;t want to share the server keystore file itself with arbitrary clients, because it holds the private key. Instead we create a separate keystore <em>trusted.ks</em> with the help of <em>keytool</em>. We import the certificate <em>zanzibar.cer</em> like this:</p>
<pre><code>$ keytool -import -file zanzibar.cer -alias zanzibar -keystore trusted.ks -storepass secret
Owner: CN=zanzibar, OU=ApacheDS, O=ASF, C=US
Issuer: CN=zanzibar, OU=ApacheDS, O=ASF, C=US
Serial number: 466c4611
Valid from: Sun Jun 10 20:42:25 CEST 2007 until: Tue Jun 09 20:42:25 CEST 2009
Certificate fingerprints:
     MD5:  95:4A:90:3D:69:09:64:84:C7:21:FD:F7:B8:82:11:8C
     SHA1: C5:63:E0:DA:BB:C8:0E:E8:27:D0:91:1D:28:DD:11:BB:93:21:13:C9
Trust this certificate? [no]:  yes
Certificate was added to keystore
$ keytool -list -keystore trusted.ks -storepass secret                
Keystore type: jks
Keystore provider: SUN

Your keystore contains 1 entry

zanzibar, Jun 11, 2007, trustedCertEntry,
Certificate fingerprint (MD5): 95:4A:90:3D:69:09:64:84:C7:21:FD:F7:B8:82:11:8C
$
</code></pre>
<p>Instead of using the command line version of keytool, it is also possible to perform the certificate export and import operations with Portecle or any other graphical frontend. This is for instance how the <em>trusted.ks</em> files with the imported certificate looks like in Portecle.</p>
<p><img src="images/portecle-with-certificate.png" alt="Portecle with certificate"></p>
<p>Clients may use this keystore in order to connect to the server. Therefore they can configure <em>trusted.ks</em> as the trusted store via the environment like this:</p>
<pre><code>$ java -Djavax.net.ssl.trustStore=trusted.ks ConnectWithLdaps
ou=people: javax.naming.directory.DirContext
ou=groups: javax.naming.directory.DirContext 
</code></pre>
<p>Another option would be to import the certificate in the default keystore of the JRE installation (within $JAVA_HOME/jre/lib/security). For a test certificate this proceeding is not appropriate.</p>
<h4 id="troubleshooting">Troubleshooting</h4>
<p>In practice connection establishment with LDAP over SSL may lead to various problems. In order to eliminate the errors it is helpful to see communication-specific debug information. The system property <em>javax.net.debug</em> is available for this task. The value &ldquo;ssl&rdquo; provides information about the certificates in the used key store, the server certificate, and the steps during establishing of the SSL connection (handshake):</p>
<pre><code>$ java -Djavax.net.ssl.trustStore=trusted.ks -Djavax.net.debug=ssl ConnectWithLdaps
setting up default SSLSocketFactory
use default SunJSSE impl class: com.sun.net.ssl.internal.ssl.SSLSocketFactoryImpl
class com.sun.net.ssl.internal.ssl.SSLSocketFactoryImpl is loaded
keyStore is : 
keyStore type is : jks
keyStore provider is : 
init keystore
init keymanager of type SunX509
trustStore is: trusted.ks
trustStore type is : jks
trustStore provider is : 
init truststore
adding as trusted cert:
  Subject: CN=zanzibar, OU=ApacheDS, O=ASF, C=US
  Issuer:  CN=zanzibar, OU=ApacheDS, O=ASF, C=US
  Algorithm: RSA; Serial number: 0x466c4611
  Valid from Sun Jun 10 20:42:25 CEST 2007 until Tue Jun 09 20:42:25 CEST 2009
  
init context
trigger seeding of SecureRandom
done seeding SecureRandom
instantiated an instance of class com.sun.net.ssl.internal.ssl.SSLSocketFactoryImpl
%% No cached client session
*** ClientHello, TLSv1
...
</code></pre>
<p>You should be able to determine any SSL-related configuration problem with the help of this log.</p>
<h2 id="resources">Resources</h2>
<ul>
<li><a href="https://java.sun.com/products/jsse/">Java Secure Socket Extension (JSSE)</a></li>
<li><a href="https://portecle.sourceforge.net">Portecle</a> a free UI application for creating, managing and examining keystores</li>
<li><a href="http://wp.netscape.com/eng/ssl3/">SSL 3.0 Specification (Netscape)</a></li>
</ul>


            
    <div class="nav">
        <div class="nav_prev">
            
                
                <a href="3.2-basic-authorization.html">3.2 - Basic authorization</a>
            
        </div>
        <div class="nav_up">
            
                
                <a href="3-basic-security.html">3 - Basic Security</a>
            
        </div>
        <div class="nav_next">
            
                
                <a href="4-integrating-apacheds.html">4 - Integrating ApacheDS with other programs</a>
            
        </div>
        <div class="clearfix"></div>
    </div>


        </div>
        <div id="endContent"></div>
    </div>

    <div id="footer">
    &copy; 2003-2023, <a href="https://www.apache.org">The Apache Software Foundation</a> - <a href="https://privacy.apache.org/policies/privacy-policy-public.html">Privacy Policy</a><br />
    Apache Directory, ApacheDS, Apache Directory Server, Apache Directory Studio, Apache LDAP API, Apache Triplesec,
    Triplesec, Apache Mavibot, Mavibot, Apache eSCIMo, eSCIMo, Apache SCIMple, SCIMple,Fortress, Apache Fortress, EnMasse,
    Apache EnMasse, Apache Kerby, Kerby, Apache, the Apache feather logo, and the Apache Directory project logos are
    trademarks of The Apache Software Foundation.
</div>

</div>

</body>

</html>
