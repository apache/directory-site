<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="utf-8">
    <title>2.3 - Searching &mdash; Apache Directory</title>

    <link href="/css/common.css" rel="stylesheet" type="text/css"/>
    <link href="/css/brown.css" rel="stylesheet" type="text/css"/>

    <link rel="shortcut icon" href="/images/server-icon_16x16.png" />
</head>

<body>
<div id="container">
    <div id="header">
    <div id="subProjectsNavBar">
        <a href="/">
             
                Main
            
        </a>
        &nbsp;|&nbsp;
        <a href="/apacheds/">
             
                ApacheDS
            
        </a>
        &nbsp;|&nbsp;
        <a href="/studio/">
             
                Studio
            
        </a>
        &nbsp;|&nbsp;
        <a href="/api/">
            
                <strong>LDAP API</strong>
            
        </a>
        &nbsp;|&nbsp;
        <a href="/mavibot/">
             
                Mavibot
            
        </a>
        &nbsp;|&nbsp;
        <a href="/scimple/">
             
                SCIMple
            
        </a>
        &nbsp;|&nbsp;
        <a href="/fortress/">
             
                Fortress
            
        </a>
        &nbsp;|&nbsp;
        <a href="/kerby/">
             
                Kerby
            
        </a>
    </div>
</div>


    <div id="content">
        <div id="leftColumn">
            <div id="navigation">
                
                <h5>LDAP API </h5>
                <ul>
                    <li><a href="/api/">Home</a></li>
                    <li><a href="/api/news.html">News</a></li>
                </ul>

                <h5>Downloads</h5>
                <ul>
                    <li><a href="/api/downloads-2.html">Version 2.1.1</a>&nbsp;&nbsp;<img src="/images/new_badge.gif" alt="" style="margin-bottom:-3px;" border="0"></li>
                    <li><a href="/api/downloads-1.html">Version 1.0.3</a>&nbsp;&nbsp;</li>
                    <li><a href="/api/download-old-versions.html">Older versions</a></li>
                </ul>

                <h5>Getting Started</h5>
                <ul>
                    <li><a href="/api/vision.html">Vision</a></li>
                    <li><a href="/api/java-api.html">Java API</a></li>
                </ul>

                <h5>Documentation</h5>
                <ul>
                    <li><a href="/api/five-minutes-tutorial.html">Five minute tutorial</a></li>
                    <li><a href="/api/user-guide.html">User Guide</a></li>
                    <li><a href="/api/migration-guide.html">API 1 to 2 migration</a></li>
                    <li><a href="/api/gen-docs/latest2/apidocs/">JavaDocs 2</a></li>
                    <li><a href="/api/gen-docs/latest/apidocs/">JavaDocs</a></li>
                    <li><a href="/api/gen-docs/latest2/xref/">Cross-Reference 2</a></li>
                    <li><a href="/api/gen-docs/latest/xref/">Cross-Reference</a></li>
                    
                    <li><a href="/api/developer-guide.html">Developer Guide</a></li>
                    <li><a href="/api/internal-design-guide.html">Internal Guide</a></li>
                </ul>

                <h5>Support</h5>
<ul>
    <li><a href="/mailing-lists-and-irc.html">Mailing Lists &amp; IRC</a></li>
    <li><a href="/sources.html">Sources</a></li>
    <li><a href="/issue-tracking.html">Issue Tracking</a></li>
    <li><a href="/commercial-support.html">Commercial Support</a></li>
</ul>

<h5>Community</h5>
<ul>
    <li><a href="/contribute.html">How to Contribute</a></li>
    <li><a href="/team.html">Team</a></li>
    <li><a href="/original-project-proposal.html">Original Project Proposal</a></li>
    <li><a href="/special-thanks.html" class="external-link" rel="nofollow">Special Thanks</a></li>
</ul>

<h5>About Apache</h5>
<ul>
    <li><a href="http://www.apache.org/">Apache</a></li>
    <li><a href="http://www.apache.org/licenses/">License</a></li>
    <li><a href="http://www.apache.org/foundation/sponsorship.html">Sponsorship</a></li>
    <li><a href="http://www.apache.org/foundation/thanks.html">Thanks</a></li>
    <li><a href="http://www.apache.org/security/">Security</a></li>
</ul>

            </div>
        </div>
        <div id="rightColumn">
            
    <div class="nav">
        <div class="nav_prev">
            
                
                <a href="2.2-binding-unbinding.html">2.2 - Binding and unbinding</a>
            
        </div>
        <div class="nav_up">
            
                
                <a href="2-basic-ldap-api-usage.html">2 - Basic LDAP API usage</a>
            
        </div>
        <div class="nav_next">
            
                
                <a href="2.4-adding.html">2.4 - Adding entries</a>
            
        </div>
        <div class="clearfix"></div>
    </div>


            
	<h1 id="23---searching-">2.3 - Searching (&hellip;)</h1>
<p>Searching is the most important operation in <strong>LDAP</strong>. It has to be fast, very fast. On the other hand, as the server does the processing while looking for entries, the client must provide information to get accurate results.</p>
<p>The idea is to define a search <strong>API</strong> which is easy to use in the simplest cases, but provides all the capability to send complex search requests.</p>
<h2 id="simple-search">Simple search</h2>
<p>Let&rsquo;s first look at a simple search. To process a search we need a starting point in the tree, a filter, and a scope. Here&rsquo;s an example:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#a2f">@Test</span>
    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">testSearch</span><span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#a2f;font-weight:bold">throws</span> Exception
    <span style="color:#666">{</span>
        EntryCursor cursor <span style="color:#666">=</span> connection<span style="color:#666">.</span><span style="color:#b44">search</span><span style="color:#666">(</span> <span style="color:#b44">&#34;ou=system&#34;</span><span style="color:#666">,</span> <span style="color:#b44">&#34;(objectclass=*)&#34;</span><span style="color:#666">,</span> SearchScope<span style="color:#666">.</span><span style="color:#b44">ONELEVEL</span> <span style="color:#666">)</span><span style="color:#666">;</span>

        <span style="color:#a2f;font-weight:bold">try</span>
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">for</span> <span style="color:#666">(</span> Entry entry <span style="color:#666">:</span> cursor <span style="color:#666">)</span>
            <span style="color:#666">{</span>
                assertNotNull<span style="color:#666">(</span> entry <span style="color:#666">)</span><span style="color:#666">;</span>
                System<span style="color:#666">.</span><span style="color:#b44">out</span><span style="color:#666">.</span><span style="color:#b44">println</span><span style="color:#666">(</span> entry <span style="color:#666">)</span><span style="color:#666">;</span>
            <span style="color:#666">}</span>
        <span style="color:#666">}</span>
        <span style="color:#a2f;font-weight:bold">finally</span>
        <span style="color:#666">{</span>
            cursor<span style="color:#666">.</span><span style="color:#b44">close</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>
    <span style="color:#666">}</span>
</code></pre></div><p>In this example, the <em>connection</em> has been previously created. We search for all entries starting at <em>ou=system</em> along with its children, which have an <em>ObjectClass</em> attribute (all the entries have such an attribute, so we should get back all the entries). The scope (<em>ONELEVEL</em>) searches one level under the starting base.</p>
<p>A cursor of entries is returned, which can be iterated over. Every call to the <em>getEntry()</em> method returns the next entry in the LDAP result set.</p>
<p>That&rsquo;s pretty much it!</p>
<p>But this is not really enough, there are many possible options.</p>
<blockquote>
<p><strong>Note</strong> Don&rsquo;t forget to close the cursor, otherwise the associated data remains in memory forever (causing a memory leak)! Best practice is to use try-with-resources statement, like in this better example of code:</p>
</blockquote>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#a2f">@Test</span>
    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">testSearch</span><span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#a2f;font-weight:bold">throws</span> Exception
    <span style="color:#666">{</span>
        <span style="color:#a2f;font-weight:bold">try</span> <span style="color:#666">(</span> EntryCursor cursor <span style="color:#666">=</span> connection<span style="color:#666">.</span><span style="color:#b44">search</span><span style="color:#666">(</span> <span style="color:#b44">&#34;ou=system&#34;</span><span style="color:#666">,</span> <span style="color:#b44">&#34;(objectclass=*)&#34;</span><span style="color:#666">,</span> SearchScope<span style="color:#666">.</span><span style="color:#b44">ONELEVEL</span> <span style="color:#666">)</span> <span style="color:#666">)</span>
        <span style="color:#666">{</span>

            <span style="color:#a2f;font-weight:bold">for</span> <span style="color:#666">(</span> Entry entry <span style="color:#666">:</span> cursor <span style="color:#666">)</span>
            <span style="color:#666">{</span>
                assertNotNull<span style="color:#666">(</span> entry <span style="color:#666">)</span><span style="color:#666">;</span>
                System<span style="color:#666">.</span><span style="color:#b44">out</span><span style="color:#666">.</span><span style="color:#b44">println</span><span style="color:#666">(</span> entry <span style="color:#666">)</span><span style="color:#666">;</span>
            <span style="color:#666">}</span>
        <span style="color:#666">}</span>
    <span style="color:#666">}</span>
</code></pre></div><h3 id="searching-using-a-dn">Searching using a DN</h3>
<p>In the previous sample, we used a String to define the starting point of the search. Sometimes it&rsquo;s convenient to start a search with a DN (i.e. because you got the DN from another operation). In this case, no need to transform the DN into a String before doing your search, simply use the DN!</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#a2f">@Test</span>
    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">testSearchWithDn</span><span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#a2f;font-weight:bold">throws</span> Exception
    <span style="color:#666">{</span>
        Dn systemDn <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">new</span> Dn<span style="color:#666">(</span> <span style="color:#b44">&#34;ou=system&#34;</span> <span style="color:#666">)</span><span style="color:#666">;</span>

        <span style="color:#a2f;font-weight:bold">try</span> <span style="color:#666">(</span> EntryCursor cursor <span style="color:#666">=</span> connection<span style="color:#666">.</span><span style="color:#b44">search</span><span style="color:#666">(</span> systemDn<span style="color:#666">,</span> <span style="color:#b44">&#34;(objectclass=*)&#34;</span><span style="color:#666">,</span> SearchScope<span style="color:#666">.</span><span style="color:#b44">ONELEVEL</span> <span style="color:#666">)</span> <span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">for</span> <span style="color:#666">(</span> Entry entry <span style="color:#666">:</span> cursor <span style="color:#666">)</span>
            <span style="color:#666">{</span>
                assertNotNull<span style="color:#666">(</span> entry <span style="color:#666">)</span><span style="color:#666">;</span>
                System<span style="color:#666">.</span><span style="color:#b44">out</span><span style="color:#666">.</span><span style="color:#b44">println</span><span style="color:#666">(</span> entry <span style="color:#666">)</span><span style="color:#666">;</span>
            <span style="color:#666">}</span>
        <span style="color:#666">}</span>
    <span style="color:#666">}</span>
</code></pre></div><p>This is it!</p>
<h3 id="scope">Scope</h3>
<p>There are three different different scopes you can use to search for data:</p>
<ul>
<li>SearchScope.OBJECT : return the entry for a given DN, if it exists. Note that you could use <code>LdapConnection.lookup</code> if the filter is irrelevent.</li>
<li>SearchScope.ONELEVEL : return all elements below the current DN, but not the element associated with the DN.</li>
<li>SearchScope.SUBLEVEL : return all the elements starting from the given DN, including the element associated with the DN, whatever the depth of the tree.</li>
</ul>
<h3 id="filter">Filter</h3>
<p>The filter is used to define the elements that are targeted. There are various possibilities to construct a filter, using one or more connectors, and one or more expression nodes.</p>
<p>Connectors use a prefix notation, followed by as many expression nodes as necessary, like in (&amp; (node1) (node2) &hellip; (nodeN))</p>
<p>Expression nodes are always contained within parenthesis, with a left part - the attributeType, and a right part - the value -.</p>
<p>Here is the list of possible connectors:</p>
<ul>
<li>&amp; : n-ary AND connector, all the nodes must evaluate to TRUE</li>
<li>| : n-ary OR connector, at least one of the node must evaluate to true</li>
<li>! : 1-ary NOT connector, the node must evaluate to false</li>
</ul>
<p>And here is the list of possible expression nodes, assuming that an expression node:</p>
<ul>
<li><code>=</code> Equality expression node : the selected entry matches the right part</li>
<li><code>=*</code> Presence expression node : the entry has the Attribute on the left side</li>
<li><code>&gt;=</code> Superior expression node : the entry should be superior to the right part</li>
<li><code>&lt;=</code> Inferior expression node : the entry should be superior to the right part</li>
<li><code>=[start][*][middle][*][final]</code> Substring expression node : the entry should match a substring</li>
</ul>
<blockquote>
<p><strong>Note:</strong>  As of Apache DS 2.0, we don&rsquo;t support approx matches nor extensible matches.</p>
</blockquote>
<h2 id="more-complex-searches">More complex searches</h2>
<p>Sometimes, you want to have more control over the search operation, either with the parameters in use, or the results that are returned.</p>
<p>A search can return other things than entries. In fact, you can get four different kinds of responses:</p>
<ul>
<li>When it&rsquo;s a normal entry, you will receive a SearchResultEntry</li>
<li>When it&rsquo;s done, you will receive a SearchResultDone</li>
<li>When the response is a reference to another entry, you will get a SearchResultReference</li>
<li>In some cases, you may also receive an IntermediateResponse.</li>
</ul>
<p>You may also add a Control to the search request, or request some specific AttributeType to be returned. The parameters that may be injected into a SearchRequest are as follows:</p>
<ul>
<li>The base DN</li>
<li>The filter</li>
<li>The scope (one of OBJECT, ONELEVEL or SUBTREE)</li>
<li>The size limit</li>
<li>The time limit</li>
<li>The list of attributes to return</li>
<li>The alias dereferencing mode (one of DEREF_ALWAYS, DEREF_FINDING_BASE_OBJ, DEREF_IN_SEARCHING or NEVER_DEREF_ALIASES)</li>
<li>The TypesOnly flag (to get the AttributeTypes but no values)</li>
<li>The controls</li>
</ul>
<p>In both cases, you should fill the <em>SearchRequest</em> message and send it to the server:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java">    <span style="color:#a2f">@Test</span>
    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">testSearchWithSearchRequest</span><span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#a2f;font-weight:bold">throws</span> Exception
    <span style="color:#666">{</span>
        <span style="color:#080;font-style:italic">// Create the SearchRequest object
</span><span style="color:#080;font-style:italic"></span>        SearchRequest req <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">new</span> SearchRequestImpl<span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">;</span>
        req<span style="color:#666">.</span><span style="color:#b44">setScope</span><span style="color:#666">(</span> SearchScope<span style="color:#666">.</span><span style="color:#b44">SUBTREE</span> <span style="color:#666">)</span><span style="color:#666">;</span>
        req<span style="color:#666">.</span><span style="color:#b44">addAttributes</span><span style="color:#666">(</span> <span style="color:#b44">&#34;*&#34;</span> <span style="color:#666">)</span><span style="color:#666">;</span>
        req<span style="color:#666">.</span><span style="color:#b44">setTimeLimit</span><span style="color:#666">(</span> 0 <span style="color:#666">)</span><span style="color:#666">;</span>
        req<span style="color:#666">.</span><span style="color:#b44">setBase</span><span style="color:#666">(</span> <span style="color:#a2f;font-weight:bold">new</span> Dn<span style="color:#666">(</span> <span style="color:#b44">&#34;ou=system&#34;</span> <span style="color:#666">)</span> <span style="color:#666">)</span><span style="color:#666">;</span>
        req<span style="color:#666">.</span><span style="color:#b44">setFilter</span><span style="color:#666">(</span> <span style="color:#b44">&#34;(cn=user1)&#34;</span> <span style="color:#666">)</span><span style="color:#666">;</span>

        <span style="color:#080;font-style:italic">// Process the request
</span><span style="color:#080;font-style:italic"></span>        <span style="color:#a2f;font-weight:bold">try</span> <span style="color:#666">(</span> SearchCursor searchCursor <span style="color:#666">=</span> connection<span style="color:#666">.</span><span style="color:#b44">search</span><span style="color:#666">(</span> req <span style="color:#666">)</span> <span style="color:#666">)</span> 
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">while</span> <span style="color:#666">(</span> searchCursor<span style="color:#666">.</span><span style="color:#b44">next</span><span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">)</span>
            <span style="color:#666">{</span>
                Response response <span style="color:#666">=</span> searchCursor<span style="color:#666">.</span><span style="color:#b44">get</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">;</span>

                <span style="color:#080;font-style:italic">// process the SearchResultEntry
</span><span style="color:#080;font-style:italic"></span>                <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span> response <span style="color:#a2f;font-weight:bold">instanceof</span> SearchResultEntry <span style="color:#666">)</span>
                <span style="color:#666">{</span>
                    Entry resultEntry <span style="color:#666">=</span> <span style="color:#666">(</span> <span style="color:#666">(</span> SearchResultEntry <span style="color:#666">)</span> response <span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">getEntry</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">;</span>
                    System<span style="color:#666">.</span><span style="color:#b44">out</span><span style="color:#666">.</span><span style="color:#b44">println</span><span style="color:#666">(</span> resultEntry <span style="color:#666">)</span><span style="color:#666">;</span>
                <span style="color:#666">}</span>
            <span style="color:#666">}</span>
        <span style="color:#666">}</span>
    <span style="color:#666">}</span>
</code></pre></div><p>As we can see, the response is different, we are returned a <em>SearchCursor</em> instance, and we must verify the response type before being able to process it.</p>


            
    <div class="nav">
        <div class="nav_prev">
            
                
                <a href="2.2-binding-unbinding.html">2.2 - Binding and unbinding</a>
            
        </div>
        <div class="nav_up">
            
                
                <a href="2-basic-ldap-api-usage.html">2 - Basic LDAP API usage</a>
            
        </div>
        <div class="nav_next">
            
                
                <a href="2.4-adding.html">2.4 - Adding entries</a>
            
        </div>
        <div class="clearfix"></div>
    </div>


        </div>
        <div id="endContent"></div>
    </div>

    <div id="footer">
    &copy; 2003-2022, <a href="http://www.apache.org">The Apache Software Foundation</a> - <a href="/privacy-policy.html">Privacy Policy</a><br />
    Apache Directory, ApacheDS, Apache Directory Server, Apache Directory Studio, Apache LDAP API, Apache Triplesec,
    Triplesec, Apache Mavibot, Mavibot, Apache eSCIMo, eSCIMo, Apache SCIMple, SCIMple,Fortress, Apache Fortress, EnMasse,
    Apache EnMasse, Apache Kerby, Kerby, Apache, the Apache feather logo, and the Apache Directory project logos are
    trademarks of The Apache Software Foundation.
</div>

</div>

</body>

</html>
