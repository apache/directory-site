<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="utf-8">
    <title>4-1 - ASN/1 TLV &mdash; Apache Directory</title>

    <link href="/css/common.css" rel="stylesheet" type="text/css"/>
    <link href="/css/brown.css" rel="stylesheet" type="text/css"/>

    <link rel="shortcut icon" href="/images/server-icon_16x16.png" />
</head>

<body>
<div id="container">
    <div id="header">
    <div id="subProjectsNavBar">
        <a href="/">
             
                Main
            
        </a>
        &nbsp;|&nbsp;
        <a href="/apacheds/">
             
                ApacheDS
            
        </a>
        &nbsp;|&nbsp;
        <a href="/studio/">
             
                Studio
            
        </a>
        &nbsp;|&nbsp;
        <a href="/api/">
            
                <strong>LDAP API</strong>
            
        </a>
        &nbsp;|&nbsp;
        <a href="/mavibot/">
             
                Mavibot
            
        </a>
        &nbsp;|&nbsp;
        <a href="/scimple/">
             
                SCIMple
            
        </a>
        &nbsp;|&nbsp;
        <a href="/fortress/">
             
                Fortress
            
        </a>
        &nbsp;|&nbsp;
        <a href="/kerby/">
             
                Kerby
            
        </a>
    </div>
</div>


    <div id="content">
        <div id="leftColumn">
            <div id="navigation">
                
                <h5>LDAP API </h5>
                <ul>
                    <li><a href="/api/">Home</a></li>
                    <li><a href="/api/news.html">News</a></li>
                </ul>

                <h5>Downloads</h5>
                <ul>
                    <li><a href="/api/downloads-2.html">Version 2.1.1</a>&nbsp;&nbsp;<img src="/images/new_badge.gif" alt="" style="margin-bottom:-3px;" border="0"></li>
                    <li><a href="/api/downloads-1.html">Version 1.0.3</a>&nbsp;&nbsp;</li>
                    <li><a href="/api/download-old-versions.html">Older versions</a></li>
                </ul>

                <h5>Getting Started</h5>
                <ul>
                    <li><a href="/api/vision.html">Vision</a></li>
                    <li><a href="/api/java-api.html">Java API</a></li>
                </ul>

                <h5>Documentation</h5>
                <ul>
                    <li><a href="/api/five-minutes-tutorial.html">Five minute tutorial</a></li>
                    <li><a href="/api/user-guide.html">User Guide</a></li>
                    <li><a href="/api/migration-guide.html">API 1 to 2 migration</a></li>
                    <li><a href="/api/gen-docs/latest2/apidocs/">JavaDocs 2</a></li>
                    <li><a href="/api/gen-docs/latest/apidocs/">JavaDocs</a></li>
                    <li><a href="/api/gen-docs/latest2/xref/">Cross-Reference 2</a></li>
                    <li><a href="/api/gen-docs/latest/xref/">Cross-Reference</a></li>
                    
                    <li><a href="/api/developer-guide.html">Developer Guide</a></li>
                    <li><a href="/api/internal-design-guide.html">Internal Guide</a></li>
                </ul>

                <h5>Support</h5>
<ul>
    <li><a href="/mailing-lists-and-irc.html">Mailing Lists &amp; IRC</a></li>
    <li><a href="/sources.html">Sources</a></li>
    <li><a href="/issue-tracking.html">Issue Tracking</a></li>
    <li><a href="/commercial-support.html">Commercial Support</a></li>
</ul>

<h5>Community</h5>
<ul>
    <li><a href="/contribute.html">How to Contribute</a></li>
    <li><a href="/team.html">Team</a></li>
    <li><a href="/original-project-proposal.html">Original Project Proposal</a></li>
    <li><a href="/special-thanks.html" class="external-link" rel="nofollow">Special Thanks</a></li>
</ul>

<h5>About Apache</h5>
<ul>
    <li><a href="http://www.apache.org/">Apache</a></li>
    <li><a href="http://www.apache.org/licenses/">License</a></li>
    <li><a href="http://www.apache.org/foundation/sponsorship.html">Sponsorship</a></li>
    <li><a href="http://www.apache.org/foundation/thanks.html">Thanks</a></li>
    <li><a href="http://www.apache.org/security/">Security</a></li>
</ul>

            </div>
        </div>
        <div id="rightColumn">
            
    <div class="nav">
        <div class="nav_prev">
            
                
                <a href="4-asn1.html">4 - ASN/1</a>
            
        </div>
        <div class="nav_up">
            
                
                <a href="../internal-design-guide.html">Internal Design Guide</a>
            
        </div>
        <div class="nav_next">
            
                
                <a href="5-network.html">5 - Network</a>
            
        </div>
        <div class="clearfix"></div>
    </div>


            
	<h1 id="41---asn1-tlv">4.1 - ASN/1 TLV</h1>
<h2 id="what-are-tlvs-">What are TLVs ?</h2>
<p>The acronym <strong>TLV</strong> stands for <strong>T</strong>ag, <strong>L</strong>ength and <strong>V</strong>alue. It&rsquo;s a way to encode a piece of information with a type, a length followed by the information itself. Three points must be known:</p>
<ul>
<li>The <strong>Value</strong> part may contents other <strong>TLV</strong>s. One can see <strong>TLV</strong>s as C structures, that can contain sub-structures.</li>
<li>The <strong>Value</strong> may not exist, and in this case the <strong>Length</strong> will be 0.</li>
<li>The <strong>Length</strong> part may not give the <strong>Value</strong> length: it is called an <em>indefinite Length</em>. In this - not so frequent - case, the <strong>Value</strong> must end with a specific terminator.</li>
</ul>
<h3 id="a-quick-sample">A quick sample</h3>
<p>Let&rsquo;s begin with a simple example, without too many explanations. This is the <strong>PDU</strong> (<strong>P</strong>acket <strong>D</strong>ata <strong>U</strong>nit) of a LDAP <em>BindRequest</em>:</p>
<p><img src="images/TLVs.png" alt="TLV"></p>
<p>We can see in this picture that you have what is called a first level <strong>TLV</strong>. It encapsulates other <strong>TLV</strong>s. It&rsquo;s basically a stream of bytes.</p>
<h3 id="type">Type</h3>
<p>Each <strong>Type</strong> contains information about the <strong>Value</strong> part of the <strong>TLV</strong>. It tells if the <strong>Value</strong> is a primitive or a constructed one, which type of primitive is the value, gives some contextual information. A <strong>Type</strong> can be coded on more than one byte. The first 3 bits give some contextual information about the <strong>Type</strong>, and the 5 following bits are either a label or the beginning of a multi-bytes label.</p>
<ul>
<li>Labels are numbers in [0..30], and they represent a specific <strong>ASN/1</strong> element in the protocol description, like _CompareRequest ::= [APPLICATION 14] _ (here, the label is 14).</li>
<li>If the label is 31, then more than one byte is used to encode the <strong>Type</strong>. In this case, we use the following bytes to compute the label, where each byte which high bit is one will be followed by another byte.</li>
</ul>
<p>We limit the label to 2,097,151 as we encode the <strong>Type</strong> in one Java int :</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Text" data-lang="Text">    b1 xxx[1-1111], b2 1[111-1111], b3 1[111-1111], b4 0[111-1111]
    -&gt;
    [111-1111][111-1111][111-1111] 
    -&gt;
    0001-1111 1111-1111 1111-1111
    -&gt;
    0x1FFFFF
    -&gt; 
    2,097,151
</code></pre></div><p>In <strong>LDAP</strong> or <strong>Kerberos</strong>, no label is higher than 30, so we always use 1 byte <strong>Type</strong>s.</p>
<p>Other interesting information that we need to grab from a <em>Type</em> are stored in the two first bits (bit 7 and 6), and in the third bit (bit 5). The first two bits describe the class, the third tells if the <strong>TLV</strong> is a <strong>primitive</strong> (b5 = 0) or a <strong>constructed</strong> <strong>TLV</strong> (b5 = 1).</p>
<h3 id="length">Length</h3>
<p><strong>Length</strong> gives the number of bytes of the <strong>Value</strong>, and nothing else. So the total length of a <strong>TLV</strong> will be:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Text" data-lang="Text">    TLV length = Tag length + Length length + Value length, 
</code></pre></div><p>where the <strong>Value</strong> length is stored in the <strong>Length</strong> element.</p>
<p>The <strong>Length</strong> may be 0, which means that there is no value following.</p>
<p>How is <strong>Length</strong> encoded? A <strong>Value</strong> may be from 0 to N bytes long, with N &lt; (256 ^ 126) - 1. This limit is purely hypothetic, of course. If we have to deal with huge objects like pictures or movies, their length will not exceed a few MBytes or a few GBytes</p>
<p>Typically, we will find five kind of <strong>Length</strong>s :</p>
<ul>
<li>zero length values;</li>
<li>values with a length less than 128 bytes</li>
<li>values with a length between 128 and 256 ^ 4 bytes long (an int will be able to hold 4 bytes);</li>
<li>values above 256 ^ 4 bytes long</li>
<li>values which length is not defined by the <strong>Length</strong> element.</li>
</ul>
<p>The last type of Length could occurs if the sender does not know the length of the value while it is sending it. <strong>LDAP</strong> protocol does not allow those kind of values, which are dangerous because you need to read the full <strong>Value</strong> to know its length.</p>
<p>The fourth type could also be ignored (4 GBytes is quite a huge size for an LDAP element &hellip;), so we can decide that we won&rsquo;t accept those <strong>Values</strong>. It seems reasonable.</p>
<p>As the <strong>Length</strong> can be stored in more than one byte, we have to take care of fragmented <strong>PDU</strong> : we may receive only the first bytes, and have to wait for the rest to be received. The idea is to freeze and start again when we receive some more data.</p>
<p>In any case, if the first byte is &gt; 0x7F, that means it&rsquo;s a multi-bytes length, and we have to process the following bytesto get the real length. In this case, the first byte contains teh number of expected following bytes. Typically :</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Text" data-lang="Text">    0x74 -&gt; 116
    0x82 0x02 0x84 : 2 bytes, length = 2 * 16 + 132 -&gt; 164
    0x81 0x84 : 1 byte, length = 132
</code></pre></div><h3 id="value">Value</h3>
<p><strong>Value</strong> carries the &lsquo;meat&rsquo; of a <strong>TLV</strong>. Depending on the <strong>Type</strong>, it&rsquo;s either a primitive value, or a constructed one (which means it contains a <strong>TLV</strong> or a set of <strong>TLV</strong>s). Remember that bit 5 of the <strong>Type</strong> tells if the <strong>Value</strong> is <em>primitive</em> ( b5 == 0) or <em>constructed</em> (b5 == 1).</p>
<ul>
<li>If we have a <em>primitive</em> <strong>Value</strong>, we have to read <strong>Length</strong> byte and we are done</li>
<li>If we have a <em>constructed</em> <strong>Value</strong>, we have to process it as one or more <strong>TLV</strong>.</li>
</ul>
<h2 id="tlv-processing">TLV processing</h2>
<p>In the <strong>API</strong>, the <strong>TLV</strong> processing is done in the <em>Asn1Decoder</em> class, and more specifically by the <em>decode( ByteBuffer stream, Asn1Container container )</em> method, which takes a ByteBuffer as input, and feed a container as a result.</p>
<p>The important thing to understand is that this method can be called repetively, until a message is fully decoded, as soon as we feed it with some new <em>ByteBuffer</em>. The <em>Container</em> instance will contain the result, as soon as its state has switched to <strong>PDU_DECODED</strong>.</p>
<p>While processing a <strong>TLV</strong>, when we are done with the <strong>Value</strong> part, the decoder will check if any action is to be executed. The action is associated to the grammar in use, which is stored in the container. Here is the part that call the action, in the <em>Asn1Decoder.treatTLVDoneState()</em> method :</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#a2f;font-weight:bold">private</span> <span style="color:#0b0;font-weight:bold">boolean</span> <span style="color:#00a000">treatTLVDoneState</span><span style="color:#666">(</span> ByteBuffer stream<span style="color:#666">,</span> Asn1Container container <span style="color:#666">)</span> <span style="color:#a2f;font-weight:bold">throws</span> DecoderException
    <span style="color:#666">{</span>
        <span style="color:#080;font-style:italic">// First, we have to execute the associated action
</span><span style="color:#080;font-style:italic"></span>        container<span style="color:#666">.</span><span style="color:#b44">getGrammar</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">executeAction</span><span style="color:#666">(</span> container <span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#666">.</span><span style="color:#666">.</span><span style="color:#666">.</span>
</code></pre></div><p>So the <em>Container</em> must contain the grammar, and the current state. We may not have any action to execute, either because none is associated with the current transition or because we are at the end of the message.</p>
<h3 id="tlv-implementation">TLV implementation</h3>
<p>The <strong>TLV</strong> class stores the <strong>Type</strong>, <strong>Length</strong> and <strong>Value</strong>, plus some extra information, like a unique <em>id</em>, a reference to its parent&rsquo;s <strong>TLV</strong> and the expected length when the included <strong>Value</strong> is a set of <strong>TLV</strong>.</p>
<p><img src="images/tlv-bervalue.png" alt="TLV/BerValue"></p>
<p>You won&rsquo;t have tp manipulate <strong>TLV</strong> frequently, except in the actions, where you might fetch its <strong>Length</strong> and <strong>Value</strong> content, using <em>getLength()</em> and <em>getValue().getData()</em> methods respectively.</p>
<h3 id="action">Action</h3>
<p>This is quite a simple class and hierarchy :</p>
<p><img src="images/grammar-action.png" alt="GrammarAction"></p>
<p>As we can see, each <strong>Action</strong> has a name (this is only used for debug purpose) and a <em>action(Asn1Container)</em> method, which does what it needs. The <em>Asn1Container</em> parameter gives access to the data through the <em>Asn1Container.getCurrentTLV().getValue().getData()</em> method, and to the message being processed.</p>
<p>At this point, an example would be useful.</p>
<h2 id="example">Example</h2>
<p>Let say we want to implement a decoder for the following message :</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Text" data-lang="Text">    EntryChangeNotification ::= SEQUENCE
    {
        changeType ENUMERATED
        {
            add             (1),
            delete          (2),
            modify          (4),
            modDN           (8)
        },
        previousDN   LDAPDN OPTIONAL,     -- modifyDN ops. only
        changeNumber INTEGER OPTIONAL     -- if supported
    }
</code></pre></div><p>You don&rsquo;t need to know anything about this message, what is important is how we will decode it.</p>
<p>The first thing we need to create is an interface and a implementation for the Java object that will represent the <strong>EntryChange</strong> object.</p>
<p>Here is the interface (note that it&rsquo;s a <em>Control</em>, but it&rsquo;s a irrelevant information here) :</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java">    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#a2f;font-weight:bold">interface</span> <span style="color:#00f">EntryChange</span> <span style="color:#a2f;font-weight:bold">extends</span> Control
    <span style="color:#666">{</span>
        <span style="color:#080;font-style:italic">/** No defined change number */</span> 
        <span style="color:#0b0;font-weight:bold">int</span> UNDEFINED_CHANGE_NUMBER <span style="color:#666">=</span> <span style="color:#666">-</span>1<span style="color:#666">;</span>

        <span style="color:#080;font-style:italic">/** The EntryChange control */</span>
        String OID <span style="color:#666">=</span> <span style="color:#b44">&#34;2.16.840.1.113730.3.4.7&#34;</span><span style="color:#666">;</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * @return The ChangeType
</span><span style="color:#080;font-style:italic">         */</span>
        ChangeType <span style="color:#00a000">getChangeType</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">;</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * Set the ChangeType
</span><span style="color:#080;font-style:italic">         *
</span><span style="color:#080;font-style:italic">         * @param changeType Add, Delete; Modify or ModifyDN
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">setChangeType</span><span style="color:#666">(</span> ChangeType changeType <span style="color:#666">)</span><span style="color:#666">;</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * @return The previous DN
</span><span style="color:#080;font-style:italic">         */</span>
        Dn <span style="color:#00a000">getPreviousDn</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">;</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * Sets the previous DN
</span><span style="color:#080;font-style:italic">         * 
</span><span style="color:#080;font-style:italic">         * @param previousDn The previous DN
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">setPreviousDn</span><span style="color:#666">(</span> Dn previousDn <span style="color:#666">)</span><span style="color:#666">;</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * @return The change number
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#0b0;font-weight:bold">long</span> <span style="color:#00a000">getChangeNumber</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">;</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * Sets the ChangeNumber
</span><span style="color:#080;font-style:italic">         * 
</span><span style="color:#080;font-style:italic">         * @param changeNumber The ChanegNumber
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">setChangeNumber</span><span style="color:#666">(</span> <span style="color:#0b0;font-weight:bold">long</span> changeNumber <span style="color:#666">)</span><span style="color:#666">;</span>
    <span style="color:#666">}</span>
</code></pre></div><p>What is important is that we declare all the setters and getters for the object fields that matter : <em>changeType</em>, <em>previousDN</em> and <em>changeNumber</em></p>
<p>The implementation is not really complex :</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java">    <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">     * A simple implementation of the EntryChange response control.
</span><span style="color:#080;font-style:italic">     *
</span><span style="color:#080;font-style:italic">     * @author &lt;a href=&#34;mailto:dev@directory.apache.org&#34;&gt;Apache Directory Project&lt;/a&gt;
</span><span style="color:#080;font-style:italic">     */</span>
    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#a2f;font-weight:bold">class</span> <span style="color:#00f">EntryChangeImpl</span> <span style="color:#a2f;font-weight:bold">extends</span> AbstractControl <span style="color:#a2f;font-weight:bold">implements</span> EntryChange
    <span style="color:#666">{</span>
        <span style="color:#080;font-style:italic">/** The changeType */</span>
        <span style="color:#a2f;font-weight:bold">private</span> ChangeType changeType <span style="color:#666">=</span> ChangeType<span style="color:#666">.</span><span style="color:#b44">ADD</span><span style="color:#666">;</span>

        <span style="color:#a2f;font-weight:bold">private</span> <span style="color:#0b0;font-weight:bold">long</span> changeNumber <span style="color:#666">=</span> UNDEFINED_CHANGE_NUMBER<span style="color:#666">;</span>

        <span style="color:#080;font-style:italic">/** The previous Dn */</span>
        <span style="color:#a2f;font-weight:bold">private</span> Dn previousDn <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">null</span><span style="color:#666">;</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         *
</span><span style="color:#080;font-style:italic">         * Creates a new instance of EntryChangeControl.
</span><span style="color:#080;font-style:italic">         *
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#00a000">EntryChangeImpl</span><span style="color:#666">(</span><span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">super</span><span style="color:#666">(</span> OID <span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * {@inheritDoc}
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f">@Override</span>
        <span style="color:#a2f;font-weight:bold">public</span> ChangeType <span style="color:#00a000">getChangeType</span><span style="color:#666">(</span><span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">return</span> changeType<span style="color:#666">;</span>
        <span style="color:#666">}</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * {@inheritDoc}
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f">@Override</span>
        <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">setChangeType</span><span style="color:#666">(</span> ChangeType changeType <span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#b44">changeType</span> <span style="color:#666">=</span> changeType<span style="color:#666">;</span>
        <span style="color:#666">}</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * {@inheritDoc}
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f">@Override</span>
        <span style="color:#a2f;font-weight:bold">public</span> Dn <span style="color:#00a000">getPreviousDn</span><span style="color:#666">(</span><span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">return</span> previousDn<span style="color:#666">;</span>
        <span style="color:#666">}</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * {@inheritDoc}
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f">@Override</span>
        <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">setPreviousDn</span><span style="color:#666">(</span> Dn previousDn <span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#b44">previousDn</span> <span style="color:#666">=</span> previousDn<span style="color:#666">;</span>
        <span style="color:#666">}</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * {@inheritDoc}
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f">@Override</span>
        <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#0b0;font-weight:bold">long</span> <span style="color:#00a000">getChangeNumber</span><span style="color:#666">(</span><span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">return</span> changeNumber<span style="color:#666">;</span>
        <span style="color:#666">}</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * {@inheritDoc}
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f">@Override</span>
        <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">setChangeNumber</span><span style="color:#666">(</span> <span style="color:#0b0;font-weight:bold">long</span> changeNumber <span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#b44">changeNumber</span> <span style="color:#666">=</span> changeNumber<span style="color:#666">;</span>
        <span style="color:#666">}</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * @see Object#hashCode()
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f">@Override</span>
        <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#0b0;font-weight:bold">int</span> <span style="color:#00a000">hashCode</span><span style="color:#666">(</span><span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#0b0;font-weight:bold">int</span> h <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">super</span><span style="color:#666">.</span><span style="color:#b44">hashCode</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">;</span>

            h <span style="color:#666">=</span> h <span style="color:#666">*</span> 37 <span style="color:#666">+</span> <span style="color:#666">(</span> <span style="color:#0b0;font-weight:bold">int</span> <span style="color:#666">)</span> changeNumber<span style="color:#666">;</span>
            h <span style="color:#666">=</span> h <span style="color:#666">*</span> 37 <span style="color:#666">+</span> <span style="color:#666">(</span> changeType <span style="color:#666">=</span><span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">null</span> <span style="color:#666">?</span> 0 <span style="color:#666">:</span> changeType<span style="color:#666">.</span><span style="color:#b44">hashCode</span><span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">)</span><span style="color:#666">;</span>
            h <span style="color:#666">=</span> h <span style="color:#666">*</span> 37 <span style="color:#666">+</span> <span style="color:#666">(</span> previousDn <span style="color:#666">=</span><span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">null</span> <span style="color:#666">?</span> 0 <span style="color:#666">:</span> previousDn<span style="color:#666">.</span><span style="color:#b44">hashCode</span><span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">)</span><span style="color:#666">;</span>

            <span style="color:#a2f;font-weight:bold">return</span> h<span style="color:#666">;</span>
        <span style="color:#666">}</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * {@inheritDoc}
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f">@Override</span>
        <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#0b0;font-weight:bold">boolean</span> <span style="color:#00a000">equals</span><span style="color:#666">(</span> Object o <span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span> <span style="color:#666">!</span><span style="color:#a2f;font-weight:bold">super</span><span style="color:#666">.</span><span style="color:#b44">equals</span><span style="color:#666">(</span> o <span style="color:#666">)</span> <span style="color:#666">)</span>
            <span style="color:#666">{</span>
                <span style="color:#a2f;font-weight:bold">return</span> <span style="color:#a2f;font-weight:bold">false</span><span style="color:#666">;</span>
            <span style="color:#666">}</span>

            EntryChange otherControl <span style="color:#666">=</span> <span style="color:#666">(</span> EntryChange <span style="color:#666">)</span> o<span style="color:#666">;</span>

            <span style="color:#a2f;font-weight:bold">return</span> <span style="color:#666">(</span> changeNumber <span style="color:#666">=</span><span style="color:#666">=</span> otherControl<span style="color:#666">.</span><span style="color:#b44">getChangeNumber</span><span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">)</span> <span style="color:#666">&amp;</span><span style="color:#666">&amp;</span> <span style="color:#666">(</span> changeType <span style="color:#666">=</span><span style="color:#666">=</span> otherControl<span style="color:#666">.</span><span style="color:#b44">getChangeType</span><span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">)</span>
                <span style="color:#666">&amp;</span><span style="color:#666">&amp;</span> <span style="color:#666">(</span> previousDn<span style="color:#666">.</span><span style="color:#b44">equals</span><span style="color:#666">(</span> otherControl<span style="color:#666">.</span><span style="color:#b44">getPreviousDn</span><span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">)</span> <span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * Return a String representing this EntryChangeControl.
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f">@Override</span>
        <span style="color:#a2f;font-weight:bold">public</span> String <span style="color:#00a000">toString</span><span style="color:#666">(</span><span style="color:#666">)</span>
        <span style="color:#666">{</span>
            StringBuilder sb <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">new</span> StringBuilder<span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">;</span>

            sb<span style="color:#666">.</span><span style="color:#b44">append</span><span style="color:#666">(</span> <span style="color:#b44">&#34;    Entry Change Control\n&#34;</span> <span style="color:#666">)</span><span style="color:#666">;</span>
            sb<span style="color:#666">.</span><span style="color:#b44">append</span><span style="color:#666">(</span> <span style="color:#b44">&#34;        oid : &#34;</span> <span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">append</span><span style="color:#666">(</span> getOid<span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">append</span><span style="color:#666">(</span> <span style="color:#b44">&#39;\n&#39;</span> <span style="color:#666">)</span><span style="color:#666">;</span>
            sb<span style="color:#666">.</span><span style="color:#b44">append</span><span style="color:#666">(</span> <span style="color:#b44">&#34;        critical : &#34;</span> <span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">append</span><span style="color:#666">(</span> isCritical<span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">append</span><span style="color:#666">(</span> <span style="color:#b44">&#39;\n&#39;</span> <span style="color:#666">)</span><span style="color:#666">;</span>
            sb<span style="color:#666">.</span><span style="color:#b44">append</span><span style="color:#666">(</span> <span style="color:#b44">&#34;        changeType   : &#39;&#34;</span> <span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">append</span><span style="color:#666">(</span> changeType <span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">append</span><span style="color:#666">(</span> <span style="color:#b44">&#34;&#39;\n&#34;</span> <span style="color:#666">)</span><span style="color:#666">;</span>
            sb<span style="color:#666">.</span><span style="color:#b44">append</span><span style="color:#666">(</span> <span style="color:#b44">&#34;        previousDN   : &#39;&#34;</span> <span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">append</span><span style="color:#666">(</span> previousDn <span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">append</span><span style="color:#666">(</span> <span style="color:#b44">&#34;&#39;\n&#34;</span> <span style="color:#666">)</span><span style="color:#666">;</span>

            <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span> changeNumber <span style="color:#666">=</span><span style="color:#666">=</span> UNDEFINED_CHANGE_NUMBER <span style="color:#666">)</span>
            <span style="color:#666">{</span>
                sb<span style="color:#666">.</span><span style="color:#b44">append</span><span style="color:#666">(</span> <span style="color:#b44">&#34;        changeNumber : &#39;&#34;</span> <span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">append</span><span style="color:#666">(</span> <span style="color:#b44">&#34;UNDEFINED&#34;</span> <span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">append</span><span style="color:#666">(</span> <span style="color:#b44">&#34;&#39;\n&#34;</span> <span style="color:#666">)</span><span style="color:#666">;</span>
            <span style="color:#666">}</span>
            <span style="color:#a2f;font-weight:bold">else</span>
            <span style="color:#666">{</span>
                sb<span style="color:#666">.</span><span style="color:#b44">append</span><span style="color:#666">(</span> <span style="color:#b44">&#34;        changeNumber : &#39;&#34;</span> <span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">append</span><span style="color:#666">(</span> changeNumber <span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">append</span><span style="color:#666">(</span> <span style="color:#b44">&#34;&#39;\n&#34;</span> <span style="color:#666">)</span><span style="color:#666">;</span>
            <span style="color:#666">}</span>

            <span style="color:#a2f;font-weight:bold">return</span> sb<span style="color:#666">.</span><span style="color:#b44">toString</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>
    <span style="color:#666">}</span>
</code></pre></div><p>This is pretty much trivial.</p>
<p>We now need a <em>Decorator</em> to manipulate this instance. Here is the code :</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java">    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#a2f;font-weight:bold">class</span> <span style="color:#00f">EntryChangeDecorator</span> <span style="color:#a2f;font-weight:bold">extends</span> ControlDecorator<span style="color:#666">&lt;</span>EntryChange<span style="color:#666">&gt;</span> <span style="color:#a2f;font-weight:bold">implements</span> EntryChange
    <span style="color:#666">{</span>
        <span style="color:#080;font-style:italic">/** Default value when no change number is provided */</span>
        <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#a2f;font-weight:bold">static</span> <span style="color:#a2f;font-weight:bold">final</span> <span style="color:#0b0;font-weight:bold">int</span> UNDEFINED_CHANGE_NUMBER <span style="color:#666">=</span> <span style="color:#666">-</span>1<span style="color:#666">;</span>

        <span style="color:#080;font-style:italic">/** A temporary storage for the previous Dn */</span>
        <span style="color:#a2f;font-weight:bold">private</span> <span style="color:#0b0;font-weight:bold">byte</span><span style="color:#666">[</span><span style="color:#666">]</span> previousDnBytes <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">null</span><span style="color:#666">;</span>

        <span style="color:#080;font-style:italic">/** The entry change global length */</span>
        <span style="color:#a2f;font-weight:bold">private</span> <span style="color:#0b0;font-weight:bold">int</span> eccSeqLength<span style="color:#666">;</span>

        <span style="color:#080;font-style:italic">/** An instance of this decoder */</span>
        <span style="color:#a2f;font-weight:bold">private</span> <span style="color:#a2f;font-weight:bold">static</span> <span style="color:#a2f;font-weight:bold">final</span> Asn1Decoder DECODER <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">new</span> Asn1Decoder<span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">;</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * Creates a new instance of EntryChangeDecoder wrapping a newly created
</span><span style="color:#080;font-style:italic">         * EntryChange Control object.
</span><span style="color:#080;font-style:italic">         * 
</span><span style="color:#080;font-style:italic">         * @param codec The LDAP service instance
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#00a000">EntryChangeDecorator</span><span style="color:#666">(</span> LdapApiService codec <span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">super</span><span style="color:#666">(</span> codec<span style="color:#666">,</span> <span style="color:#a2f;font-weight:bold">new</span> EntryChangeImpl<span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * Creates a new instance of EntryChangeDecorator wrapping the supplied
</span><span style="color:#080;font-style:italic">         * EntryChange Control.
</span><span style="color:#080;font-style:italic">         *
</span><span style="color:#080;font-style:italic">         * @param codec The LDAP service instance
</span><span style="color:#080;font-style:italic">         * @param control The EntryChange Control to be decorated.
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#00a000">EntryChangeDecorator</span><span style="color:#666">(</span> LdapApiService codec<span style="color:#666">,</span> EntryChange control <span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">super</span><span style="color:#666">(</span> codec<span style="color:#666">,</span> control <span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * Internally used to not have to cast the decorated Control.
</span><span style="color:#080;font-style:italic">         *
</span><span style="color:#080;font-style:italic">         * @return the decorated Control.
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f;font-weight:bold">private</span> EntryChange <span style="color:#00a000">getEntryChange</span><span style="color:#666">(</span><span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">return</span> getDecorated<span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * Compute the EntryChangeControl length 
</span><span style="color:#080;font-style:italic">         * 
</span><span style="color:#080;font-style:italic">         * &lt;pre&gt;
</span><span style="color:#080;font-style:italic">         * 0x30 L1 
</span><span style="color:#080;font-style:italic">         *   | 
</span><span style="color:#080;font-style:italic">         *   +--&amp;gt; 0x0A 0x0(1-4) [1|2|4|8] (changeType) 
</span><span style="color:#080;font-style:italic">         *  [+--&amp;gt; 0x04 L2 previousDN] 
</span><span style="color:#080;font-style:italic">         *  [+--&amp;gt; 0x02 0x0(1-4) [0..2^63-1] (changeNumber)]
</span><span style="color:#080;font-style:italic">         *  &lt;/pre&gt;
</span><span style="color:#080;font-style:italic">         *  
</span><span style="color:#080;font-style:italic">         * @return the control length.
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f">@Override</span>
        <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#0b0;font-weight:bold">int</span> <span style="color:#00a000">computeLength</span><span style="color:#666">(</span><span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#0b0;font-weight:bold">int</span> changeTypesLength <span style="color:#666">=</span> 1 <span style="color:#666">+</span> 1 <span style="color:#666">+</span> 1<span style="color:#666">;</span>

            <span style="color:#0b0;font-weight:bold">int</span> previousDnLength <span style="color:#666">=</span> 0<span style="color:#666">;</span>
            <span style="color:#0b0;font-weight:bold">int</span> changeNumberLength <span style="color:#666">=</span> 0<span style="color:#666">;</span>

            <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span> getPreviousDn<span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">!</span><span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">null</span> <span style="color:#666">)</span>
            <span style="color:#666">{</span>
                previousDnBytes <span style="color:#666">=</span> Strings<span style="color:#666">.</span><span style="color:#b44">getBytesUtf8</span><span style="color:#666">(</span> getPreviousDn<span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">getName</span><span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">)</span><span style="color:#666">;</span>
                previousDnLength <span style="color:#666">=</span> 1 <span style="color:#666">+</span> TLV<span style="color:#666">.</span><span style="color:#b44">getNbBytes</span><span style="color:#666">(</span> previousDnBytes<span style="color:#666">.</span><span style="color:#b44">length</span> <span style="color:#666">)</span> <span style="color:#666">+</span> previousDnBytes<span style="color:#666">.</span><span style="color:#b44">length</span><span style="color:#666">;</span>
            <span style="color:#666">}</span>

            <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span> getChangeNumber<span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">!</span><span style="color:#666">=</span> UNDEFINED_CHANGE_NUMBER <span style="color:#666">)</span>
            <span style="color:#666">{</span>
                changeNumberLength <span style="color:#666">=</span> 1 <span style="color:#666">+</span> 1 <span style="color:#666">+</span> BerValue<span style="color:#666">.</span><span style="color:#b44">getNbBytes</span><span style="color:#666">(</span> getChangeNumber<span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">)</span><span style="color:#666">;</span>
            <span style="color:#666">}</span>

            eccSeqLength <span style="color:#666">=</span> changeTypesLength <span style="color:#666">+</span> previousDnLength <span style="color:#666">+</span> changeNumberLength<span style="color:#666">;</span>
            valueLength <span style="color:#666">=</span> 1 <span style="color:#666">+</span> TLV<span style="color:#666">.</span><span style="color:#b44">getNbBytes</span><span style="color:#666">(</span> eccSeqLength <span style="color:#666">)</span> <span style="color:#666">+</span> eccSeqLength<span style="color:#666">;</span>

            <span style="color:#a2f;font-weight:bold">return</span> valueLength<span style="color:#666">;</span>
        <span style="color:#666">}</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * Encodes the entry change control.
</span><span style="color:#080;font-style:italic">         * 
</span><span style="color:#080;font-style:italic">         * @param buffer The encoded sink
</span><span style="color:#080;font-style:italic">         * @return A ByteBuffer that contains the encoded PDU
</span><span style="color:#080;font-style:italic">         * @throws EncoderException If anything goes wrong.
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f">@Override</span>
        <span style="color:#a2f;font-weight:bold">public</span> ByteBuffer <span style="color:#00a000">encode</span><span style="color:#666">(</span> ByteBuffer buffer <span style="color:#666">)</span> <span style="color:#a2f;font-weight:bold">throws</span> EncoderException
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span> buffer <span style="color:#666">=</span><span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">null</span> <span style="color:#666">)</span>
            <span style="color:#666">{</span>
                <span style="color:#a2f;font-weight:bold">throw</span> <span style="color:#a2f;font-weight:bold">new</span> EncoderException<span style="color:#666">(</span> I18n<span style="color:#666">.</span><span style="color:#b44">err</span><span style="color:#666">(</span> I18n<span style="color:#666">.</span><span style="color:#b44">ERR_04023</span> <span style="color:#666">)</span> <span style="color:#666">)</span><span style="color:#666">;</span>
            <span style="color:#666">}</span>

            buffer<span style="color:#666">.</span><span style="color:#b44">put</span><span style="color:#666">(</span> UniversalTag<span style="color:#666">.</span><span style="color:#b44">SEQUENCE</span><span style="color:#666">.</span><span style="color:#b44">getValue</span><span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">)</span><span style="color:#666">;</span>
            buffer<span style="color:#666">.</span><span style="color:#b44">put</span><span style="color:#666">(</span> TLV<span style="color:#666">.</span><span style="color:#b44">getBytes</span><span style="color:#666">(</span> eccSeqLength <span style="color:#666">)</span> <span style="color:#666">)</span><span style="color:#666">;</span>

            buffer<span style="color:#666">.</span><span style="color:#b44">put</span><span style="color:#666">(</span> UniversalTag<span style="color:#666">.</span><span style="color:#b44">ENUMERATED</span><span style="color:#666">.</span><span style="color:#b44">getValue</span><span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">)</span><span style="color:#666">;</span>
            buffer<span style="color:#666">.</span><span style="color:#b44">put</span><span style="color:#666">(</span> <span style="color:#666">(</span> <span style="color:#0b0;font-weight:bold">byte</span> <span style="color:#666">)</span> 1 <span style="color:#666">)</span><span style="color:#666">;</span>
            buffer<span style="color:#666">.</span><span style="color:#b44">put</span><span style="color:#666">(</span> BerValue<span style="color:#666">.</span><span style="color:#b44">getBytes</span><span style="color:#666">(</span> getChangeType<span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">getValue</span><span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">)</span> <span style="color:#666">)</span><span style="color:#666">;</span>

            <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span> getPreviousDn<span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">!</span><span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">null</span> <span style="color:#666">)</span>
            <span style="color:#666">{</span>
                BerValue<span style="color:#666">.</span><span style="color:#b44">encode</span><span style="color:#666">(</span> buffer<span style="color:#666">,</span> previousDnBytes <span style="color:#666">)</span><span style="color:#666">;</span>
            <span style="color:#666">}</span>

            <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span> getChangeNumber<span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">!</span><span style="color:#666">=</span> UNDEFINED_CHANGE_NUMBER <span style="color:#666">)</span>
            <span style="color:#666">{</span>
                BerValue<span style="color:#666">.</span><span style="color:#b44">encode</span><span style="color:#666">(</span> buffer<span style="color:#666">,</span> getChangeNumber<span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">)</span><span style="color:#666">;</span>
            <span style="color:#666">}</span>

            <span style="color:#a2f;font-weight:bold">return</span> buffer<span style="color:#666">;</span>
        <span style="color:#666">}</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * {@inheritDoc}
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f">@Override</span>
        <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#0b0;font-weight:bold">byte</span><span style="color:#666">[</span><span style="color:#666">]</span> <span style="color:#00a000">getValue</span><span style="color:#666">(</span><span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span> value <span style="color:#666">=</span><span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">null</span> <span style="color:#666">)</span>
            <span style="color:#666">{</span>
                <span style="color:#a2f;font-weight:bold">try</span>
                <span style="color:#666">{</span>
                    computeLength<span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">;</span>
                    ByteBuffer buffer <span style="color:#666">=</span> ByteBuffer<span style="color:#666">.</span><span style="color:#b44">allocate</span><span style="color:#666">(</span> valueLength <span style="color:#666">)</span><span style="color:#666">;</span>

                    buffer<span style="color:#666">.</span><span style="color:#b44">put</span><span style="color:#666">(</span> UniversalTag<span style="color:#666">.</span><span style="color:#b44">SEQUENCE</span><span style="color:#666">.</span><span style="color:#b44">getValue</span><span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">)</span><span style="color:#666">;</span>
                    buffer<span style="color:#666">.</span><span style="color:#b44">put</span><span style="color:#666">(</span> TLV<span style="color:#666">.</span><span style="color:#b44">getBytes</span><span style="color:#666">(</span> eccSeqLength <span style="color:#666">)</span> <span style="color:#666">)</span><span style="color:#666">;</span>

                    buffer<span style="color:#666">.</span><span style="color:#b44">put</span><span style="color:#666">(</span> UniversalTag<span style="color:#666">.</span><span style="color:#b44">ENUMERATED</span><span style="color:#666">.</span><span style="color:#b44">getValue</span><span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">)</span><span style="color:#666">;</span>
                    buffer<span style="color:#666">.</span><span style="color:#b44">put</span><span style="color:#666">(</span> <span style="color:#666">(</span> <span style="color:#0b0;font-weight:bold">byte</span> <span style="color:#666">)</span> 1 <span style="color:#666">)</span><span style="color:#666">;</span>
                    buffer<span style="color:#666">.</span><span style="color:#b44">put</span><span style="color:#666">(</span> BerValue<span style="color:#666">.</span><span style="color:#b44">getBytes</span><span style="color:#666">(</span> getChangeType<span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">getValue</span><span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">)</span> <span style="color:#666">)</span><span style="color:#666">;</span>

                    <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span> getPreviousDn<span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">!</span><span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">null</span> <span style="color:#666">)</span>
                    <span style="color:#666">{</span>
                        BerValue<span style="color:#666">.</span><span style="color:#b44">encode</span><span style="color:#666">(</span> buffer<span style="color:#666">,</span> previousDnBytes <span style="color:#666">)</span><span style="color:#666">;</span>
                    <span style="color:#666">}</span>

                    <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span> getChangeNumber<span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">!</span><span style="color:#666">=</span> UNDEFINED_CHANGE_NUMBER <span style="color:#666">)</span>
                    <span style="color:#666">{</span>
                        BerValue<span style="color:#666">.</span><span style="color:#b44">encode</span><span style="color:#666">(</span> buffer<span style="color:#666">,</span> getChangeNumber<span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">)</span><span style="color:#666">;</span>
                    <span style="color:#666">}</span>

                    value <span style="color:#666">=</span> buffer<span style="color:#666">.</span><span style="color:#b44">array</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">;</span>
                <span style="color:#666">}</span>
                <span style="color:#a2f;font-weight:bold">catch</span> <span style="color:#666">(</span> Exception e <span style="color:#666">)</span>
                <span style="color:#666">{</span>
                    <span style="color:#a2f;font-weight:bold">return</span> <span style="color:#a2f;font-weight:bold">null</span><span style="color:#666">;</span>
                <span style="color:#666">}</span>
            <span style="color:#666">}</span>

            <span style="color:#a2f;font-weight:bold">return</span> value<span style="color:#666">;</span>
        <span style="color:#666">}</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * {@inheritDoc}
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f">@Override</span>
        <span style="color:#a2f;font-weight:bold">public</span> ChangeType <span style="color:#00a000">getChangeType</span><span style="color:#666">(</span><span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">return</span> getEntryChange<span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">getChangeType</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * {@inheritDoc}
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f">@Override</span>
        <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">setChangeType</span><span style="color:#666">(</span> ChangeType changeType <span style="color:#666">)</span>
        <span style="color:#666">{</span>
            getEntryChange<span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">setChangeType</span><span style="color:#666">(</span> changeType <span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * {@inheritDoc}
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f">@Override</span>
        <span style="color:#a2f;font-weight:bold">public</span> Dn <span style="color:#00a000">getPreviousDn</span><span style="color:#666">(</span><span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">return</span> getEntryChange<span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">getPreviousDn</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * {@inheritDoc}
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f">@Override</span>
        <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">setPreviousDn</span><span style="color:#666">(</span> Dn previousDn <span style="color:#666">)</span>
        <span style="color:#666">{</span>
            getEntryChange<span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">setPreviousDn</span><span style="color:#666">(</span> previousDn <span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * {@inheritDoc}
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f">@Override</span>
        <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#0b0;font-weight:bold">long</span> <span style="color:#00a000">getChangeNumber</span><span style="color:#666">(</span><span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">return</span> getEntryChange<span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">getChangeNumber</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * {@inheritDoc}
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f">@Override</span>
        <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">setChangeNumber</span><span style="color:#666">(</span> <span style="color:#0b0;font-weight:bold">long</span> changeNumber <span style="color:#666">)</span>
        <span style="color:#666">{</span>
            getEntryChange<span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">setChangeNumber</span><span style="color:#666">(</span> changeNumber <span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * {@inheritDoc}
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f">@Override</span>
        <span style="color:#a2f;font-weight:bold">public</span> Asn1Object <span style="color:#00a000">decode</span><span style="color:#666">(</span> <span style="color:#0b0;font-weight:bold">byte</span><span style="color:#666">[</span><span style="color:#666">]</span> controlBytes <span style="color:#666">)</span> <span style="color:#a2f;font-weight:bold">throws</span> DecoderException
        <span style="color:#666">{</span>
            ByteBuffer bb <span style="color:#666">=</span> ByteBuffer<span style="color:#666">.</span><span style="color:#b44">wrap</span><span style="color:#666">(</span> controlBytes <span style="color:#666">)</span><span style="color:#666">;</span>
            EntryChangeContainer container <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">new</span> EntryChangeContainer<span style="color:#666">(</span> getCodecService<span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">,</span> <span style="color:#a2f;font-weight:bold">this</span> <span style="color:#666">)</span><span style="color:#666">;</span>
            DECODER<span style="color:#666">.</span><span style="color:#b44">decode</span><span style="color:#666">(</span> bb<span style="color:#666">,</span> container <span style="color:#666">)</span><span style="color:#666">;</span>
            <span style="color:#a2f;font-weight:bold">return</span> <span style="color:#a2f;font-weight:bold">this</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>
    <span style="color:#666">}</span>
</code></pre></div>

            
    <div class="nav">
        <div class="nav_prev">
            
                
                <a href="4-asn1.html">4 - ASN/1</a>
            
        </div>
        <div class="nav_up">
            
                
                <a href="../internal-design-guide.html">Internal Design Guide</a>
            
        </div>
        <div class="nav_next">
            
                
                <a href="5-network.html">5 - Network</a>
            
        </div>
        <div class="clearfix"></div>
    </div>


        </div>
        <div id="endContent"></div>
    </div>

    <div id="footer">
    &copy; 2003-2022, <a href="http://www.apache.org">The Apache Software Foundation</a> - <a href="/privacy-policy.html">Privacy Policy</a><br />
    Apache Directory, ApacheDS, Apache Directory Server, Apache Directory Studio, Apache LDAP API, Apache Triplesec,
    Triplesec, Apache Mavibot, Mavibot, Apache eSCIMo, eSCIMo, Apache SCIMple, SCIMple,Fortress, Apache Fortress, EnMasse,
    Apache EnMasse, Apache Kerby, Kerby, Apache, the Apache feather logo, and the Apache Directory project logos are
    trademarks of The Apache Software Foundation.
</div>

</div>

</body>

</html>
