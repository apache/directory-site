<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="utf-8">
    <title>9 - DN &mdash; Apache Directory</title>

    <link href="/css/common.css" rel="stylesheet" type="text/css"/>
    <link href="/css/brown.css" rel="stylesheet" type="text/css"/>

    <link rel="shortcut icon" href="/images/server-icon_16x16.png" />
    <script src="https://www.apachecon.com/event-images/snippet.js"></script>
</head>

<body>
<div id="container">
    <div id="header">
    <a href="/"><div id="headerClick"></div></a>
    <div id="subProjectsNavBar">
        <a href="/">
             
                Main
            
        </a>
        &nbsp;|&nbsp;
        <a href="/apacheds/">
             
                ApacheDS
            
        </a>
        &nbsp;|&nbsp;
        <a href="/studio/">
             
                Studio
            
        </a>
        &nbsp;|&nbsp;
        <a href="/api/">
            
                <strong>LDAP API</strong>
            
        </a>
        &nbsp;|&nbsp;
        <a href="/mavibot/">
             
                Mavibot
            
        </a>
        &nbsp;|&nbsp;
        <a href="/scimple/">
             
                SCIMple
            
        </a>
        &nbsp;|&nbsp;
        <a href="/fortress/">
             
                Fortress
            
        </a>
        &nbsp;|&nbsp;
        <a href="/kerby/">
             
                Kerby
            
        </a>
    </div>
</div>


    <div id="content">
        <div id="leftColumn">
            <div id="navigation">
                
                <a class="acevent" data-format="wide" data-width="170"></a>
                <h5>LDAP API </h5>
                <ul>
                    <li><a href="/api/">Home</a></li>
                    <li><a href="/api/news.html">News</a></li>
                </ul>

                <h5>Downloads</h5>
                <ul>
                    <li><a href="/api/downloads-2.html">Version 2.1.7</a>&nbsp;&nbsp;<img src="/images/new_badge.gif" alt="" style="margin-bottom:-3px;" border="0"></li>
                    <li><a href="/api/downloads-1.html">Version 1.0.3</a>&nbsp;&nbsp;</li>
                    <li><a href="/api/download-old-versions.html">Older versions</a></li>
                </ul>

                <h5>Getting Started</h5>
                <ul>
                    <li><a href="/api/vision.html">Vision</a></li>
                    <li><a href="/api/java-api.html">Java API</a></li>
                </ul>

                <h5>Documentation</h5>
                <ul>
                    <li><a href="/api/five-minutes-tutorial.html">Five minute tutorial</a></li>
                    <li><a href="/api/user-guide.html">User Guide</a></li>
                    <li><a href="/api/migration-guide.html">API 1 to 2 migration</a></li>
                    <li><a href="/api/gen-docs/latest2/apidocs/">JavaDocs 2</a></li>
                    <li><a href="/api/gen-docs/latest/apidocs/">JavaDocs</a></li>
                    <li><a href="/api/gen-docs/latest2/xref/">Cross-Reference 2</a></li>
                    <li><a href="/api/gen-docs/latest/xref/">Cross-Reference</a></li>
                    
                    <li><a href="/api/developer-guide.html">Developer Guide</a></li>
                    <li><a href="/api/internal-design-guide.html">Internal Guide</a></li>
                </ul>

                <h5>Support</h5>
<ul>
    <li><a href="/mailing-lists-and-irc.html">Mailing Lists &amp; IRC</a></li>
    <li><a href="/sources.html">Sources</a></li>
    <li><a href="/issue-tracking.html">Issue Tracking</a></li>
    <li><a href="/commercial-support.html">Commercial Support</a></li>
</ul>

<h5>Community</h5>
<ul>
    <li><a href="/contribute.html">How to Contribute</a></li>
    <li><a href="/team.html">Team</a></li>
    <li><a href="/original-project-proposal.html">Original Project Proposal</a></li>
    <li><a href="/special-thanks.html" class="external-link" rel="nofollow">Special Thanks</a></li>
</ul>

<h5>About Apache</h5>
<ul>
    <li><a href="https://www.apache.org/">Apache</a></li>
    <li><a href="https://www.apache.org/licenses/">License</a></li>
    <li><a href="https://www.apache.org/foundation/sponsorship.html">Sponsorship</a></li>
    <li><a href="https://www.apache.org/foundation/thanks.html">Thanks</a></li>
    <li><a href="https://www.apache.org/security/">Security</a></li>
</ul>

            </div>
        </div>
        <div id="rightColumn">
            
    <div class="nav">
        <div class="nav_prev">
            
                
                <a href="8-schema.html">8 - Schema</a>
            
        </div>
        <div class="nav_up">
            
                
                <a href="../internal-design-guide.html">Internal Design Guide</a>
            
        </div>
        <div class="nav_next">
            
                
                <a href="10-entry.html">10 - Entry</a>
            
        </div>
        <div class="clearfix"></div>
    </div>


            
	<h1 id="9---dn">9 - DN</h1>
<p>A <strong>DN</strong>, or <strong>Distinguished Name</strong> is a data structure that is composed of a list of <strong>RDN</strong> (<strong>Relative DN</strong>). Each <strong>RDN</strong> is composed of a list of <strong>AVA</strong> (<strong>AttributeType And Value</strong>).</p>
<p>In a <strong>DN</strong>, the list of <strong>RDN</strong> is ordered from the most significant to the least significant <strong>RDN</strong>. For instance:</p>
<pre><code>cn=JohnDoe,ou=apache,dc=com
</code></pre>
<p>The most significant <strong>RDN</strong> is <code>cn=JohnDoe</code>.</p>
<h2 id="rdn">RDN</h2>
<p>A <strong>RDN</strong> can be composed of many <strong>AVAs</strong>, which are ordered in two ways:</p>
<ul>
<li>Lexicograpgically, if we don&rsquo;t have a schema</li>
<li>By <strong>OID</strong>, if we have a schema</li>
</ul>
<p>Typically, a <strong>DN</strong> like:</p>
<pre><code>gn=Kate+cn=Bush,ou=apache,dc=com
</code></pre>
<p>will be ordered internally as :</p>
<pre><code>cn=Bush+gn=Kate,ou=apache,dc=com	
</code></pre>
<p>if we don&rsquo;t have a schema (because <code>cn</code> is lexicographically before <code>gn</code>), or if we have a schema (because <code>2.5.4.3</code> is the <code>cn</code>'s <strong>OID</strong> and <code>2.5.4.42</code> is the <code>gn</code>'s <strong>OID</strong>)</p>
<h3 id="internal-structure">Internal structure</h3>
<p>We keep the following data inside a <strong>RDN</strong>:</p>
<ul>
<li><code>upName</code>: a <code>String</code> containing the <strong>RDN</strong> user provided value</li>
<li><code>normName</code>: a <code>String</code> containing the normalized <strong>RDN</strong> value</li>
<li><code>avas</code>: A list of ordered <strong>AVAs</strong></li>
<li><code>avaTypes</code>: A map of the <strong>RDN</strong> <code>AttributeTypes</code> (each <strong>AVA</strong> has an <code>AttributeType</code>) for a quick search</li>
<li><code>avaType</code>: If we have only one <strong>AVA</strong>, we store its <code>AttributeType</code> here, not in the Map</li>
<li><code>ava</code>: If we have only one <strong>AVA</strong>, we store it here, not in the list</li>
<li><code>nbAvas</code>: The number of <strong>AVAs</strong> in this <strong>RDN</strong>.</li>
<li><code>normalized</code>: A boolean indicating if the <strong>RDN</strong> has been normalized</li>
<li><code>h</code>: The integer hascode for this instance</li>
</ul>
<p><strong>Note</strong>: When a <strong>RDN</strong> is initially created, we don&rsquo;t allocate the <code>List</code> or <code>Map</code>, because most of the time, the <strong>RDN</strong> contains a single <strong>AVA</strong>. We could extend the <strong>RDN</strong> class to manage those with multiple <strong>AVAs</strong> instead of managing all in one single class, but that would require having a <strong>RdnFactory</strong> class.</p>
<h3 id="processing">Processing</h3>
<p>We have two parsers that get called:</p>
<ul>
<li>The <code>FastParserRdn</code> for simpler <strong>RDNs</strong></li>
<li>The <code>ComplexDnParser</code> for composed <strong>RDNs</strong> (or more specific use cases)</li>
</ul>
<p>If the first parser fails to parse the <strong>RDN</strong>, we call back to the second parser. That means we are fast in 99,9% of the time, and longer otherwise.</p>
<p>Here is how it&rsquo;s handled:</p>
<pre><code>private static void parse( SchemaManager schemaManager, String dn, Rdn rdn ) throws LdapInvalidDnException
{
    try
    {
        FastDnParser.parseRdn( schemaManager, dn, rdn );
    }
    catch ( TooComplexDnException e )
    {
        rdn.clear();
        new ComplexDnParser().parseRdn( schemaManager, dn, rdn );
    }
}
</code></pre>
<p>The <code>FastDnParser</code> is basically a recursive descent: we consider we have a single <code>AttributeType</code>, an <code>=</code> sign, and the value. If we have a Schema, we will use it to process the <code>AttributeType</code> and the value, normalizing it (that is done at the <code>Ava</code> level). At the end, we get back an <code>Rdn</code> instance, with one <code>Ava</code>, where the following class&rsquo; fields are updated:</p>
<ul>
<li><code>upName:</code>: The user provided form (the provided String)</li>
<li><code>normName</code>: The normalized form</li>
<li><code>avas</code>: null</li>
<li><code>avaTypes</code>: null</li>
<li><code>avaType</code>: The <code>AttributeType</code></li>
<li><code>ava</code>: The <code>Ava</code> instance</li>
<li><code>nbAvas</code>: 1</li>
<li><code>normalized</code>: true or false (depends on the schema being present)</li>
<li><code>h</code>: The integer hascode for this instance</li>
</ul>
<p>As we can see, the List and Map are null.</p>
<p>The <code>ComplexDnParser</code> is an <strong>antlr</strong> based parser. It&rsquo;s much slower. We start with an inner production of this parser, the <code>relativeDistinguishedName</code> part:</p>
<pre><code>relativeDistinguishedName [SchemaManager schemaManager, Rdn rdn]
:
(
    attributeTypeAndValue[schemaManager, rdn] 
    (
        PLUS 
        attributeTypeAndValue[schemaManager, rdn] 
    )*
)
</code></pre>
<p>As we can see, we can have to process one or more <code>attributeTypeAndValue</code> (aka <strong>AVA</strong>), and we need to do it in a way that allows the comparison of <strong>RDNs</strong> in a simple way.</p>
<p>For that, as a <strong>RDN</strong> contain multiples <strong>AVAs</strong>, we need to order them. There are two use cases:</p>
<ul>
<li>The <strong>RDN</strong> is Schema aware</li>
<li>The <strong>RDN</strong> is not schema aware</li>
</ul>
<h4 id="schema-aware-rdn">Schema aware RDN</h4>
<p>This is the simplest case, because we have a standard way to &lsquo;normalize&rsquo; each element:</p>
<ul>
<li>The <code>AttributeType</code> is always represented as an <strong>OID</strong></li>
<li>The value is always normalized accordingly to its <code>AttributeType</code></li>
</ul>
<p>For instance, a <strong>RDN</strong> like:</p>
<pre><code>gn=Kate+cn=Bush
</code></pre><p>uses two <strong>AVAs</strong> (separated by the <strong>+</strong> sign), one with the <strong>cn</strong> <code>AttributeType</code> and the other with the <strong>gn</strong> <code>AttributeType</code>.</p>
<p>The <strong>cn</strong> <code>AttributeType</code>  is normalized as <code>2.5.4.3</code>, and the <strong>gn</strong> <code>AttributeType</code>  is normalized as 2.5.4.42.</p>
<p>Now, if we use those <strong>OID</strong>, the <strong>RDN</strong> becomes:</p>
<pre><code>2.5.4.3=Bush+2.5.4.42=Kate
</code></pre><p>We have a way to order the <strong>AVA</strong> using the <strong>OIDs</strong> numeric values (<code>2.5.4.3</code> &lt; <code>2.5.4.42</code>).</p>
<p>However, we still have to deal with the case where the <strong>RDN</strong> contains many times the same <code>AttributeType</code>, like in:</p>
<pre><code>cn=john+cn=doe
</code></pre><p>This is possible because the <code>cn</code> <code>AttributeType</code> accept more than one value:</p>
<pre><code>( 2.5.4.3 NAME 'cn' SUP name )

( 2.5.4.41 NAME 'name'
         EQUALITY caseIgnoreMatch
         SUBSTR caseIgnoreSubstringsMatch
         SYNTAX 1.3.6.1.4.1.1466.115.121.1.15 )
</code></pre><p>(Neither the <code>name</code>  or the <code>cn</code> <code>AttributeTypes</code> has the <strong>SINGLE-VALUE</strong> property)</p>
<p>So we need to be able to order such <strong>RDN</strong>. We do that by keeping a <strong>Map&lt;AttributeType, List<Ava>&gt;</strong> in the <strong>RDN</strong> structure. For instance, for the <code>cn=john+cn=doe+gn=jo</code> <strong>RDN</strong>, the <strong>Map</strong> will look like:</p>
<pre><code>&lt;cn&gt; -&gt; {'doe', 'john'}
&lt;gn&gt; -&gt; {'jo'}
</code></pre>
<p>The value are ordered in the <strong>List</strong>.</p>
<h4 id="non-schema-aware-rdn">Non Schema aware RDN</h4>
<p>This is slightly different, because we can&rsquo;t normalize the <code>AttributeTypes</code> as <strong>OIDs</strong>.</p>
<p>What we do is that we use the lowercase representation of the <code>AttributeTypes</code>, assuming we won&rsquo;t be able to deal with aliases (ie <code>cn</code> and <code>commonName</code> are teh same <code>AttributeTypes</code>). Then we use a lexicographic order.</p>
<h4 id="fast-parser">Fast parser</h4>
<p>This is a recursive descent. The <code>parser</code> method is called with three arguments:</p>
<ul>
<li>The schema manager (may be null)</li>
<li>The String to parse, containing the <strong>RDN</strong></li>
<li>The resulting <strong>RDN</strong> (the method does not return an instance)</li>
</ul>
<p>The reason it does not return an instance is that this method is private and is either called to validate a <strong>RDN</strong> or to parse a new <strong>RDN</strong>. In the first case, we don&rsquo;t need to return anything, in the second case we call this method from a <strong>RDN</strong> instance. As the method is static, we need to cover both cases, and passing the <strong>RDN</strong> instance cover both, either by passing <code>null</code> when we want to check the <strong>RDN</strong> validity, or <code>this</code> to create a new <strong>RDN</strong>.</p>
<p>The <code>parse()</code> method is the entry point (see upper), and it first call the <code>FastDnParser</code> (there is no point in having one parser for <strong>DN</strong> and one for <strong>RDN</strong>, as a <strong>RDN</strong> is just a specific case of a <strong>DN</strong> with one single <strong>RDN</strong> ) and if we get an exception, calls the <code>ComplexDnParser</code>:</p>
<pre><code>private static void parse( SchemaManager schemaManager, String rdnStr, Rdn rdn ) throws LdapInvalidDnException
{
    try
    {
        FastDnParser.parseRdn( schemaManager, rdnStr, rdn );
    }
    catch ( TooComplexDnException e )
    {
        rdn.clear();
        new ComplexDnParser().parseRdn( schemaManager, rdnStr, rdn );
    }
}
</code></pre>
<p>The <code>parseRdn</code> method calls the <code>parseRdnInternal</code> after some initialization:</p>
<pre><code>/* No protection*/static void parseRdn( SchemaManager schemaManager, String name, Rdn rdn ) throws LdapInvalidDnException
{
    if ( Strings.isEmpty( name ) )
    {
        throw new LdapInvalidDnException( ResultCodeEnum.INVALID_DN_SYNTAX, I18n.err( I18n.ERR_13602_RDN_EMPTY ) );
    }

    if ( rdn == null )
    {
        throw new LdapInvalidDnException( ResultCodeEnum.INVALID_DN_SYNTAX, I18n.err( I18n.ERR_13603_NULL_RDN ) );
    }

    Position pos = new Position();
    pos.start = 0;
    pos.length = name.length();
    StringBuilder sb = new StringBuilder();

    parseRdnInternal( schemaManager, name, pos, rdn );
    
    sb.append( rdn.getNormName() );
}
</code></pre>
<p>from there, it&rsquo;s quite simple:</p>
<ul>
<li>check for starting spaces and get rid of them</li>
<li>read the <code>AttributeType</code></li>
<li>ignore the space up to the <strong>=</strong> sign</li>
<li>skip the <strong>=</strong> sign</li>
<li>ignore the spaces upo to the first non-space char or the end of the String</li>
</ul>
<h4 id="complex-parser">Complex parser</h4>


            
    <div class="nav">
        <div class="nav_prev">
            
                
                <a href="8-schema.html">8 - Schema</a>
            
        </div>
        <div class="nav_up">
            
                
                <a href="../internal-design-guide.html">Internal Design Guide</a>
            
        </div>
        <div class="nav_next">
            
                
                <a href="10-entry.html">10 - Entry</a>
            
        </div>
        <div class="clearfix"></div>
    </div>


        </div>
        <div id="endContent"></div>
    </div>

    <div id="footer">
    &copy; 2003-2025, <a href="https://www.apache.org">The Apache Software Foundation</a> - <a href="https://privacy.apache.org/policies/privacy-policy-public.html">Privacy Policy</a><br />
    Apache Directory, ApacheDS, Apache Directory Server, Apache Directory Studio, Apache LDAP API, Apache Triplesec,
    Triplesec, Apache Mavibot, Mavibot, Apache eSCIMo, eSCIMo, Apache SCIMple, SCIMple,Fortress, Apache Fortress, EnMasse,
    Apache EnMasse, Apache Kerby, Kerby, Apache, the Apache feather logo, and the Apache Directory project logos are
    trademarks of The Apache Software Foundation.
</div>

</div>

</body>

</html>
