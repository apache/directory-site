<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="utf-8">
    <title>14 - Extended Operations &mdash; Apache Directory</title>

    <link href="/css/common.css" rel="stylesheet" type="text/css"/>
    <link href="/css/brown.css" rel="stylesheet" type="text/css"/>

    <link rel="shortcut icon" href="/images/server-icon_16x16.png" />
</head>

<body>
<div id="container">
    <div id="header">
    <div id="subProjectsNavBar">
        <a href="/">
             
                Main
            
        </a>
        &nbsp;|&nbsp;
        <a href="/apacheds/">
             
                ApacheDS
            
        </a>
        &nbsp;|&nbsp;
        <a href="/studio/">
             
                Studio
            
        </a>
        &nbsp;|&nbsp;
        <a href="/api/">
            
                <strong>LDAP API</strong>
            
        </a>
        &nbsp;|&nbsp;
        <a href="/mavibot/">
             
                Mavibot
            
        </a>
        &nbsp;|&nbsp;
        <a href="/scimple/">
             
                SCIMple
            
        </a>
        &nbsp;|&nbsp;
        <a href="/fortress/">
             
                Fortress
            
        </a>
        &nbsp;|&nbsp;
        <a href="/kerby/">
             
                Kerby
            
        </a>
    </div>
</div>


    <div id="content">
        <div id="leftColumn">
            <div id="navigation">
                
                <h5>LDAP API </h5>
                <ul>
                    <li><a href="/api/">Home</a></li>
                    <li><a href="/api/news.html">News</a></li>
                </ul>

                <h5>Downloads</h5>
                <ul>
                    <li><a href="/api/downloads-2.html">Version 2.1.2</a>&nbsp;&nbsp;<img src="/images/new_badge.gif" alt="" style="margin-bottom:-3px;" border="0"></li>
                    <li><a href="/api/downloads-1.html">Version 1.0.3</a>&nbsp;&nbsp;</li>
                    <li><a href="/api/download-old-versions.html">Older versions</a></li>
                </ul>

                <h5>Getting Started</h5>
                <ul>
                    <li><a href="/api/vision.html">Vision</a></li>
                    <li><a href="/api/java-api.html">Java API</a></li>
                </ul>

                <h5>Documentation</h5>
                <ul>
                    <li><a href="/api/five-minutes-tutorial.html">Five minute tutorial</a></li>
                    <li><a href="/api/user-guide.html">User Guide</a></li>
                    <li><a href="/api/migration-guide.html">API 1 to 2 migration</a></li>
                    <li><a href="/api/gen-docs/latest2/apidocs/">JavaDocs 2</a></li>
                    <li><a href="/api/gen-docs/latest/apidocs/">JavaDocs</a></li>
                    <li><a href="/api/gen-docs/latest2/xref/">Cross-Reference 2</a></li>
                    <li><a href="/api/gen-docs/latest/xref/">Cross-Reference</a></li>
                    
                    <li><a href="/api/developer-guide.html">Developer Guide</a></li>
                    <li><a href="/api/internal-design-guide.html">Internal Guide</a></li>
                </ul>

                <h5>Support</h5>
<ul>
    <li><a href="/mailing-lists-and-irc.html">Mailing Lists &amp; IRC</a></li>
    <li><a href="/sources.html">Sources</a></li>
    <li><a href="/issue-tracking.html">Issue Tracking</a></li>
    <li><a href="/commercial-support.html">Commercial Support</a></li>
</ul>

<h5>Community</h5>
<ul>
    <li><a href="/contribute.html">How to Contribute</a></li>
    <li><a href="/team.html">Team</a></li>
    <li><a href="/original-project-proposal.html">Original Project Proposal</a></li>
    <li><a href="/special-thanks.html" class="external-link" rel="nofollow">Special Thanks</a></li>
</ul>

<h5>About Apache</h5>
<ul>
    <li><a href="http://www.apache.org/">Apache</a></li>
    <li><a href="http://www.apache.org/licenses/">License</a></li>
    <li><a href="http://www.apache.org/foundation/sponsorship.html">Sponsorship</a></li>
    <li><a href="http://www.apache.org/foundation/thanks.html">Thanks</a></li>
    <li><a href="http://www.apache.org/security/">Security</a></li>
</ul>

            </div>
        </div>
        <div id="rightColumn">
            
    <div class="nav">
        <div class="nav_prev">
            
                
                <a href="13-controls.html">13 - Controls</a>
            
        </div>
        <div class="nav_up">
            
                
                <a href="../internal-design-guide.html">Internal Design Guide</a>
            
        </div>
        <div class="nav_next">
            
                
                <a href="15-ldif.html">15 - LDIF</a>
            
        </div>
        <div class="clearfix"></div>
    </div>


            
	<h1 id="14---extended-operations">14 - Extended Operations</h1>
<p><strong>Extended Operation</strong> is a <strong>LDAP</strong> message which may content a payload. It is generally sent by the clinet, but the server can send a <em>ExtendedResponse</em> as a response to any operation : the <strong>Notice of Disconnection</strong>.</p>
<p>Here is the syntax for the extended Operation :</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Text" data-lang="Text">    ExtendedRequest ::= [APPLICATION 23] SEQUENCE {
        requestName      [0] LDAPOID,
        requestValue     [1] OCTET STRING OPTIONAL }

    ExtendedResponse ::= [APPLICATION 24] SEQUENCE {
        COMPONENTS OF LDAPResult,
        responseName     [10] LDAPOID OPTIONAL,
        responseValue    [11] OCTET STRING OPTIONAL }
</code></pre></div><p>(the payload is the <em>requestValue</em> or <em>responseValue</em> part, which may be <strong>BER</strong> encoded).</p>
<p>This message is routinely decoded as is by the standard <strong>LDAP</strong> message decoder, but the payload has to be decoded on its own.</p>
<h2 id="supported-extended-operations">Supported extended operations</h2>
<p>Currently, the <strong>LDAP API</strong> support the following extended operations :</p>
<ul>
<li><em>Cancel</em> request and response (<a href="https://tools.ietf.org/html/rfc3909">RFC 3909</a>)</li>
<li><em>CertGenerationRequest</em> request and response, an <strong>ApacheDS</strong> specific operation in charge of generating a certificate</li>
<li><em>GracefulDisconnect</em> response,  an <strong>ApacheDS</strong> specific operation used when the server is shutdown properly</li>
<li><em>GracefulShutdown</em> request and response, an <strong>ApacheDS</strong> specific operation used to shutdown the remote server properly</li>
<li><em>PasswordModify</em> request and response (<a href="https://tools.ietf.org/html/rfc3062">RFC 3062</a>)</li>
<li><em>StartTls</em> request and response (<a href="https://tools.ietf.org/html/rfc4511">RFC 4511</a>)</li>
<li><em>StoredProcedure</em> request and response, an <strong>ApacheDS</strong> specific operation used to execute a stored procedure on the server</li>
<li><em>WhoAmI</em> request and response (<a href="https://tools.ietf.org/html/rfc4532">RFC 4532</a>)</li>
</ul>
<h2 id="encoding-and-decoding">Encoding and decoding</h2>
<p>When the <em>requestValue</em> part is present, it has to be encoded (when the client sends the request to the srrver) or decoded ( when the client receives the response from the server).</p>
<h3 id="decoding-a-requestresponse">Decoding a request/response</h3>
<p>The payload is decoded on the fly when the request/response is processed during the <em>extendedRequest</em>/<em>extendedResponse</em> is being decoded. The <em>StoreExtendedRequestValue</em>/<em>StoreExtendedResponseValue</em> will store the <em>byte[]</em> - if any - and depending on the operation, the specific request/response will decode the value. Here is the <em>action</em> method for the <em>StoreExtendedRequestValue</em> class :</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java">    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">action</span><span style="color:#666">(</span> LdapMessageContainer<span style="color:#666">&lt;</span>ExtendedRequestDecorator<span style="color:#666">&lt;</span><span style="color:#666">?</span><span style="color:#666">&gt;</span><span style="color:#666">&gt;</span> container <span style="color:#666">)</span> <span style="color:#a2f;font-weight:bold">throws</span> DecoderException
    <span style="color:#666">{</span>
        <span style="color:#080;font-style:italic">// We can allocate the ExtendedRequest Object
</span><span style="color:#080;font-style:italic"></span>        ExtendedRequestDecorator<span style="color:#666">&lt;</span><span style="color:#666">?</span><span style="color:#666">&gt;</span> extendedRequest <span style="color:#666">=</span> container<span style="color:#666">.</span><span style="color:#b44">getMessage</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">;</span>

        <span style="color:#080;font-style:italic">// Get the Value and store it in the ExtendedRequest
</span><span style="color:#080;font-style:italic"></span>        TLV tlv <span style="color:#666">=</span> container<span style="color:#666">.</span><span style="color:#b44">getCurrentTLV</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">;</span>

        <span style="color:#080;font-style:italic">// We have to handle the special case of a 0 length matched
</span><span style="color:#080;font-style:italic"></span>        <span style="color:#080;font-style:italic">// value
</span><span style="color:#080;font-style:italic"></span>        <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span> tlv<span style="color:#666">.</span><span style="color:#b44">getLength</span><span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">=</span><span style="color:#666">=</span> 0 <span style="color:#666">)</span>
        <span style="color:#666">{</span>
            extendedRequest<span style="color:#666">.</span><span style="color:#b44">setRequestValue</span><span style="color:#666">(</span> Strings<span style="color:#666">.</span><span style="color:#b44">EMPTY_BYTES</span> <span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>
        <span style="color:#a2f;font-weight:bold">else</span>
        <span style="color:#666">{</span>
            extendedRequest<span style="color:#666">.</span><span style="color:#b44">setRequestValue</span><span style="color:#666">(</span> tlv<span style="color:#666">.</span><span style="color:#b44">getValue</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">getData</span><span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>
</code></pre></div><p>Each implementaion may have a <em>setRequestValue</em>/<em>setResponseValue</em> methd, overloading the parentclass. In this case, the value is decoded by the method.</p>
<p>Here is an example of <em>setRequestValue</em> implementation (for the <em>PasswordModifyRequest</em> class) :</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java">    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">setRequestValue</span><span style="color:#666">(</span> <span style="color:#0b0;font-weight:bold">byte</span><span style="color:#666">[</span><span style="color:#666">]</span> requestValue <span style="color:#666">)</span>
    <span style="color:#666">{</span>
        PasswordModifyRequestDecoder decoder <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">new</span> PasswordModifyRequestDecoder<span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">;</span>

        <span style="color:#a2f;font-weight:bold">try</span>
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span> requestValue <span style="color:#666">!</span><span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">null</span> <span style="color:#666">)</span>
            <span style="color:#666">{</span>
                passwordModifyRequest <span style="color:#666">=</span> decoder<span style="color:#666">.</span><span style="color:#b44">decode</span><span style="color:#666">(</span> requestValue <span style="color:#666">)</span><span style="color:#666">;</span>

                <span style="color:#a2f;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#b44">requestValue</span> <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">new</span> <span style="color:#0b0;font-weight:bold">byte</span><span style="color:#666">[</span>requestValue<span style="color:#666">.</span><span style="color:#b44">length</span><span style="color:#666">]</span><span style="color:#666">;</span>
                System<span style="color:#666">.</span><span style="color:#b44">arraycopy</span><span style="color:#666">(</span> requestValue<span style="color:#666">,</span> 0<span style="color:#666">,</span> <span style="color:#a2f;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#b44">requestValue</span><span style="color:#666">,</span> 0<span style="color:#666">,</span> requestValue<span style="color:#666">.</span><span style="color:#b44">length</span> <span style="color:#666">)</span><span style="color:#666">;</span>
            <span style="color:#666">}</span>
            <span style="color:#a2f;font-weight:bold">else</span>
            <span style="color:#666">{</span>
                <span style="color:#a2f;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#b44">requestValue</span> <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">null</span><span style="color:#666">;</span>
            <span style="color:#666">}</span>
        <span style="color:#666">}</span>
        <span style="color:#a2f;font-weight:bold">catch</span> <span style="color:#666">(</span> DecoderException e <span style="color:#666">)</span>
        <span style="color:#666">{</span>
            LOG<span style="color:#666">.</span><span style="color:#b44">error</span><span style="color:#666">(</span> I18n<span style="color:#666">.</span><span style="color:#b44">err</span><span style="color:#666">(</span> I18n<span style="color:#666">.</span><span style="color:#b44">ERR_04165</span> <span style="color:#666">)</span><span style="color:#666">,</span> e <span style="color:#666">)</span><span style="color:#666">;</span>
            <span style="color:#a2f;font-weight:bold">throw</span> <span style="color:#a2f;font-weight:bold">new</span> RuntimeException<span style="color:#666">(</span> e <span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>
    <span style="color:#666">}</span>
</code></pre></div><p>As we can see, the decoder is invoked if the <em>requestValue</em> bytes is not null. It instanciate a <em>PasswordModifyRequest</em>.</p>
<p>If there is no payload, the parent&rsquo;s method is invoked (which basically does nothing).</p>
<p>Here is a schema showing which request/response operations as a payload that needs to be decoded :</p>
<p><img src="images/extended-request-decorator.png" alt="Extended Operations Payload"></p>
<h3 id="encoding-a-requestresponse">Encoding a request/response</h3>
<p>Encoding is done through a <em>Decorator</em>. Each extended operation has a dedicated <em>Decorator</em>, which may have a specific encoding function. Again, as we only encode the payload, if this payload is absent, there is nothing to encode. Not all the extended operations have a payload.</p>
<p>If there is a payload to encode, this is done by calling the <em>getRequestValue()</em>/<em>getResponseValue()</em> method in the decorator. Here is an example :</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java">    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#0b0;font-weight:bold">byte</span><span style="color:#666">[</span><span style="color:#666">]</span> <span style="color:#00a000">getRequestValue</span><span style="color:#666">(</span><span style="color:#666">)</span>
    <span style="color:#666">{</span>
        <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span> requestValue <span style="color:#666">=</span><span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">null</span> <span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">try</span>
            <span style="color:#666">{</span>
                requestValue <span style="color:#666">=</span> encodeInternal<span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">array</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">;</span>
            <span style="color:#666">}</span>
            <span style="color:#a2f;font-weight:bold">catch</span> <span style="color:#666">(</span> EncoderException e <span style="color:#666">)</span>
            <span style="color:#666">{</span>
                LOG<span style="color:#666">.</span><span style="color:#b44">error</span><span style="color:#666">(</span> I18n<span style="color:#666">.</span><span style="color:#b44">err</span><span style="color:#666">(</span> I18n<span style="color:#666">.</span><span style="color:#b44">ERR_04167</span> <span style="color:#666">)</span><span style="color:#666">,</span> e <span style="color:#666">)</span><span style="color:#666">;</span>
                <span style="color:#a2f;font-weight:bold">throw</span> <span style="color:#a2f;font-weight:bold">new</span> RuntimeException<span style="color:#666">(</span> e <span style="color:#666">)</span><span style="color:#666">;</span>
            <span style="color:#666">}</span>
        <span style="color:#666">}</span>

        <span style="color:#a2f;font-weight:bold">return</span> requestValue<span style="color:#666">;</span>
    <span style="color:#666">}</span>
</code></pre></div><p>The <em>encodeInternal</em> method is in charge of encoding teh paylod.</p>
<p>If the <em>getRequestValue</em>/getResponseValue_ method is absent, that leans there is nothing to encode. The inherited method will be executed, which returns null.</p>
<p>Internally, we compute the length of the needed <strong>PDU</strong> accordingly to the data we have to encode, allocate a <em>ByteBuffer</em> to hold the encoded data, and store teh encoded data into it :</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java">    <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">     * Encodes the PasswordModifyRequest extended operation.
</span><span style="color:#080;font-style:italic">     * 
</span><span style="color:#080;font-style:italic">     * @return A ByteBuffer that contains the encoded PDU
</span><span style="color:#080;font-style:italic">     * @throws org.apache.directory.api.asn1.EncoderException If anything goes wrong.
</span><span style="color:#080;font-style:italic">     */</span>
    <span style="color:#080;font-style:italic">/* No qualifier */</span>ByteBuffer <span style="color:#00a000">encodeInternal</span><span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#a2f;font-weight:bold">throws</span> EncoderException
    <span style="color:#666">{</span>
        ByteBuffer bb <span style="color:#666">=</span> ByteBuffer<span style="color:#666">.</span><span style="color:#b44">allocate</span><span style="color:#666">(</span> computeLengthInternal<span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">)</span><span style="color:#666">;</span>

        bb<span style="color:#666">.</span><span style="color:#b44">put</span><span style="color:#666">(</span> UniversalTag<span style="color:#666">.</span><span style="color:#b44">SEQUENCE</span><span style="color:#666">.</span><span style="color:#b44">getValue</span><span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">)</span><span style="color:#666">;</span>
        bb<span style="color:#666">.</span><span style="color:#b44">put</span><span style="color:#666">(</span> TLV<span style="color:#666">.</span><span style="color:#b44">getBytes</span><span style="color:#666">(</span> requestLength <span style="color:#666">)</span> <span style="color:#666">)</span><span style="color:#666">;</span>

        <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span> passwordModifyRequest<span style="color:#666">.</span><span style="color:#b44">getUserIdentity</span><span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">!</span><span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">null</span> <span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#0b0;font-weight:bold">byte</span><span style="color:#666">[</span><span style="color:#666">]</span> userIdentity <span style="color:#666">=</span> passwordModifyRequest<span style="color:#666">.</span><span style="color:#b44">getUserIdentity</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">;</span>
            bb<span style="color:#666">.</span><span style="color:#b44">put</span><span style="color:#666">(</span> <span style="color:#666">(</span> <span style="color:#0b0;font-weight:bold">byte</span> <span style="color:#666">)</span> PasswordModifyRequestConstants<span style="color:#666">.</span><span style="color:#b44">USER_IDENTITY_TAG</span> <span style="color:#666">)</span><span style="color:#666">;</span>
            bb<span style="color:#666">.</span><span style="color:#b44">put</span><span style="color:#666">(</span> TLV<span style="color:#666">.</span><span style="color:#b44">getBytes</span><span style="color:#666">(</span> userIdentity<span style="color:#666">.</span><span style="color:#b44">length</span> <span style="color:#666">)</span> <span style="color:#666">)</span><span style="color:#666">;</span>
            bb<span style="color:#666">.</span><span style="color:#b44">put</span><span style="color:#666">(</span> userIdentity <span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>

        <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span> passwordModifyRequest<span style="color:#666">.</span><span style="color:#b44">getOldPassword</span><span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">!</span><span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">null</span> <span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#0b0;font-weight:bold">byte</span><span style="color:#666">[</span><span style="color:#666">]</span> oldPassword <span style="color:#666">=</span> passwordModifyRequest<span style="color:#666">.</span><span style="color:#b44">getOldPassword</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">;</span>
            bb<span style="color:#666">.</span><span style="color:#b44">put</span><span style="color:#666">(</span> <span style="color:#666">(</span> <span style="color:#0b0;font-weight:bold">byte</span> <span style="color:#666">)</span> PasswordModifyRequestConstants<span style="color:#666">.</span><span style="color:#b44">OLD_PASSWORD_TAG</span> <span style="color:#666">)</span><span style="color:#666">;</span>
            bb<span style="color:#666">.</span><span style="color:#b44">put</span><span style="color:#666">(</span> TLV<span style="color:#666">.</span><span style="color:#b44">getBytes</span><span style="color:#666">(</span> oldPassword<span style="color:#666">.</span><span style="color:#b44">length</span> <span style="color:#666">)</span> <span style="color:#666">)</span><span style="color:#666">;</span>
            bb<span style="color:#666">.</span><span style="color:#b44">put</span><span style="color:#666">(</span> oldPassword <span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>

        <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span> passwordModifyRequest<span style="color:#666">.</span><span style="color:#b44">getNewPassword</span><span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">!</span><span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">null</span> <span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#0b0;font-weight:bold">byte</span><span style="color:#666">[</span><span style="color:#666">]</span> newPassword <span style="color:#666">=</span> passwordModifyRequest<span style="color:#666">.</span><span style="color:#b44">getNewPassword</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">;</span>
            bb<span style="color:#666">.</span><span style="color:#b44">put</span><span style="color:#666">(</span> <span style="color:#666">(</span> <span style="color:#0b0;font-weight:bold">byte</span> <span style="color:#666">)</span> PasswordModifyRequestConstants<span style="color:#666">.</span><span style="color:#b44">NEW_PASSWORD_TAG</span> <span style="color:#666">)</span><span style="color:#666">;</span>
            bb<span style="color:#666">.</span><span style="color:#b44">put</span><span style="color:#666">(</span> TLV<span style="color:#666">.</span><span style="color:#b44">getBytes</span><span style="color:#666">(</span> newPassword<span style="color:#666">.</span><span style="color:#b44">length</span> <span style="color:#666">)</span> <span style="color:#666">)</span><span style="color:#666">;</span>
            bb<span style="color:#666">.</span><span style="color:#b44">put</span><span style="color:#666">(</span> newPassword <span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>

        <span style="color:#a2f;font-weight:bold">return</span> bb<span style="color:#666">;</span>
    <span style="color:#666">}</span>
</code></pre></div><p>and the <em>computeLength</em> method is :</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java">    <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">     * Compute the PasswordModifyRequest extended operation length
</span><span style="color:#080;font-style:italic">     * &lt;pre&gt;
</span><span style="color:#080;font-style:italic">     * 0x30 L1 
</span><span style="color:#080;font-style:italic">     *   | 
</span><span style="color:#080;font-style:italic">     *  [+-- 0x80 L2 userIdentity] 
</span><span style="color:#080;font-style:italic">     *  [+-- 0x81 L3 oldPassword] 
</span><span style="color:#080;font-style:italic">     *  [+-- 0x82 L4 newPassword] 
</span><span style="color:#080;font-style:italic">     * &lt;/pre&gt;
</span><span style="color:#080;font-style:italic">     */</span>
    <span style="color:#080;font-style:italic">/* No qualifier */</span><span style="color:#0b0;font-weight:bold">int</span> <span style="color:#00a000">computeLengthInternal</span><span style="color:#666">(</span><span style="color:#666">)</span>
    <span style="color:#666">{</span>
        requestLength <span style="color:#666">=</span> 0<span style="color:#666">;</span>

        <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span> passwordModifyRequest<span style="color:#666">.</span><span style="color:#b44">getUserIdentity</span><span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">!</span><span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">null</span> <span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#0b0;font-weight:bold">int</span> len <span style="color:#666">=</span> passwordModifyRequest<span style="color:#666">.</span><span style="color:#b44">getUserIdentity</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">length</span><span style="color:#666">;</span>
            requestLength <span style="color:#666">=</span> 1 <span style="color:#666">+</span> TLV<span style="color:#666">.</span><span style="color:#b44">getNbBytes</span><span style="color:#666">(</span> len <span style="color:#666">)</span> <span style="color:#666">+</span> len<span style="color:#666">;</span>
        <span style="color:#666">}</span>

        <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span> passwordModifyRequest<span style="color:#666">.</span><span style="color:#b44">getOldPassword</span><span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">!</span><span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">null</span> <span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#0b0;font-weight:bold">int</span> len <span style="color:#666">=</span> passwordModifyRequest<span style="color:#666">.</span><span style="color:#b44">getOldPassword</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">length</span><span style="color:#666">;</span>
            requestLength <span style="color:#666">+</span><span style="color:#666">=</span> 1 <span style="color:#666">+</span> TLV<span style="color:#666">.</span><span style="color:#b44">getNbBytes</span><span style="color:#666">(</span> len <span style="color:#666">)</span> <span style="color:#666">+</span> len<span style="color:#666">;</span>
        <span style="color:#666">}</span>

        <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span> passwordModifyRequest<span style="color:#666">.</span><span style="color:#b44">getNewPassword</span><span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">!</span><span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">null</span> <span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#0b0;font-weight:bold">int</span> len <span style="color:#666">=</span> passwordModifyRequest<span style="color:#666">.</span><span style="color:#b44">getNewPassword</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">length</span><span style="color:#666">;</span>
            requestLength <span style="color:#666">+</span><span style="color:#666">=</span> 1 <span style="color:#666">+</span> TLV<span style="color:#666">.</span><span style="color:#b44">getNbBytes</span><span style="color:#666">(</span> len <span style="color:#666">)</span> <span style="color:#666">+</span> len<span style="color:#666">;</span>
        <span style="color:#666">}</span>

        <span style="color:#a2f;font-weight:bold">return</span> 1 <span style="color:#666">+</span> TLV<span style="color:#666">.</span><span style="color:#b44">getNbBytes</span><span style="color:#666">(</span> requestLength <span style="color:#666">)</span> <span style="color:#666">+</span> requestLength<span style="color:#666">;</span>
    <span style="color:#666">}</span>
</code></pre></div><h2 id="adding-a-new-extended-operation">Adding a new Extended operation</h2>
<p>We will show how to add a new extended operation in the <strong>LDAP API</strong>. The added operation is the <em>startTransaction</em> operation, described in <a href="https://tools.ietf.org/html/rfc5805">RFC 5805</a>.</p>
<p>The <em>startTransactionRequest</em> has a <em>requestName</em> containing <strong>1.3.6.1.1.21.1</strong>, and no <em>requestValue</em>.
The <em>startTransactionResponse</em> has no <em>responseName</em> and a <em>responseValue</em> containing an opaque transaction identifier (ie, it does not need to be decoced).</p>
<p>We first need to declare an interface and implementation for each of those two operations. Those four elements are declared in the <em><coec-api></em> module (in <em>/ldap/extras/codec-api</em>), and in the <em>org.apache.directory.api.ldap.extras.extended.startTransaction</em> package, beside the other extended operations :</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java">    <span style="color:#a2f;font-weight:bold">package</span> <span style="color:#00f;font-weight:bold">org.apache.directory.api.ldap.extras.extended.startTransaction</span><span style="color:#666">;</span>


    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.apache.directory.api.ldap.model.message.ExtendedRequest</span><span style="color:#666">;</span>


    <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">     * The TransactionRequest interface. This is for the RFC 5805 Start Transaction Request,
</span><span style="color:#080;font-style:italic">     * which grammar is :
</span><span style="color:#080;font-style:italic">     * &lt;pre&gt;
</span><span style="color:#080;font-style:italic">     * ExtendedRequest ::= [APPLICATION 23] SEQUENCE {
</span><span style="color:#080;font-style:italic">     *              requestName      [0] LDAPOID,
</span><span style="color:#080;font-style:italic">     *              requestValue     [1] OCTET STRING OPTIONAL }
</span><span style="color:#080;font-style:italic">     * &lt;/pre&gt;
</span><span style="color:#080;font-style:italic">     * 
</span><span style="color:#080;font-style:italic">     * where &#39;requestName&#39; is 1.3.6.1.1.21.1 and requestValue is absent.
</span><span style="color:#080;font-style:italic">     *
</span><span style="color:#080;font-style:italic">     * @author &lt;a href=&#34;mailto:dev@directory.apache.org&#34;&gt;Apache Directory Project&lt;/a&gt;
</span><span style="color:#080;font-style:italic">     */</span>
    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#a2f;font-weight:bold">interface</span> <span style="color:#00f">StartTransactionRequest</span> <span style="color:#a2f;font-weight:bold">extends</span> ExtendedRequest
    <span style="color:#666">{</span>
        <span style="color:#080;font-style:italic">/** The OID for the Transaction extended operation request. */</span>
        String EXTENSION_OID <span style="color:#666">=</span> <span style="color:#b44">&#34;1.3.6.1.1.21.1&#34;</span><span style="color:#666">;</span>
    <span style="color:#666">}</span>
</code></pre></div><p>The request interface defines noting but the <em>OID</em>, as we don&rsquo;t have any payload.</p>
<p>Here is the implementation :</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java">    <span style="color:#a2f;font-weight:bold">package</span> <span style="color:#00f;font-weight:bold">org.apache.directory.api.ldap.extras.extended.startTransaction</span><span style="color:#666">;</span>


    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.apache.directory.api.ldap.model.message.AbstractExtendedRequest</span><span style="color:#666">;</span>


    <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">     * Implement the extended Start Transaction Request as described in RFC 5805.
</span><span style="color:#080;font-style:italic">     * 
</span><span style="color:#080;font-style:italic">     * It&#39;s grammar is :
</span><span style="color:#080;font-style:italic">     * 
</span><span style="color:#080;font-style:italic">     * &lt;pre&gt;
</span><span style="color:#080;font-style:italic">     * ExtendedRequest ::= [APPLICATION 23] SEQUENCE {
</span><span style="color:#080;font-style:italic">     *              requestName      [0] LDAPOID,
</span><span style="color:#080;font-style:italic">     *              requestValue     [1] OCTET STRING OPTIONAL }
</span><span style="color:#080;font-style:italic">     * &lt;/pre&gt;
</span><span style="color:#080;font-style:italic">     * 
</span><span style="color:#080;font-style:italic">     * where &#39;requestName&#39; is 1.3.6.1.1.21.1 and requestValue is absent.
</span><span style="color:#080;font-style:italic">     *
</span><span style="color:#080;font-style:italic">     * @author &lt;a href=&#34;mailto:dev@directory.apache.org&#34;&gt;Apache Directory Project&lt;/a&gt;
</span><span style="color:#080;font-style:italic">     */</span>
    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#a2f;font-weight:bold">class</span> <span style="color:#00f">StartTransactionRequestImpl</span> <span style="color:#a2f;font-weight:bold">extends</span> AbstractExtendedRequest <span style="color:#a2f;font-weight:bold">implements</span> StartTransactionRequest
    <span style="color:#666">{</span>
        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * Creates a new instance of StartTransactionRequestImpl.
</span><span style="color:#080;font-style:italic">         *
</span><span style="color:#080;font-style:italic">         * @param messageId the message id
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#00a000">StartTransactionRequestImpl</span><span style="color:#666">(</span> <span style="color:#0b0;font-weight:bold">int</span> messageId <span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">super</span><span style="color:#666">(</span> messageId <span style="color:#666">)</span><span style="color:#666">;</span>
            setRequestName<span style="color:#666">(</span> EXTENSION_OID <span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * Creates a new instance of StartTransactionRequestImpl.
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#00a000">StartTransactionRequestImpl</span><span style="color:#666">(</span><span style="color:#666">)</span>
        <span style="color:#666">{</span>
            setRequestName<span style="color:#666">(</span> EXTENSION_OID <span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * {@inheritDoc}
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f">@Override</span>
        <span style="color:#a2f;font-weight:bold">public</span> StartTransactionResponse <span style="color:#00a000">getResultResponse</span><span style="color:#666">(</span><span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span> getResponse<span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">=</span><span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">null</span> <span style="color:#666">)</span>
            <span style="color:#666">{</span>
                setResponse<span style="color:#666">(</span> <span style="color:#a2f;font-weight:bold">new</span> StartTransactionResponseImpl<span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">)</span><span style="color:#666">;</span>
            <span style="color:#666">}</span>

            <span style="color:#a2f;font-weight:bold">return</span> <span style="color:#666">(</span> StartTransactionResponse <span style="color:#666">)</span> getResponse<span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>
    <span style="color:#666">}</span>
</code></pre></div><p>We just implement the method that returns the associated response.</p>
<p>Now for the response, which has an opaque value, here is the interface :</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java">    <span style="color:#a2f;font-weight:bold">package</span> <span style="color:#00f;font-weight:bold">org.apache.directory.api.ldap.extras.extended.startTransaction</span><span style="color:#666">;</span>


    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.apache.directory.api.ldap.model.message.ExtendedResponse</span><span style="color:#666">;</span>


    <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">     * The interface for Start Transaction Extended Response. It&#39;s described in RFC 5805 :
</span><span style="color:#080;font-style:italic">     * 
</span><span style="color:#080;font-style:italic">     * &lt;pre&gt;
</span><span style="color:#080;font-style:italic">     * ExtendedResponse ::= [APPLICATION 24] SEQUENCE {
</span><span style="color:#080;font-style:italic">     *            COMPONENTS OF LDAPResult,
</span><span style="color:#080;font-style:italic">     *            responseName     [10] LDAPOID OPTIONAL,
</span><span style="color:#080;font-style:italic">     *            responseValue    [11] OCTET STRING OPTIONAL }
</span><span style="color:#080;font-style:italic">     * &lt;/pre&gt;
</span><span style="color:#080;font-style:italic">     * 
</span><span style="color:#080;font-style:italic">     * where the responseName is not present, and the responseValue contain
</span><span style="color:#080;font-style:italic">     * a transaction identifier when the result is SUCCESS.
</span><span style="color:#080;font-style:italic">     * 
</span><span style="color:#080;font-style:italic">     * @author &lt;a href=&#34;mailto:dev@directory.apache.org&#34;&gt;Apache Directory Project&lt;/a&gt;
</span><span style="color:#080;font-style:italic">     */</span>
    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#a2f;font-weight:bold">interface</span> <span style="color:#00f">StartTransactionResponse</span> <span style="color:#a2f;font-weight:bold">extends</span> ExtendedResponse
    <span style="color:#666">{</span>
        <span style="color:#080;font-style:italic">/** The OID for the Start Transaction extended operation response. */</span>
        String EXTENSION_OID <span style="color:#666">=</span> StartTransactionRequest<span style="color:#666">.</span><span style="color:#b44">EXTENSION_OID</span><span style="color:#666">;</span>
        
        
        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * @return The transaction ID if success
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#0b0;font-weight:bold">byte</span><span style="color:#666">[</span><span style="color:#666">]</span> <span style="color:#00a000">getTransactionId</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">;</span>
    <span style="color:#666">}</span>
</code></pre></div><p>As the response value is opaque, we return it as a <em>byte[]</em>.</p>
<p>Here is the implementation :</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java">    <span style="color:#a2f;font-weight:bold">package</span> <span style="color:#00f;font-weight:bold">org.apache.directory.api.ldap.extras.extended.startTransaction</span><span style="color:#666">;</span>


    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.apache.directory.api.i18n.I18n</span><span style="color:#666">;</span>
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.apache.directory.api.ldap.model.message.ExtendedResponseImpl</span><span style="color:#666">;</span>
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.apache.directory.api.ldap.model.message.ResultCodeEnum</span><span style="color:#666">;</span>
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.apache.directory.api.util.Strings</span><span style="color:#666">;</span>


    <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">     * The interface for Start Transaction Extended Response. It&#39;s described in RFC 5805 :
</span><span style="color:#080;font-style:italic">     * 
</span><span style="color:#080;font-style:italic">     * &lt;pre&gt;
</span><span style="color:#080;font-style:italic">     * ExtendedResponse ::= [APPLICATION 24] SEQUENCE {
</span><span style="color:#080;font-style:italic">     *            COMPONENTS OF LDAPResult,
</span><span style="color:#080;font-style:italic">     *            responseName     [10] LDAPOID OPTIONAL,
</span><span style="color:#080;font-style:italic">     *            responseValue    [11] OCTET STRING OPTIONAL }
</span><span style="color:#080;font-style:italic">     * &lt;/pre&gt;
</span><span style="color:#080;font-style:italic">     * 
</span><span style="color:#080;font-style:italic">     * where the responseName is not present, and the responseValue contain
</span><span style="color:#080;font-style:italic">     * a transaction identifier when the result is SUCCESS.
</span><span style="color:#080;font-style:italic">     * 
</span><span style="color:#080;font-style:italic">     *
</span><span style="color:#080;font-style:italic">     * @author &lt;a href=&#34;mailto:dev@directory.apache.org&#34;&gt;Apache Directory Project&lt;/a&gt;
</span><span style="color:#080;font-style:italic">     */</span>
    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#a2f;font-weight:bold">class</span> <span style="color:#00f">StartTransactionResponseImpl</span> <span style="color:#a2f;font-weight:bold">extends</span> ExtendedResponseImpl <span style="color:#a2f;font-weight:bold">implements</span> StartTransactionResponse
    <span style="color:#666">{</span>
        <span style="color:#080;font-style:italic">/** The transaction ID if the request was successful */</span>
        <span style="color:#a2f;font-weight:bold">private</span> <span style="color:#0b0;font-weight:bold">byte</span><span style="color:#666">[</span><span style="color:#666">]</span> transactionId<span style="color:#666">;</span>
        
        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * Create a new StartTransactionResponseImpl object
</span><span style="color:#080;font-style:italic">         * 
</span><span style="color:#080;font-style:italic">         * @param messageId The messageId
</span><span style="color:#080;font-style:italic">         * @param rcode the result code
</span><span style="color:#080;font-style:italic">         * @param transactionId The transaction ID 
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#00a000">StartTransactionResponseImpl</span><span style="color:#666">(</span> <span style="color:#0b0;font-weight:bold">int</span> messageId<span style="color:#666">,</span> ResultCodeEnum resultCode<span style="color:#666">,</span> <span style="color:#0b0;font-weight:bold">byte</span><span style="color:#666">[</span><span style="color:#666">]</span> transactionId <span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">super</span><span style="color:#666">(</span> messageId <span style="color:#666">)</span><span style="color:#666">;</span>

            <span style="color:#a2f;font-weight:bold">switch</span> <span style="color:#666">(</span> resultCode <span style="color:#666">)</span>
            <span style="color:#666">{</span>
                <span style="color:#a2f;font-weight:bold">case</span> SUCCESS<span style="color:#666">:</span>
                    <span style="color:#a2f;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#b44">transactionId</span> <span style="color:#666">=</span> Strings<span style="color:#666">.</span><span style="color:#b44">copy</span><span style="color:#666">(</span> transactionId <span style="color:#666">)</span><span style="color:#666">;</span>
                    <span style="color:#080;font-style:italic">// pass through ...
</span><span style="color:#080;font-style:italic"></span>                <span style="color:#a2f;font-weight:bold">case</span> CANCELED<span style="color:#666">:</span>
                <span style="color:#a2f;font-weight:bold">case</span> CANNOT_CANCEL<span style="color:#666">:</span>
                <span style="color:#a2f;font-weight:bold">case</span> NO_SUCH_OPERATION<span style="color:#666">:</span>
                <span style="color:#a2f;font-weight:bold">case</span> TOO_LATE<span style="color:#666">:</span>
                    <span style="color:#a2f;font-weight:bold">break</span><span style="color:#666">;</span>
<span style="color:#a0a000">
</span><span style="color:#a0a000">                default:</span>
                    <span style="color:#a2f;font-weight:bold">throw</span> <span style="color:#a2f;font-weight:bold">new</span> IllegalArgumentException<span style="color:#666">(</span> I18n<span style="color:#666">.</span><span style="color:#b44">err</span><span style="color:#666">(</span> I18n<span style="color:#666">.</span><span style="color:#b44">ERR_04166</span><span style="color:#666">,</span> ResultCodeEnum<span style="color:#666">.</span><span style="color:#b44">SUCCESS</span><span style="color:#666">,</span>
                        ResultCodeEnum<span style="color:#666">.</span><span style="color:#b44">OPERATIONS_ERROR</span><span style="color:#666">,</span> ResultCodeEnum<span style="color:#666">.</span><span style="color:#b44">INSUFFICIENT_ACCESS_RIGHTS</span> <span style="color:#666">)</span> <span style="color:#666">)</span><span style="color:#666">;</span>
            <span style="color:#666">}</span>

            <span style="color:#a2f;font-weight:bold">super</span><span style="color:#666">.</span><span style="color:#b44">getLdapResult</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">setMatchedDn</span><span style="color:#666">(</span> <span style="color:#a2f;font-weight:bold">null</span> <span style="color:#666">)</span><span style="color:#666">;</span>
            <span style="color:#a2f;font-weight:bold">super</span><span style="color:#666">.</span><span style="color:#b44">getLdapResult</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">setResultCode</span><span style="color:#666">(</span> resultCode <span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * Create a new StartTransactionResponseImpl instance
</span><span style="color:#080;font-style:italic">         * 
</span><span style="color:#080;font-style:italic">         * @param messageId The request&#39;s messageId
</span><span style="color:#080;font-style:italic">         * @param transactionId The transaction ID 
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#00a000">StartTransactionResponseImpl</span><span style="color:#666">(</span> <span style="color:#0b0;font-weight:bold">int</span> messageId<span style="color:#666">,</span> <span style="color:#0b0;font-weight:bold">byte</span><span style="color:#666">[</span><span style="color:#666">]</span> transactionId <span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">super</span><span style="color:#666">(</span> messageId <span style="color:#666">)</span><span style="color:#666">;</span>
            <span style="color:#a2f;font-weight:bold">super</span><span style="color:#666">.</span><span style="color:#b44">getLdapResult</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">setMatchedDn</span><span style="color:#666">(</span> <span style="color:#a2f;font-weight:bold">null</span> <span style="color:#666">)</span><span style="color:#666">;</span>
            <span style="color:#a2f;font-weight:bold">super</span><span style="color:#666">.</span><span style="color:#b44">getLdapResult</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">setResultCode</span><span style="color:#666">(</span> ResultCodeEnum<span style="color:#666">.</span><span style="color:#b44">SUCCESS</span> <span style="color:#666">)</span><span style="color:#666">;</span>
            <span style="color:#a2f;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#b44">transactionId</span> <span style="color:#666">=</span> Strings<span style="color:#666">.</span><span style="color:#b44">copy</span><span style="color:#666">(</span> transactionId <span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * Create a new StartTransactionResponseImpl instance
</span><span style="color:#080;font-style:italic">         * 
</span><span style="color:#080;font-style:italic">         * @param transactionId The transaction ID 
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#00a000">StartTransactionResponseImpl</span><span style="color:#666">(</span> <span style="color:#0b0;font-weight:bold">byte</span><span style="color:#666">[</span><span style="color:#666">]</span> transactionId <span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">super</span><span style="color:#666">(</span> StartTransactionRequest<span style="color:#666">.</span><span style="color:#b44">EXTENSION_OID</span> <span style="color:#666">)</span><span style="color:#666">;</span>
            <span style="color:#a2f;font-weight:bold">super</span><span style="color:#666">.</span><span style="color:#b44">getLdapResult</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">setMatchedDn</span><span style="color:#666">(</span> <span style="color:#a2f;font-weight:bold">null</span> <span style="color:#666">)</span><span style="color:#666">;</span>
            <span style="color:#a2f;font-weight:bold">super</span><span style="color:#666">.</span><span style="color:#b44">getLdapResult</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">setResultCode</span><span style="color:#666">(</span> ResultCodeEnum<span style="color:#666">.</span><span style="color:#b44">SUCCESS</span> <span style="color:#666">)</span><span style="color:#666">;</span>
            <span style="color:#a2f;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#b44">transactionId</span> <span style="color:#666">=</span> Strings<span style="color:#666">.</span><span style="color:#b44">copy</span><span style="color:#666">(</span> transactionId <span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * Create a new StartTransactionResponseImpl instance
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#00a000">StartTransactionResponseImpl</span><span style="color:#666">(</span><span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">super</span><span style="color:#666">(</span> StartTransactionRequest<span style="color:#666">.</span><span style="color:#b44">EXTENSION_OID</span> <span style="color:#666">)</span><span style="color:#666">;</span>
            <span style="color:#a2f;font-weight:bold">super</span><span style="color:#666">.</span><span style="color:#b44">getLdapResult</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">setMatchedDn</span><span style="color:#666">(</span> <span style="color:#a2f;font-weight:bold">null</span> <span style="color:#666">)</span><span style="color:#666">;</span>
            <span style="color:#a2f;font-weight:bold">super</span><span style="color:#666">.</span><span style="color:#b44">getLdapResult</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">setResultCode</span><span style="color:#666">(</span> ResultCodeEnum<span style="color:#666">.</span><span style="color:#b44">UNWILLING_TO_PERFORM</span> <span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * Gets the OID uniquely identifying this extended response (a.k.a. its
</span><span style="color:#080;font-style:italic">         * name). It&#39;s a null value for the Cancel response
</span><span style="color:#080;font-style:italic">         * 
</span><span style="color:#080;font-style:italic">         * @return the OID of the extended response type.
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f">@Override</span>
        <span style="color:#a2f;font-weight:bold">public</span> String <span style="color:#00a000">getResponseName</span><span style="color:#666">(</span><span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">return</span> <span style="color:#b44">&#34;&#34;</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * {@inheritDoc}
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f">@Override</span>
        <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#0b0;font-weight:bold">int</span> <span style="color:#00a000">hashCode</span><span style="color:#666">(</span><span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#0b0;font-weight:bold">int</span> hash <span style="color:#666">=</span> 37<span style="color:#666">;</span>
            
            <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span> transactionId <span style="color:#666">!</span><span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">null</span> <span style="color:#666">)</span>
            <span style="color:#666">{</span>
                <span style="color:#a2f;font-weight:bold">for</span> <span style="color:#666">(</span> <span style="color:#0b0;font-weight:bold">byte</span> b <span style="color:#666">:</span> transactionId <span style="color:#666">)</span>
                <span style="color:#666">{</span>
                    hash <span style="color:#666">+</span><span style="color:#666">=</span> hash <span style="color:#666">*</span> 17 <span style="color:#666">+</span> b<span style="color:#666">;</span>
                <span style="color:#666">}</span>
            <span style="color:#666">}</span>
            
            hash <span style="color:#666">=</span> hash <span style="color:#666">*</span> 17 <span style="color:#666">+</span> getClass<span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">getName</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">hashCode</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">;</span>

            <span style="color:#a2f;font-weight:bold">return</span> hash<span style="color:#666">;</span>
        <span style="color:#666">}</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * @see Object#equals(Object)
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f">@Override</span>
        <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#0b0;font-weight:bold">boolean</span> <span style="color:#00a000">equals</span><span style="color:#666">(</span> Object obj <span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span> obj <span style="color:#666">=</span><span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">this</span> <span style="color:#666">)</span>
            <span style="color:#666">{</span>
                <span style="color:#a2f;font-weight:bold">return</span> <span style="color:#a2f;font-weight:bold">true</span><span style="color:#666">;</span>
            <span style="color:#666">}</span>

            <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span> <span style="color:#666">!</span><span style="color:#666">(</span> obj <span style="color:#a2f;font-weight:bold">instanceof</span> StartTransactionResponseImpl <span style="color:#666">)</span> <span style="color:#666">)</span>
            <span style="color:#666">{</span>
                <span style="color:#a2f;font-weight:bold">return</span> <span style="color:#a2f;font-weight:bold">false</span><span style="color:#666">;</span>
            <span style="color:#666">}</span>
            
            <span style="color:#a2f;font-weight:bold">return</span> Arrays<span style="color:#666">.</span><span style="color:#b44">equals</span><span style="color:#666">(</span> transactionId<span style="color:#666">,</span> <span style="color:#666">(</span> <span style="color:#666">(</span> StartTransactionResponseImpl <span style="color:#666">)</span> obj <span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">transactionId</span> <span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>
        
        
        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * {@inheritDoc}
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f">@Override</span>
        <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#0b0;font-weight:bold">byte</span><span style="color:#666">[</span><span style="color:#666">]</span> <span style="color:#00a000">getTransactionId</span><span style="color:#666">(</span><span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">return</span> Strings<span style="color:#666">.</span><span style="color:#b44">copy</span><span style="color:#666">(</span> transactionId <span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>
        
        
        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * {@inheritDoc}
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">setTransactionId</span><span style="color:#666">(</span> <span style="color:#0b0;font-weight:bold">byte</span><span style="color:#666">[</span><span style="color:#666">]</span> transactionId <span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#b44">transactionId</span> <span style="color:#666">=</span> Strings<span style="color:#666">.</span><span style="color:#b44">copy</span><span style="color:#666">(</span> transactionId <span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>
    <span style="color:#666">}</span>
</code></pre></div><p>There is nothing special in this implementation, we just make it so the <em>transactionId</em> bytes are copied to be sure they can&rsquo;t be altered from the outside. Basically, the payload is transfered pristine into the instance.</p>
<p>Now that we have the interfaces and implementations, we need to add the decorators and the factory. The factory is used to initialize the <strong>API</strong> with the list of available extended operaiton at startup, as a mean to make the <strong>API</strong> extensible. It creates request and response, and the associated decorator.</p>
<p>Here is the factory code, declared in the <em><extra-codec></em> module :</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java">    <span style="color:#a2f;font-weight:bold">package</span> <span style="color:#00f;font-weight:bold">org.apache.directory.api.ldap.extras.extended.ads_impl.startTransaction</span><span style="color:#666">;</span>


    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.apache.directory.api.asn1.DecoderException</span><span style="color:#666">;</span>
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.apache.directory.api.ldap.codec.api.ExtendedOperationFactory</span><span style="color:#666">;</span>
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.apache.directory.api.ldap.codec.api.LdapApiService</span><span style="color:#666">;</span>
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.apache.directory.api.ldap.extras.extended.cancel.CancelRequest</span><span style="color:#666">;</span>
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.apache.directory.api.ldap.extras.extended.startTransaction.StartTransactionRequest</span><span style="color:#666">;</span>
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.apache.directory.api.ldap.extras.extended.startTransaction.StartTransactionRequestImpl</span><span style="color:#666">;</span>
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.apache.directory.api.ldap.extras.extended.startTransaction.StartTransactionResponse</span><span style="color:#666">;</span>
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.apache.directory.api.ldap.extras.extended.startTransaction.StartTransactionResponseImpl</span><span style="color:#666">;</span>
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.apache.directory.api.ldap.model.message.ExtendedRequest</span><span style="color:#666">;</span>
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.apache.directory.api.ldap.model.message.ExtendedResponse</span><span style="color:#666">;</span>


    <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">     * An {@link ExtendedOperationFactory} for creating cancel extended request response 
</span><span style="color:#080;font-style:italic">     * pairs.
</span><span style="color:#080;font-style:italic">     *
</span><span style="color:#080;font-style:italic">     * @author &lt;a href=&#34;mailto:dev@directory.apache.org&#34;&gt;Apache Directory Project&lt;/a&gt;
</span><span style="color:#080;font-style:italic">     */</span>
    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#a2f;font-weight:bold">class</span> <span style="color:#00f">StartTransactionFactory</span> <span style="color:#a2f;font-weight:bold">implements</span> ExtendedOperationFactory
    <span style="color:#666">{</span>
        <span style="color:#a2f;font-weight:bold">private</span> LdapApiService codec<span style="color:#666">;</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * Creates a new instance of CancelFactory.
</span><span style="color:#080;font-style:italic">         *
</span><span style="color:#080;font-style:italic">         * @param codec The codec for this factory.
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#00a000">StartTransactionFactory</span><span style="color:#666">(</span> LdapApiService codec <span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#b44">codec</span> <span style="color:#666">=</span> codec<span style="color:#666">;</span>
        <span style="color:#666">}</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * {@inheritDoc}
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f">@Override</span>
        <span style="color:#a2f;font-weight:bold">public</span> String <span style="color:#00a000">getOid</span><span style="color:#666">(</span><span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">return</span> CancelRequest<span style="color:#666">.</span><span style="color:#b44">EXTENSION_OID</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * {@inheritDoc}
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f">@Override</span>
        <span style="color:#a2f;font-weight:bold">public</span> StartTransactionResponse <span style="color:#00a000">newResponse</span><span style="color:#666">(</span> <span style="color:#0b0;font-weight:bold">byte</span><span style="color:#666">[</span><span style="color:#666">]</span> encodedValue <span style="color:#666">)</span> <span style="color:#a2f;font-weight:bold">throws</span> DecoderException
        <span style="color:#666">{</span>
            StartTransactionResponseDecorator response <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">new</span> StartTransactionResponseDecorator<span style="color:#666">(</span> codec<span style="color:#666">,</span> <span style="color:#a2f;font-weight:bold">new</span> StartTransactionResponseImpl<span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">)</span><span style="color:#666">;</span>
            response<span style="color:#666">.</span><span style="color:#b44">setResponseValue</span><span style="color:#666">(</span> encodedValue <span style="color:#666">)</span><span style="color:#666">;</span>

            <span style="color:#a2f;font-weight:bold">return</span> response<span style="color:#666">;</span>
        <span style="color:#666">}</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * {@inheritDoc}
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f">@Override</span>
        <span style="color:#a2f;font-weight:bold">public</span> StartTransactionRequest <span style="color:#00a000">newRequest</span><span style="color:#666">(</span> <span style="color:#0b0;font-weight:bold">byte</span><span style="color:#666">[</span><span style="color:#666">]</span> value <span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">return</span> <span style="color:#a2f;font-weight:bold">new</span> StartTransactionRequestDecorator<span style="color:#666">(</span> codec<span style="color:#666">,</span> <span style="color:#a2f;font-weight:bold">new</span> StartTransactionRequestImpl<span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * {@inheritDoc}
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f">@Override</span>
        <span style="color:#a2f;font-weight:bold">public</span> StartTransactionRequestDecorator <span style="color:#00a000">decorate</span><span style="color:#666">(</span> ExtendedRequest modelRequest <span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span> modelRequest <span style="color:#a2f;font-weight:bold">instanceof</span> StartTransactionRequestDecorator <span style="color:#666">)</span>
            <span style="color:#666">{</span>
                <span style="color:#a2f;font-weight:bold">return</span> <span style="color:#666">(</span> StartTransactionRequestDecorator <span style="color:#666">)</span> modelRequest<span style="color:#666">;</span>
            <span style="color:#666">}</span>

            <span style="color:#a2f;font-weight:bold">return</span> <span style="color:#a2f;font-weight:bold">new</span> StartTransactionRequestDecorator<span style="color:#666">(</span> codec<span style="color:#666">,</span> <span style="color:#a2f;font-weight:bold">null</span> <span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * {@inheritDoc}
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f">@Override</span>
        <span style="color:#a2f;font-weight:bold">public</span> StartTransactionResponseDecorator <span style="color:#00a000">decorate</span><span style="color:#666">(</span> ExtendedResponse decoratedMessage <span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span> decoratedMessage <span style="color:#a2f;font-weight:bold">instanceof</span> StartTransactionResponseDecorator <span style="color:#666">)</span>
            <span style="color:#666">{</span>
                <span style="color:#a2f;font-weight:bold">return</span> <span style="color:#666">(</span> StartTransactionResponseDecorator <span style="color:#666">)</span> decoratedMessage<span style="color:#666">;</span>
            <span style="color:#666">}</span>

            <span style="color:#a2f;font-weight:bold">return</span> <span style="color:#a2f;font-weight:bold">new</span> StartTransactionResponseDecorator<span style="color:#666">(</span> codec<span style="color:#666">,</span> <span style="color:#a2f;font-weight:bold">null</span> <span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>
    <span style="color:#666">}</span>
</code></pre></div><p>The decorator are very simple : they just encapsulate the requets or response instance. It&rsquo;s because encoding or decoding is non existant for this operation. Decorators are declared in the <em><extra-codec></em> module.</p>
<p>Here is teh code for both those decorators :</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java">    <span style="color:#a2f;font-weight:bold">package</span> <span style="color:#00f;font-weight:bold">org.apache.directory.api.ldap.extras.extended.ads_impl.startTransaction</span><span style="color:#666">;</span>


    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.apache.directory.api.ldap.codec.api.ExtendedRequestDecorator</span><span style="color:#666">;</span>
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.apache.directory.api.ldap.codec.api.LdapApiService</span><span style="color:#666">;</span>
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.apache.directory.api.ldap.extras.extended.startTransaction.StartTransactionRequest</span><span style="color:#666">;</span>
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.apache.directory.api.ldap.extras.extended.startTransaction.StartTransactionResponse</span><span style="color:#666">;</span>


    <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">     * A Decorator for startTransaction request.
</span><span style="color:#080;font-style:italic">     *
</span><span style="color:#080;font-style:italic">     * @author &lt;a href=&#34;mailto:dev@directory.apache.org&#34;&gt;Apache Directory Project&lt;/a&gt;
</span><span style="color:#080;font-style:italic">     */</span>
    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#a2f;font-weight:bold">class</span> <span style="color:#00f">StartTransactionRequestDecorator</span> <span style="color:#a2f;font-weight:bold">extends</span> ExtendedRequestDecorator<span style="color:#666">&lt;</span>StartTransactionRequest<span style="color:#666">&gt;</span> <span style="color:#a2f;font-weight:bold">implements</span>
        StartTransactionRequest
    <span style="color:#666">{</span>
        <span style="color:#080;font-style:italic">/** The internal startTransaction request */</span>
        <span style="color:#a2f;font-weight:bold">private</span> StartTransactionRequest startTransactionRequest<span style="color:#666">;</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * Creates a new instance of StartTransactionRequestDecorator.
</span><span style="color:#080;font-style:italic">         * 
</span><span style="color:#080;font-style:italic">         * @param codec The LDAP Service to use
</span><span style="color:#080;font-style:italic">         * @param decoratedMessage The canceled request
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#00a000">StartTransactionRequestDecorator</span><span style="color:#666">(</span> LdapApiService codec<span style="color:#666">,</span> StartTransactionRequest decoratedMessage <span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">super</span><span style="color:#666">(</span> codec<span style="color:#666">,</span> decoratedMessage <span style="color:#666">)</span><span style="color:#666">;</span>
            startTransactionRequest <span style="color:#666">=</span> decoratedMessage<span style="color:#666">;</span>
        <span style="color:#666">}</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * {@inheritDoc}
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f">@Override</span>
        <span style="color:#a2f;font-weight:bold">public</span> StartTransactionResponse <span style="color:#00a000">getResultResponse</span><span style="color:#666">(</span><span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">return</span> <span style="color:#666">(</span> StartTransactionResponse <span style="color:#666">)</span> startTransactionRequest<span style="color:#666">.</span><span style="color:#b44">getResultResponse</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>
    <span style="color:#666">}</span>
</code></pre></div><p>and for the response :</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java">    <span style="color:#a2f;font-weight:bold">package</span> <span style="color:#00f;font-weight:bold">org.apache.directory.api.ldap.extras.extended.ads_impl.startTransaction</span><span style="color:#666">;</span>


    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.apache.directory.api.ldap.codec.api.ExtendedResponseDecorator</span><span style="color:#666">;</span>
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.apache.directory.api.ldap.codec.api.LdapApiService</span><span style="color:#666">;</span>
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.apache.directory.api.ldap.extras.extended.startTransaction.StartTransactionResponse</span><span style="color:#666">;</span>
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.apache.directory.api.util.Strings</span><span style="color:#666">;</span>


    <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">     * A Decorator for CancelResponses.
</span><span style="color:#080;font-style:italic">     *
</span><span style="color:#080;font-style:italic">     * @author &lt;a href=&#34;mailto:dev@directory.apache.org&#34;&gt;Apache Directory Project&lt;/a&gt;
</span><span style="color:#080;font-style:italic">     */</span>
    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#a2f;font-weight:bold">class</span> <span style="color:#00f">StartTransactionResponseDecorator</span> <span style="color:#a2f;font-weight:bold">extends</span> ExtendedResponseDecorator<span style="color:#666">&lt;</span>StartTransactionResponse<span style="color:#666">&gt;</span> <span style="color:#a2f;font-weight:bold">implements</span> StartTransactionResponse
    <span style="color:#666">{</span>
        <span style="color:#080;font-style:italic">/** The startTransaction response */</span>
        <span style="color:#a2f;font-weight:bold">private</span> StartTransactionResponse startTransactionResponse<span style="color:#666">;</span>

        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * Creates a new instance of CancelResponseDecorator.
</span><span style="color:#080;font-style:italic">         *
</span><span style="color:#080;font-style:italic">         * @param codec The LDAP service instance
</span><span style="color:#080;font-style:italic">         * @param decoratedMessage The decorated message
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#00a000">StartTransactionResponseDecorator</span><span style="color:#666">(</span> LdapApiService codec<span style="color:#666">,</span> StartTransactionResponse decoratedMessage <span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">super</span><span style="color:#666">(</span> codec<span style="color:#666">,</span> decoratedMessage <span style="color:#666">)</span><span style="color:#666">;</span>
            startTransactionResponse <span style="color:#666">=</span> decoratedMessage<span style="color:#666">;</span>
        <span style="color:#666">}</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * {@inheritDoc}
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f">@Override</span>
        <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">setResponseValue</span><span style="color:#666">(</span> <span style="color:#0b0;font-weight:bold">byte</span><span style="color:#666">[</span><span style="color:#666">]</span> responseValue <span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#b44">responseValue</span> <span style="color:#666">=</span> Strings<span style="color:#666">.</span><span style="color:#b44">copy</span><span style="color:#666">(</span> responseValue <span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * {@inheritDoc}
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f">@Override</span>
        <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#0b0;font-weight:bold">byte</span><span style="color:#666">[</span><span style="color:#666">]</span> <span style="color:#00a000">getTransactionId</span><span style="color:#666">(</span><span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">return</span> startTransactionResponse<span style="color:#666">.</span><span style="color:#b44">getTransactionId</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>
    <span style="color:#666">}</span>
</code></pre></div><p>The last step is to declare the extended operation in the <strong>LDAP API</strong> initialization and <strong>OSGi</strong>. There are two places we have to declare the factory :</p>
<ul>
<li><em>CodecFactoryUtil</em> class, in the <em>&lt;ldap/codec/standalone&gt;</em> module</li>
<li><em>ExtrasBundleActivator</em> class, in the <em>&lt;ldap/extras/codec&gt;</em> module</li>
</ul>
<p>Here is the added code in the <em>CodecFactoryUtil</em> class :</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java">    <span style="color:#666">.</span><span style="color:#666">.</span><span style="color:#666">.</span>
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.apache.directory.api.ldap.extras.extended.ads_impl.startTls.StartTlsFactory</span><span style="color:#666">;</span>
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.apache.directory.api.ldap.extras.extended.ads_impl.startTransaction.StartTransactionFactory</span><span style="color:#666">;</span>
    <span style="color:#666">.</span><span style="color:#666">.</span><span style="color:#666">.</span>

    <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">     * A utility class for adding Codec and extended operation factories.
</span><span style="color:#080;font-style:italic">     *
</span><span style="color:#080;font-style:italic">     * @author &lt;a href=&#34;mailto:dev@directory.apache.org&#34;&gt;Apache Directory Project&lt;/a&gt;
</span><span style="color:#080;font-style:italic">     */</span>
    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#a2f;font-weight:bold">final</span> <span style="color:#a2f;font-weight:bold">class</span> <span style="color:#00f">CodecFactoryUtil</span>
    <span style="color:#666">{</span>
        <span style="color:#666">.</span><span style="color:#666">.</span><span style="color:#666">.</span>
        <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#a2f;font-weight:bold">static</span> <span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">loadStockExtendedOperations</span><span style="color:#666">(</span>
            Map<span style="color:#666">&lt;</span>String<span style="color:#666">,</span> ExtendedOperationFactory<span style="color:#666">&gt;</span> extendendOperationsFactories<span style="color:#666">,</span> LdapApiService apiService <span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#666">.</span><span style="color:#666">.</span><span style="color:#666">.</span>

            StartTlsFactory startTlsFactory <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">new</span> StartTlsFactory<span style="color:#666">(</span> apiService <span style="color:#666">)</span><span style="color:#666">;</span>
            extendendOperationsFactories<span style="color:#666">.</span><span style="color:#b44">put</span><span style="color:#666">(</span> startTlsFactory<span style="color:#666">.</span><span style="color:#b44">getOid</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">,</span> startTlsFactory <span style="color:#666">)</span><span style="color:#666">;</span>
            LOG<span style="color:#666">.</span><span style="color:#b44">info</span><span style="color:#666">(</span> <span style="color:#b44">&#34;Registered pre-bundled extended operation factory: {}&#34;</span><span style="color:#666">,</span> startTlsFactory<span style="color:#666">.</span><span style="color:#b44">getOid</span><span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">)</span><span style="color:#666">;</span>

            StartTransactionFactory startTransactionFactory <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">new</span> StartTransactionFactory<span style="color:#666">(</span> apiService <span style="color:#666">)</span><span style="color:#666">;</span>
            extendendOperationsFactories<span style="color:#666">.</span><span style="color:#b44">put</span><span style="color:#666">(</span> startTransactionFactory<span style="color:#666">.</span><span style="color:#b44">getOid</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">,</span> startTransactionFactory <span style="color:#666">)</span><span style="color:#666">;</span>
            LOG<span style="color:#666">.</span><span style="color:#b44">info</span><span style="color:#666">(</span> <span style="color:#b44">&#34;Registered pre-bundled extended operation factory: {}&#34;</span><span style="color:#666">,</span> startTransactionFactory<span style="color:#666">.</span><span style="color:#b44">getOid</span><span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">)</span><span style="color:#666">;</span>
            <span style="color:#666">.</span><span style="color:#666">.</span><span style="color:#666">.</span>
        <span style="color:#666">}</span>
    <span style="color:#666">}</span>
</code></pre></div><p>We just need to instanciate the factory, and to add it to the map of supported extended operations.</p>
<p>And the added code for the <em>ExtrasBundleActivator</em> class :</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java">    <span style="color:#666">.</span><span style="color:#666">.</span><span style="color:#666">.</span>
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.apache.directory.api.ldap.extras.extended.ads_impl.startTls.StartTlsFactory</span><span style="color:#666">;</span>
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.apache.directory.api.ldap.extras.extended.ads_impl.startTransaction.StartTransactionFactory</span><span style="color:#666">;</span>
    <span style="color:#666">.</span><span style="color:#666">.</span><span style="color:#666">.</span>
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.apache.directory.api.ldap.extras.extended.startTls.StartTlsRequest</span><span style="color:#666">;</span>
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.apache.directory.api.ldap.extras.extended.startTransaction.StartTransactionRequest</span><span style="color:#666">;</span>
    <span style="color:#666">.</span><span style="color:#666">.</span><span style="color:#666">.</span>

    <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">     * A BundleActivator for the ldap codec extras extension: extra ApacheDS and 
</span><span style="color:#080;font-style:italic">     * Apache Directory Studio specific controls and extended operations. 
</span><span style="color:#080;font-style:italic">     *
</span><span style="color:#080;font-style:italic">     * @author &lt;a href=&#34;mailto:dev@directory.apache.org&#34;&gt;Apache Directory Project&lt;/a&gt;
</span><span style="color:#080;font-style:italic">     */</span>
    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#a2f;font-weight:bold">class</span> <span style="color:#00f">ExtrasBundleActivator</span> <span style="color:#a2f;font-weight:bold">implements</span> BundleActivator
    <span style="color:#666">{</span>
        <span style="color:#666">.</span><span style="color:#666">.</span><span style="color:#666">.</span>
        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * Registers all the extras extended operations present in this control pack.
</span><span style="color:#080;font-style:italic">         *
</span><span style="color:#080;font-style:italic">         * @param codec The codec service.
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f;font-weight:bold">private</span> <span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">registerExtrasExtendedOps</span><span style="color:#666">(</span> LdapApiService codec <span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#080;font-style:italic">// --------------------------------------------------------------------
</span><span style="color:#080;font-style:italic"></span>            <span style="color:#080;font-style:italic">// Register Extended Request Factories
</span><span style="color:#080;font-style:italic"></span>            <span style="color:#080;font-style:italic">// --------------------------------------------------------------------
</span><span style="color:#080;font-style:italic"></span>            <span style="color:#666">.</span><span style="color:#666">.</span><span style="color:#666">.</span>

            StartTlsFactory startTlsFactory <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">new</span> StartTlsFactory<span style="color:#666">(</span> codec <span style="color:#666">)</span><span style="color:#666">;</span>
            codec<span style="color:#666">.</span><span style="color:#b44">registerExtendedRequest</span><span style="color:#666">(</span> startTlsFactory <span style="color:#666">)</span><span style="color:#666">;</span>

            StartTransactionFactory startTransactionFactory <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">new</span> StartTransactionFactory<span style="color:#666">(</span> codec <span style="color:#666">)</span><span style="color:#666">;</span>
            codec<span style="color:#666">.</span><span style="color:#b44">registerExtendedRequest</span><span style="color:#666">(</span> startTransactionFactory <span style="color:#666">)</span><span style="color:#666">;</span>
            <span style="color:#666">.</span><span style="color:#666">.</span><span style="color:#666">.</span>
        <span style="color:#666">}</span>


        <span style="color:#a2f;font-weight:bold">private</span> <span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">unregisterExtrasExtendedOps</span><span style="color:#666">(</span> LdapApiService codec <span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#666">.</span><span style="color:#666">.</span><span style="color:#666">.</span>
            codec<span style="color:#666">.</span><span style="color:#b44">unregisterExtendedRequest</span><span style="color:#666">(</span> StartTlsRequest<span style="color:#666">.</span><span style="color:#b44">EXTENSION_OID</span> <span style="color:#666">)</span><span style="color:#666">;</span>
            codec<span style="color:#666">.</span><span style="color:#b44">unregisterExtendedRequest</span><span style="color:#666">(</span> StartTransactionRequest<span style="color:#666">.</span><span style="color:#b44">EXTENSION_OID</span> <span style="color:#666">)</span><span style="color:#666">;</span>
            <span style="color:#666">.</span><span style="color:#666">.</span><span style="color:#666">.</span>
        <span style="color:#666">}</span>
    <span style="color:#666">}</span>
</code></pre></div><p>We also have to export the package for it to be visible when using <strong>OSGi</strong>. This is done by modifying some <em>pom.xml</em> files.</p>
<p><em>&lt;ldap/extras/codec&gt;</em> module <em>pom.xml</em> file :</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-XML" data-lang="XML">    ...
    <span style="color:#008000;font-weight:bold">&lt;configuration</span><span style="color:#008000;font-weight:bold">&gt;</span>
      <span style="color:#008000;font-weight:bold">&lt;manifestLocation</span><span style="color:#008000;font-weight:bold">&gt;</span>META-INF<span style="color:#008000;font-weight:bold">&lt;/manifestLocation&gt;</span>
      <span style="color:#008000;font-weight:bold">&lt;instructions</span><span style="color:#008000;font-weight:bold">&gt;</span>
        <span style="color:#008000;font-weight:bold">&lt;Bundle-SymbolicName</span><span style="color:#008000;font-weight:bold">&gt;</span>${project.groupId}.ldap.extras.codec<span style="color:#008000;font-weight:bold">&lt;/Bundle-SymbolicName&gt;</span>
        <span style="color:#008000;font-weight:bold">&lt;Export-Package</span><span style="color:#008000;font-weight:bold">&gt;</span>
            {local-packages};version=${project.version};-noimport:=true
        <span style="color:#008000;font-weight:bold">&lt;/Export-Package&gt;</span>
        <span style="color:#008000;font-weight:bold">&lt;Export-Package</span><span style="color:#008000;font-weight:bold">&gt;</span>
          ...
          org.apache.directory.api.ldap.extras.extended.ads_impl.startTls;version=${project.version};-noimport:=true,
          org.apache.directory.api.ldap.extras.extended.ads_impl.startTransaction;version=${project.version};-noimport:=true,
          ...
        <span style="color:#008000;font-weight:bold">&lt;/Export-Package&gt;</span>
        <span style="color:#008000;font-weight:bold">&lt;Import-Package</span><span style="color:#008000;font-weight:bold">&gt;</span>
          ...
          org.apache.directory.api.ldap.extras.extended.startTls;version=${project.version},
          org.apache.directory.api.ldap.extras.extended.startTransaction;version=${project.version},
          ...
        <span style="color:#008000;font-weight:bold">&lt;/Import-Package&gt;</span>
</code></pre></div><p><em>&lt;ldap/extras/codec-api&gt;</em> module <em>pom.xml</em> file :</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-XML" data-lang="XML">    ...
    <span style="color:#008000;font-weight:bold">&lt;configuration</span><span style="color:#008000;font-weight:bold">&gt;</span>
      <span style="color:#008000;font-weight:bold">&lt;manifestLocation</span><span style="color:#008000;font-weight:bold">&gt;</span>META-INF<span style="color:#008000;font-weight:bold">&lt;/manifestLocation&gt;</span>
      <span style="color:#008000;font-weight:bold">&lt;instructions</span><span style="color:#008000;font-weight:bold">&gt;</span>
        <span style="color:#008000;font-weight:bold">&lt;Bundle-SymbolicName</span><span style="color:#008000;font-weight:bold">&gt;</span>${project.groupId}.ldap.extras.codec.api<span style="color:#008000;font-weight:bold">&lt;/Bundle-SymbolicName&gt;</span>
        <span style="color:#008000;font-weight:bold">&lt;Export-Package</span><span style="color:#008000;font-weight:bold">&gt;</span>
          ...
          org.apache.directory.api.ldap.extras.extended.startTls;version=${project.version};-noimport:=true,
          org.apache.directory.api.ldap.extras.extended.startTransaction;version=${project.version};-noimport:=true,
          ...
        <span style="color:#008000;font-weight:bold">&lt;/Export-Package&gt;</span>
</code></pre></div><h1 id="a-more-complex-example">A more complex example</h1>
<p>Wealso have to add the <em>EndTransactionRequest</em> and <em>endTransactionResponse</em> extended opertions. We will focus on the response, which is more complex that the request.</p>
<p>The <em>EndTransactionResponse</em> value follows this ASN.1 description :</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Text" data-lang="Text">    txnEndRes ::= SEQUENCE {
        messageID MessageID OPTIONAL,
             -- msgid associated with non-success resultCode
        updatesControls SEQUENCE OF updateControl SEQUENCE {
             messageID MessageID,
                  -- msgid associated with controls
             controls  Controls
        } OPTIONAL
    }
</code></pre></div><p>Here, <a href="https://tools.ietf.org/html/rfc5805">RFC 5805</a> gives some information about the semantic of this grammar :</p>
<ul>
<li>we can either have a message ID, if the transaction was a failure</li>
<li>or have a list of <em>UpdateControls</em> structure if we have had a success, with some controls having to be returned</li>
<li>or we simply have nothing and then the full value is simply absent.</li>
</ul>
<p><em>Controls</em> is a list of <em>Control</em> as defined in <a href="https://tools.ietf.org/html/rfc4511#section-4.1.11">RFC 4511</a>, with the following ASN.1 description :</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Text" data-lang="Text">    Controls ::= SEQUENCE OF control Control

    Control ::= SEQUENCE {
             controlType             LDAPOID,
             criticality             BOOLEAN DEFAULT FALSE,
             controlValue            OCTET STRING OPTIONAL }
</code></pre></div><p>So we may have many <em>updateControls</em> and for each one of them, one to many <em>controls</em>. We will need to define a state machine to decode those two ASN/1 description.</p>
<p>First, let&rsquo;s see what is the state machine for the <em>txnEndRes</em> type and the <em>controls</em> type :</p>
<p><img src="images/EndTransactionResponse.png" alt="Extended Operations state machine"></p>
<p>The transitions from one step to the other is based on the BER encoded tag :</p>
<ul>
<li>0x30 for SEQUENCE</li>
<li>0x04 for OCTET STRING</li>
<li>0x01 for BOOLEAN</li>
<li>0x02 for INTEGER</li>
</ul>
<p>Note that some deep knowledge on ASN.1 is required to encode or decode some element.</p>
<p>Here, we will need two state machines to decode an <em>EndTransactionResponse</em> message :</p>
<ul>
<li>one for the response value</li>
<li>one for the embedded controls</li>
</ul>
<p>Hopefully, we can reuse the <em>LdapMessage</em> <em>Control</em> grammar (at least the logic)</p>
<p>So we need to code the following interfaces and classes :</p>
<ul>
<li>A container</li>
<li>A Factory</li>
<li>A Grammar (actually 2)</li>
<li>A list of states (StatesEnum)</li>
<li>A decorator</li>
<li>A decoder</li>
<li>An interface</li>
<li>An implementation</li>
</ul>
<p>The interface, implementation, factory, container and decoder are not really complex, and follow the same logic that what we shown in teh previous example.</p>
<p>The list of states is just an <em>enum</em> that describes all the states shown in the state machine exposed before :</p>
<ul>
<li>Global SEQUENCE</li>
<li>MessageId</li>
<li>UpdateControls SEQUENCE</li>
<li>UpdateControl SEQUENCE</li>
<li>UpdateControl messageId</li>
<li>Controls</li>
<li>start and end states</li>
</ul>
<p>We can see we don&rsquo;t have any state associated with the <em>Control</em> decoding : it&rsquo;s handled by another codec.</p>
<p>Here is the <em>enum</em> :</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java">    <span style="color:#a2f;font-weight:bold">package</span> <span style="color:#00f;font-weight:bold">org.apache.directory.api.ldap.extras.extended.ads_impl.endTransaction</span><span style="color:#666">;</span>


    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.apache.directory.api.asn1.ber.grammar.States</span><span style="color:#666">;</span>


    <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">     * This class store the EndTransactionResponse&#39;s grammar constants. It is also used
</span><span style="color:#080;font-style:italic">     * for debugging purposes.
</span><span style="color:#080;font-style:italic">     * 
</span><span style="color:#080;font-style:italic">     * @author &lt;a href=&#34;mailto:dev@directory.apache.org&#34;&gt;Apache Directory Project&lt;/a&gt;
</span><span style="color:#080;font-style:italic">     */</span>
    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#a2f;font-weight:bold">enum</span> EndTransactionResponseStatesEnum <span style="color:#a2f;font-weight:bold">implements</span> States
    <span style="color:#666">{</span>
        <span style="color:#080;font-style:italic">/** The END_STATE */</span>
        END_STATE<span style="color:#666">,</span>
        
        <span style="color:#080;font-style:italic">/** start state*/</span>
        START_STATE<span style="color:#666">,</span>
        
        <span style="color:#080;font-style:italic">/** The initial SEQUENCE */</span>
        END_TRANSACTION_SEQUENCE_STATE<span style="color:#666">,</span>
        
        <span style="color:#080;font-style:italic">/** The failed message ID */</span>
        FAILED_MESSAGE_ID_STATE<span style="color:#666">,</span>
        
        <span style="color:#080;font-style:italic">/** The update controls SEQ */</span>
        UPDATE_CONTROLS_SEQ_STATE<span style="color:#666">,</span>
        
        <span style="color:#080;font-style:italic">/** The update control SEQ */</span>
        UPDATE_CONTROL_SEQ_STATE<span style="color:#666">,</span>
        
        <span style="color:#080;font-style:italic">/** THe control&#39;s message ID state */</span>
        CONTROL_MESSAGE_ID_STATE<span style="color:#666">,</span>
        
        <span style="color:#080;font-style:italic">/** The control&#39;s state */</span>
        CONTROLS_STATE<span style="color:#666">,</span>

        <span style="color:#080;font-style:italic">/** Last state */</span>
        LAST_STATE<span style="color:#666">;</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * Get the grammar name
</span><span style="color:#080;font-style:italic">         * 
</span><span style="color:#080;font-style:italic">         * @return The grammar name
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f;font-weight:bold">public</span> String <span style="color:#00a000">getGrammarName</span><span style="color:#666">(</span><span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">return</span> <span style="color:#b44">&#34;END_TRANSACTION_RESPONSE_GRAMMER&#34;</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * Get the string representing the state
</span><span style="color:#080;font-style:italic">         * 
</span><span style="color:#080;font-style:italic">         * @param state The state number
</span><span style="color:#080;font-style:italic">         * @return The String representing the state
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f;font-weight:bold">public</span> String <span style="color:#00a000">getState</span><span style="color:#666">(</span> <span style="color:#0b0;font-weight:bold">int</span> state <span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">return</span> <span style="color:#666">(</span> state <span style="color:#666">=</span><span style="color:#666">=</span> END_STATE<span style="color:#666">.</span><span style="color:#b44">ordinal</span><span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">)</span> <span style="color:#666">?</span> <span style="color:#b44">&#34;END_TRANSACTION_RESPONSE_GRAMMER&#34;</span> <span style="color:#666">:</span> name<span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * {@inheritDoc}
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f">@Override</span>
        <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#0b0;font-weight:bold">boolean</span> <span style="color:#00a000">isEndState</span><span style="color:#666">(</span><span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">return</span> <span style="color:#a2f;font-weight:bold">this</span> <span style="color:#666">=</span><span style="color:#666">=</span> END_STATE<span style="color:#666">;</span>
        <span style="color:#666">}</span>


        <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">         * {@inheritDoc}
</span><span style="color:#080;font-style:italic">         */</span>
        <span style="color:#a2f">@Override</span>
        <span style="color:#a2f;font-weight:bold">public</span> EndTransactionResponseStatesEnum <span style="color:#00a000">getStartState</span><span style="color:#666">(</span><span style="color:#666">)</span>
        <span style="color:#666">{</span>
            <span style="color:#a2f;font-weight:bold">return</span> START_STATE<span style="color:#666">;</span>
        <span style="color:#666">}</span>
    <span style="color:#666">}</span>
</code></pre></div><p>We can now define transitions between states, accordingly to the grammar semantic :</p>
<table>
<thead>
<tr>
<th>Initial state</th>
<th>Tag</th>
<th>Final state</th>
<th>action</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>START</td>
<td>SEQUENCE</td>
<td>END_TRANSACTION_SEQUENCE</td>
<td>Initialize the data structure holding the result</td>
<td></td>
</tr>
<tr>
<td>END_TRANSACTION_SEQUENCE</td>
<td>INTEGER</td>
<td>FAILED_MESSAGE_ID</td>
<td>Store the failed message ID</td>
<td></td>
</tr>
<tr>
<td>FAILED_MESSAGE_ID</td>
<td>none</td>
<td>END</td>
<td>The value has been fully decode, get out</td>
<td></td>
</tr>
<tr>
<td>END_TRANSACTION_SEQUENCE</td>
<td>SEQUENCE</td>
<td>UPDATE_CONTROLS_SEQ</td>
<td>Create a list of <em>UpdateControls</em>, store it in the response</td>
<td></td>
</tr>
<tr>
<td>UPDATE_CONTROLS_SEQ</td>
<td>SEQUENCE</td>
<td>UPDATE_CONTROL_SEQ</td>
<td>Create a <em>UpdateControls</em> instance, store it in the list</td>
<td></td>
</tr>
<tr>
<td>UPDATE_CONTROL_SEQ</td>
<td>INTEGER</td>
<td>CONTROL_MESSAGE_ID</td>
<td>Store the message ID in the <em>updateControls</em> instance</td>
<td></td>
</tr>
<tr>
<td>CONTROL_MESSAGE_ID</td>
<td>SEQUENCE</td>
<td>CONTROLS</td>
<td>Grab the full value, call teh Controls decoder, store the result in the <em>updateControls</em> instance</td>
<td></td>
</tr>
<tr>
<td>CONTROLS</td>
<td>SEQUENCE</td>
<td>UPDATE_CONTROL_SEQ</td>
<td>Create a <em>UpdateControls</em> instance, store it in the list</td>
<td></td>
</tr>
<tr>
<td>CONTROLS</td>
<td>none</td>
<td>END</td>
<td>The decoding is over, we can quit</td>
<td></td>
</tr>
</tbody>
</table>
<p>Each of those transitions will have an associated action. They are added in a <em>Grammar</em> class. A <em>GrammarTransition</em> is created and takes 3 or 4 parameters :</p>
<ul>
<li>An initial state (&lsquo;from&rsquo;)</li>
<li>A final state (&lsquo;to&rsquo;)</li>
<li>A tag</li>
<li>An optional action to execute</li>
</ul>
<p>Each state may have many transitions going to many different states, but each transition must use a different tag.</p>
<p>Here is an example of transition :</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java">    <span style="color:#080;font-style:italic">/**
</span><span style="color:#080;font-style:italic">     * Transition from Sequence to messageId
</span><span style="color:#080;font-style:italic">     *
</span><span style="color:#080;font-style:italic">     * txnEndReq ::= SEQUENCE {
</span><span style="color:#080;font-style:italic">     *         messageID MessageID OPTIONAL,
</span><span style="color:#080;font-style:italic">     *              -- msgid associated with non-success resultCode
</span><span style="color:#080;font-style:italic">     *     ...
</span><span style="color:#080;font-style:italic">     *     
</span><span style="color:#080;font-style:italic">     * Set the messageId into the EndTransactionResponse instance, if it&#39;s not SUCCESS.
</span><span style="color:#080;font-style:italic">     */</span>
    <span style="color:#a2f;font-weight:bold">super</span><span style="color:#666">.</span><span style="color:#b44">transitions</span><span style="color:#666">[</span>EndTransactionResponseStatesEnum<span style="color:#666">.</span><span style="color:#b44">END_TRANSACTION_SEQUENCE_STATE</span><span style="color:#666">.</span><span style="color:#b44">ordinal</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">]</span><span style="color:#666">[</span>UniversalTag<span style="color:#666">.</span><span style="color:#b44">INTEGER</span><span style="color:#666">.</span><span style="color:#b44">getValue</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">]</span> <span style="color:#666">=</span>
        <span style="color:#a2f;font-weight:bold">new</span> GrammarTransition<span style="color:#666">&lt;</span>EndTransactionResponseContainer<span style="color:#666">&gt;</span><span style="color:#666">(</span>
            EndTransactionResponseStatesEnum<span style="color:#666">.</span><span style="color:#b44">END_TRANSACTION_SEQUENCE_STATE</span><span style="color:#666">,</span>
            EndTransactionResponseStatesEnum<span style="color:#666">.</span><span style="color:#b44">FAILED_MESSAGE_ID_STATE</span><span style="color:#666">,</span>
            UniversalTag<span style="color:#666">.</span><span style="color:#b44">INTEGER</span><span style="color:#666">.</span><span style="color:#b44">getValue</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">,</span>
            <span style="color:#a2f;font-weight:bold">new</span> GrammarAction<span style="color:#666">&lt;</span>EndTransactionResponseContainer<span style="color:#666">&gt;</span><span style="color:#666">(</span> <span style="color:#b44">&#34;Set EndTransactionResponse failed MessageID&#34;</span> <span style="color:#666">)</span>
            <span style="color:#666">{</span>
                <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">action</span><span style="color:#666">(</span> EndTransactionResponseContainer container <span style="color:#666">)</span> <span style="color:#a2f;font-weight:bold">throws</span> DecoderException
                <span style="color:#666">{</span>
                    BerValue value <span style="color:#666">=</span> container<span style="color:#666">.</span><span style="color:#b44">getCurrentTLV</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">getValue</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">;</span>

                    <span style="color:#a2f;font-weight:bold">try</span>
                    <span style="color:#666">{</span>
                        <span style="color:#0b0;font-weight:bold">int</span> failedMessageId <span style="color:#666">=</span> IntegerDecoder<span style="color:#666">.</span><span style="color:#b44">parse</span><span style="color:#666">(</span> value <span style="color:#666">)</span><span style="color:#666">;</span>
                        
                        <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span> failedMessageId <span style="color:#666">&gt;</span> 0 <span style="color:#666">)</span>
                        <span style="color:#666">{</span>
                            container<span style="color:#666">.</span><span style="color:#b44">getEndTransactionResponse</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">setFailedMessageId</span><span style="color:#666">(</span> failedMessageId <span style="color:#666">)</span><span style="color:#666">;</span>
                        <span style="color:#666">}</span>

                        <span style="color:#080;font-style:italic">// We may have nothing left
</span><span style="color:#080;font-style:italic"></span>                        container<span style="color:#666">.</span><span style="color:#b44">setGrammarEndAllowed</span><span style="color:#666">(</span> <span style="color:#a2f;font-weight:bold">true</span> <span style="color:#666">)</span><span style="color:#666">;</span>
                    <span style="color:#666">}</span>
                    <span style="color:#a2f;font-weight:bold">catch</span> <span style="color:#666">(</span> IntegerDecoderException ide <span style="color:#666">)</span>
                    <span style="color:#666">{</span>
                        LOG<span style="color:#666">.</span><span style="color:#b44">error</span><span style="color:#666">(</span> I18n
                            <span style="color:#666">.</span><span style="color:#b44">err</span><span style="color:#666">(</span> I18n<span style="color:#666">.</span><span style="color:#b44">ERR_04490_BAD_END_TRANSACTION_COMMIT</span><span style="color:#666">,</span> Strings<span style="color:#666">.</span><span style="color:#b44">dumpBytes</span><span style="color:#666">(</span> value<span style="color:#666">.</span><span style="color:#b44">getData</span><span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">)</span><span style="color:#666">,</span> ide<span style="color:#666">.</span><span style="color:#b44">getMessage</span><span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">)</span> <span style="color:#666">)</span><span style="color:#666">;</span>

                        <span style="color:#080;font-style:italic">// This will generate a PROTOCOL_ERROR
</span><span style="color:#080;font-style:italic"></span>                        <span style="color:#a2f;font-weight:bold">throw</span> <span style="color:#a2f;font-weight:bold">new</span> DecoderException<span style="color:#666">(</span> ide<span style="color:#666">.</span><span style="color:#b44">getMessage</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">,</span> ide <span style="color:#666">)</span><span style="color:#666">;</span>
                    <span style="color:#666">}</span>
                <span style="color:#666">}</span>
            <span style="color:#666">}</span> <span style="color:#666">)</span><span style="color:#666">;</span>
</code></pre></div><p>In this example, we have a transition from a <strong>END_TRANSACTION_SEQUENCE_STATE</strong> state to a <strong>FAILED_MESSAGE_ID</strong> state, which is triggered by an <strong>INTEGER</strong> tag. The executed action is created immediately, but it could have been a separated class.</p>


            
    <div class="nav">
        <div class="nav_prev">
            
                
                <a href="13-controls.html">13 - Controls</a>
            
        </div>
        <div class="nav_up">
            
                
                <a href="../internal-design-guide.html">Internal Design Guide</a>
            
        </div>
        <div class="nav_next">
            
                
                <a href="15-ldif.html">15 - LDIF</a>
            
        </div>
        <div class="clearfix"></div>
    </div>


        </div>
        <div id="endContent"></div>
    </div>

    <div id="footer">
    &copy; 2003-2022, <a href="http://www.apache.org">The Apache Software Foundation</a> - <a href="/privacy-policy.html">Privacy Policy</a><br />
    Apache Directory, ApacheDS, Apache Directory Server, Apache Directory Studio, Apache LDAP API, Apache Triplesec,
    Triplesec, Apache Mavibot, Mavibot, Apache eSCIMo, eSCIMo, Apache SCIMple, SCIMple,Fortress, Apache Fortress, EnMasse,
    Apache EnMasse, Apache Kerby, Kerby, Apache, the Apache feather logo, and the Apache Directory project logos are
    trademarks of The Apache Software Foundation.
</div>

</div>

</body>

</html>
