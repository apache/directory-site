<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Testimonials &mdash; Apache Directory</title>

    <link href="/css/common.css" rel="stylesheet" type="text/css"/>
    <link href="/css/turquoise.css" rel="stylesheet" type="text/css"/>

    <link rel="shortcut icon" href="/images/server-icon_16x16.png" />
</head>

<body>
<div id="container">
    <div id="header">
    <div id="subProjectsNavBar">
        <a href="/">
             
                Main
            
        </a>
        &nbsp;|&nbsp;
        <a href="/apacheds/">
             
                ApacheDS
            
        </a>
        &nbsp;|&nbsp;
        <a href="/studio/">
             
                Studio
            
        </a>
        &nbsp;|&nbsp;
        <a href="/api/">
             
                LDAP API
            
        </a>
        &nbsp;|&nbsp;
        <a href="/mavibot/">
             
                Mavibot
            
        </a>
        &nbsp;|&nbsp;
        <a href="/scimple/">
             
                SCIMple
            
        </a>
        &nbsp;|&nbsp;
        <a href="/fortress/">
            
                <strong>Fortress</strong>
            
        </a>
        &nbsp;|&nbsp;
        <a href="/kerby/">
             
                Kerby
            
        </a>
    </div>
</div>


    <div id="content">
        <div id="leftColumn">
            <div id="navigation">
                
                <h5>Fortress</h5>
                <ul>
                    <li><a href="/fortress/">Home</a></li>
                    <li><a href="/fortress/history.html">History</a></li>
                    <li><a href="/fortress/news.html">News</a></li>
                </ul>

                <h5>Downloads</h5>
                <ul>
                    <li><a href="/fortress/downloads.html">Fortress 2.0.5</a>&nbsp;&nbsp;<img src="/images/new_badge.gif" alt="" style="margin-bottom:-3px;" border="0"></li>
                    <li><a href="/fortress/download-old-versions.html">Older versions</a></li>
                </ul>

                

                <h5>Documentation</h5>
                <ul>
                    <li><a href="/fortress/overview.html">Overview</a></li>
                    <li><a href="/fortress/installation.html">Installation Guide</a></li>
                    <li><a href="/fortress/user-guide.html">Users Guide</a></li>
                    <li><a href="/fortress/coding-standards.html">Coding Standards</a></li>
                    <li><a href="/fortress/gen-docs/latest/apidocs/">JavaDocs</a></li>
                    
                    <li><a href="/fortress/gen-docs/latest/">Generated Reports</a></li>
                    <li><a href="/fortress/developer-guide.html">Developer Guide</a></li>
                    <li><a href="/fortress/testimonials.html">Testimonials</a></li>
                </ul>

                <h5>Support</h5>
<ul>
    <li><a href="/mailing-lists-and-irc.html">Mailing Lists &amp; IRC</a></li>
    <li><a href="/sources.html">Sources</a></li>
    <li><a href="/issue-tracking.html">Issue Tracking</a></li>
    <li><a href="/commercial-support.html">Commercial Support</a></li>
</ul>

<h5>Community</h5>
<ul>
    <li><a href="/contribute.html">How to Contribute</a></li>
    <li><a href="/team.html">Team</a></li>
    <li><a href="/original-project-proposal.html">Original Project Proposal</a></li>
    <li><a href="/special-thanks.html" class="external-link" rel="nofollow">Special Thanks</a></li>
</ul>

<h5>About Apache</h5>
<ul>
    <li><a href="http://www.apache.org/">Apache</a></li>
    <li><a href="http://www.apache.org/licenses/">License</a></li>
    <li><a href="http://www.apache.org/foundation/sponsorship.html">Sponsorship</a></li>
    <li><a href="http://www.apache.org/foundation/thanks.html">Thanks</a></li>
    <li><a href="http://www.apache.org/security/">Security</a></li>
</ul>

            </div>
        </div>
        <div id="rightColumn">
            

            
	<h1 id="testimonials">Testimonials</h1>
<h2 id="credits">Credits</h2>
<p>This work was contributed by <strong>Yudhi Karunia Surtan</strong> of PT. Global Digital Niaga <a href="blibli.com">blibli.com</a>.  Thanks to him and his team for their efforts in helping others use Fortress.</p>
<h2 id="introduction">Introduction</h2>
<p>This document contains an overview for combining a CAS-based <strong>SSO</strong> module with fortress-based authorization, using a declarative URL filtering mechanism.</p>
<h3 id="detailed-description-of-the-project">Detailed description of the project</h3>
<p>I created this solution a few years ago because at the time I was looking for an <strong>IAM</strong> and <strong>SSO</strong> solution, and there were no open source solutions that provided everything that I needed.</p>
<p>Basically, the idea was, I needed a framework where the developer didn&rsquo;t have to programmatically add authorization calls to their code, or use annotations, or any other kind of <em>if condition</em> statement. With this solution, I can have a declarative mechanism that is still capable of making advanced dynamic authorization decisions, even if the user hasn&rsquo;t been logged in before or has any of the proper roles activated to their session.  I can do this because I control the authorization and it has been centralized in the server, and that server can activate whatever user roles needed to to allow access to the runtime environment.</p>
<p>I searched all available open source solutions and finally decided to combine <a href="https://www.apereo.org/projects/cas">Apereo CAS</a> and <strong>Apache Fortress</strong> into a single solution. <a href="https://www.apereo.org/projects/cas">Apereo CAS</a> does the authentication and Apache Fortress will handle authorization.</p>
<p>I went this route because <a href="https://www.apereo.org/projects/cas">Apereo CAS</a> is very good way to handle the <em>Single Sign-On</em> and <em>Single Sign-Out</em> problems, but it lacks authorization capabilities, because there aren&rsquo;t standardized solutions in that space yet. <em>Apache Fortress</em> is good at authorization because it uses standard <strong>RBAC</strong>. However, <em>Apache Fortress</em> doesn&rsquo;t have an <strong>SSO</strong> solution yet. That is why I think both should be combined because they complement each other.  Unfortunately, there aren&rsquo;t yet good documentation resources available to combine these which is why I created this one, so other developers can follow my team&rsquo;s lead and make their life easier by providing good security for their webapps.</p>
<p>The solution I present to you here has operated successfully inside production environments since 2015 and so it&rsquo;s quite mature.  I write this how-to document to explain how it works.  It&rsquo;s intended as a guide for you to follow as well.</p>
<p>Here are the technology stacks used within my extended framework:</p>
<ul>
<li><a href="https://www.apereo.org/projects/cas">Apereo CAS</a> -&gt; 4.2.x</li>
<li><em>Apache Fortress Enmasse</em> (rest) -&gt; 1.0.0</li>
<li><em>Apache Fortress Proxy</em> -&gt; 1.0.0</li>
<li><a href="https://ignite.apache.org/">Apache Ignite</a> -&gt; 1.7.0</li>
<li>Spring Framework -&gt; 4.2.x-RELEASE</li>
</ul>
<p>There are two areas of development focus.  One to handle the server side and the other for the client.  The client is shared with my dev team for managing security within their web applications.</p>
<ol>
<li><strong>CAS</strong> Server side development: Includes creating own implementation for <em>AbstractUsernamePasswordAuthenticationHandler</em> and implemening an <a href="https://ignite.apache.org/">Apache Ignite</a> Service Registry for <strong>CAS</strong></li>
<li><strong>CAS</strong> Client side development: Includes create own implementation for <em>WebExpressionVoter</em> and <em>CasAuthenticationProvider</em></li>
</ol>
<h2 id="code-descriptions">Code Descriptions</h2>
<p>The following sections contain code and xml snippets describing how the <strong>CAS</strong> and <strong>Fortress</strong> integration was accomplished.</p>
<h3 id="server-side-development">Server side development:</h3>
<h4 id="1-the-authentication-handler">1. The Authentication Handler</h4>
<p>The interesting part for this solution is how to maintain both the <a href="https://www.apereo.org/projects/cas">Apereo CAS</a> and Apache Fortress sessions. Luckily, <strong>CAS</strong> is using a token for maintaining their session and that token is also designed to have some extended attributes included with it.  Using this knowledge, we can modify the profile given by <strong>CAS</strong> Server to the client. Let&rsquo;s have a look what I&rsquo;ve done with combining the <a href="https://www.apereo.org/projects/cas">Apereo CAS</a> and <em>Apache Fortress</em> sessions in the code that follows.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java">
    <span style="color:#080;font-style:italic">/*
</span><span style="color:#080;font-style:italic">     * Copyright 2017 to PT. Global Digital Niaga(Blibli.com)
</span><span style="color:#080;font-style:italic">     * 
</span><span style="color:#080;font-style:italic">     * Licensed under the Apache License, Version 2.0; you may not use this file except in compliance
</span><span style="color:#080;font-style:italic">     * with the License. You may obtain a copy of the License at
</span><span style="color:#080;font-style:italic">     * 
</span><span style="color:#080;font-style:italic">     * http://www.apache.org/licenses/LICENSE-2.0
</span><span style="color:#080;font-style:italic">     * 
</span><span style="color:#080;font-style:italic">     * Unless required by applicable law or agreed to in writing, software distributed under the License
</span><span style="color:#080;font-style:italic">     * is distributed on an &#34;AS IS&#34; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
</span><span style="color:#080;font-style:italic">     * or implied. See the License for the specific language governing permissions and limitations under
</span><span style="color:#080;font-style:italic">     * the License.
</span><span style="color:#080;font-style:italic">     */</span>
    <span style="color:#a2f;font-weight:bold">package</span> <span style="color:#00f;font-weight:bold">com.gdn.iam.cas</span><span style="color:#666">;</span>
    
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">java.io.StringWriter</span><span style="color:#666">;</span>
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">java.security.GeneralSecurityException</span><span style="color:#666">;</span>
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">java.util.HashMap</span><span style="color:#666">;</span>
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">java.util.Map</span><span style="color:#666">;</span>
    
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">javax.xml.bind.JAXBContext</span><span style="color:#666">;</span>
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">javax.xml.bind.JAXBException</span><span style="color:#666">;</span>
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">javax.xml.bind.Marshaller</span><span style="color:#666">;</span>
    
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.apache.directory.fortress.core.AccessMgr</span><span style="color:#666">;</span>
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.apache.directory.fortress.core.model.Session</span><span style="color:#666">;</span>
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.apache.directory.fortress.core.model.User</span><span style="color:#666">;</span>
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.jasig.cas.authentication.HandlerResult</span><span style="color:#666">;</span>
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.jasig.cas.authentication.PreventedException</span><span style="color:#666">;</span>
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.jasig.cas.authentication.UsernamePasswordCredential</span><span style="color:#666">;</span>
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.jasig.cas.authentication.handler.support.AbstractUsernamePasswordAuthenticationHandler</span><span style="color:#666">;</span>
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.slf4j.Logger</span><span style="color:#666">;</span>
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.slf4j.LoggerFactory</span><span style="color:#666">;</span>
    
    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#a2f;font-weight:bold">class</span> <span style="color:#00f">IamAuthenticationHandler</span> <span style="color:#a2f;font-weight:bold">extends</span> AbstractUsernamePasswordAuthenticationHandler <span style="color:#666">{</span>
    
      <span style="color:#a2f;font-weight:bold">private</span> <span style="color:#a2f;font-weight:bold">static</span> <span style="color:#a2f;font-weight:bold">final</span> Logger LOG <span style="color:#666">=</span> LoggerFactory<span style="color:#666">.</span><span style="color:#b44">getLogger</span><span style="color:#666">(</span>IamAuthenticationHandler<span style="color:#666">.</span><span style="color:#b44">class</span><span style="color:#666">)</span><span style="color:#666">;</span>
    
      <span style="color:#a2f;font-weight:bold">private</span> AccessMgr accessManager<span style="color:#666">;</span>
      <span style="color:#a2f;font-weight:bold">private</span> JAXBContext jaxbContext<span style="color:#666">;</span>
      <span style="color:#a2f;font-weight:bold">private</span> Marshaller marshaller<span style="color:#666">;</span>
    
      <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#00a000">IamAuthenticationHandler</span><span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#a2f;font-weight:bold">try</span> <span style="color:#666">{</span>
          jaxbContext <span style="color:#666">=</span> JAXBContext<span style="color:#666">.</span><span style="color:#b44">newInstance</span><span style="color:#666">(</span>Session<span style="color:#666">.</span><span style="color:#b44">class</span><span style="color:#666">)</span><span style="color:#666">;</span>
          marshaller <span style="color:#666">=</span> jaxbContext<span style="color:#666">.</span><span style="color:#b44">createMarshaller</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#666">}</span> <span style="color:#a2f;font-weight:bold">catch</span> <span style="color:#666">(</span>JAXBException e<span style="color:#666">)</span> <span style="color:#666">{</span>
          LOG<span style="color:#666">.</span><span style="color:#b44">error</span><span style="color:#666">(</span><span style="color:#b44">&#34;cannot bind Session with jaxb context&#34;</span><span style="color:#666">,</span> e<span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>
      <span style="color:#666">}</span>
    
      <span style="color:#a2f">@Override</span>
      <span style="color:#a2f;font-weight:bold">protected</span> HandlerResult <span style="color:#00a000">authenticateUsernamePasswordInternal</span><span style="color:#666">(</span>
          UsernamePasswordCredential usernamePasswordCredential<span style="color:#666">)</span>
              <span style="color:#a2f;font-weight:bold">throws</span> GeneralSecurityException<span style="color:#666">,</span> PreventedException <span style="color:#666">{</span>
        String username <span style="color:#666">=</span> usernamePasswordCredential<span style="color:#666">.</span><span style="color:#b44">getUsername</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">;</span>
        String password <span style="color:#666">=</span> usernamePasswordCredential<span style="color:#666">.</span><span style="color:#b44">getPassword</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">;</span>
        Session iamSession <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">null</span><span style="color:#666">;</span>
        String iamXmlSession <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">null</span><span style="color:#666">;</span>
        <span style="color:#a2f;font-weight:bold">try</span> <span style="color:#666">{</span>
          LOG<span style="color:#666">.</span><span style="color:#b44">trace</span><span style="color:#666">(</span><span style="color:#b44">&#34;trying to authenticate username : {}, password : {}&#34;</span><span style="color:#666">,</span>
              <span style="color:#a2f;font-weight:bold">new</span> Object<span style="color:#666">[</span><span style="color:#666">]</span> <span style="color:#666">{</span>username<span style="color:#666">,</span> password<span style="color:#666">}</span><span style="color:#666">)</span><span style="color:#666">;</span>
          iamSession <span style="color:#666">=</span> accessManager<span style="color:#666">.</span><span style="color:#b44">createSession</span><span style="color:#666">(</span><span style="color:#a2f;font-weight:bold">new</span> User<span style="color:#666">(</span>username<span style="color:#666">,</span> password<span style="color:#666">.</span><span style="color:#b44">toCharArray</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">)</span><span style="color:#666">,</span> <span style="color:#a2f;font-weight:bold">false</span><span style="color:#666">)</span><span style="color:#666">;</span>
          LOG<span style="color:#666">.</span><span style="color:#b44">trace</span><span style="color:#666">(</span><span style="color:#b44">&#34;iam session : {}&#34;</span><span style="color:#666">,</span> iamSession<span style="color:#666">)</span><span style="color:#666">;</span>
          <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>iamSession <span style="color:#666">!</span><span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">null</span><span style="color:#666">)</span> <span style="color:#666">{</span>
            StringWriter writer <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">new</span> StringWriter<span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">;</span>
            marshaller<span style="color:#666">.</span><span style="color:#b44">marshal</span><span style="color:#666">(</span>iamSession<span style="color:#666">,</span> writer<span style="color:#666">)</span><span style="color:#666">;</span>
            iamXmlSession <span style="color:#666">=</span> writer<span style="color:#666">.</span><span style="color:#b44">toString</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">;</span>
            LOG<span style="color:#666">.</span><span style="color:#b44">trace</span><span style="color:#666">(</span><span style="color:#b44">&#34;iam xml session : {}&#34;</span><span style="color:#666">,</span> iamXmlSession<span style="color:#666">)</span><span style="color:#666">;</span>
            Map<span style="color:#666">&lt;</span>String<span style="color:#666">,</span> Object<span style="color:#666">&gt;</span> attributes <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">new</span> HashMap<span style="color:#666">&lt;</span><span style="color:#666">&gt;</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">;</span>
            attributes<span style="color:#666">.</span><span style="color:#b44">put</span><span style="color:#666">(</span><span style="color:#b44">&#34;iamSession&#34;</span><span style="color:#666">,</span> iamXmlSession<span style="color:#666">)</span><span style="color:#666">;</span>
            <span style="color:#a2f;font-weight:bold">return</span> createHandlerResult<span style="color:#666">(</span>usernamePasswordCredential<span style="color:#666">,</span>
                principalFactory<span style="color:#666">.</span><span style="color:#b44">createPrincipal</span><span style="color:#666">(</span>username<span style="color:#666">,</span> attributes<span style="color:#666">)</span><span style="color:#666">,</span> <span style="color:#a2f;font-weight:bold">null</span><span style="color:#666">)</span><span style="color:#666">;</span>
          <span style="color:#666">}</span>
        <span style="color:#666">}</span> <span style="color:#a2f;font-weight:bold">catch</span> <span style="color:#666">(</span>org<span style="color:#666">.</span><span style="color:#b44">apache</span><span style="color:#666">.</span><span style="color:#b44">directory</span><span style="color:#666">.</span><span style="color:#b44">fortress</span><span style="color:#666">.</span><span style="color:#b44">core</span><span style="color:#666">.</span><span style="color:#b44">SecurityException</span> e<span style="color:#666">)</span> <span style="color:#666">{</span>
          String errorMessage <span style="color:#666">=</span> <span style="color:#b44">&#34;IAM authentication failed for [&#34;</span> <span style="color:#666">+</span> username <span style="color:#666">+</span> <span style="color:#b44">&#34;]&#34;</span><span style="color:#666">;</span>
          LOG<span style="color:#666">.</span><span style="color:#b44">trace</span><span style="color:#666">(</span>errorMessage<span style="color:#666">)</span><span style="color:#666">;</span>
          <span style="color:#a2f;font-weight:bold">throw</span> <span style="color:#a2f;font-weight:bold">new</span> GeneralSecurityException<span style="color:#666">(</span>errorMessage<span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#666">}</span> <span style="color:#a2f;font-weight:bold">catch</span> <span style="color:#666">(</span>JAXBException e<span style="color:#666">)</span> <span style="color:#666">{</span>
          String errorMessage <span style="color:#666">=</span> <span style="color:#b44">&#34;cannot marshalling session with value : &#34;</span> <span style="color:#666">+</span> iamSession <span style="color:#666">=</span><span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">null</span> <span style="color:#666">?</span> <span style="color:#b44">&#34;null&#34;</span>
              <span style="color:#666">:</span> iamSession<span style="color:#666">.</span><span style="color:#b44">toString</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">;</span>
          LOG<span style="color:#666">.</span><span style="color:#b44">trace</span><span style="color:#666">(</span>errorMessage<span style="color:#666">)</span><span style="color:#666">;</span>
          <span style="color:#a2f;font-weight:bold">throw</span> <span style="color:#a2f;font-weight:bold">new</span> GeneralSecurityException<span style="color:#666">(</span>errorMessage<span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>
        LOG<span style="color:#666">.</span><span style="color:#b44">trace</span><span style="color:#666">(</span><span style="color:#b44">&#34;returning default handler&#34;</span><span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#a2f;font-weight:bold">return</span> createHandlerResult<span style="color:#666">(</span>usernamePasswordCredential<span style="color:#666">,</span>
            principalFactory<span style="color:#666">.</span><span style="color:#b44">createPrincipal</span><span style="color:#666">(</span>username<span style="color:#666">)</span><span style="color:#666">,</span> <span style="color:#a2f;font-weight:bold">null</span><span style="color:#666">)</span><span style="color:#666">;</span>
      <span style="color:#666">}</span>
    
      <span style="color:#a2f;font-weight:bold">public</span> AccessMgr <span style="color:#00a000">getAccessManager</span><span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#a2f;font-weight:bold">return</span> accessManager<span style="color:#666">;</span>
      <span style="color:#666">}</span>
    
      <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">setAccessManager</span><span style="color:#666">(</span>AccessMgr accessManager<span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#a2f;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#b44">accessManager</span> <span style="color:#666">=</span> accessManager<span style="color:#666">;</span>
      <span style="color:#666">}</span>
    
    <span style="color:#666">}</span>
</code></pre></div><p>In the above source code you can see how I construct a new principal by creating a new attribute map with values contained withing the <em>Apache Fortress</em> Session xml.</p>
<h4 id="2-the-attribute-populator">2. The Attribute Populator</h4>
<p>In order to populate fortress and pass it on to the client we need to override the <em>casServiceValidationSuccess.jsp</em> file, located at <em>WEB-INF/view/jsp/protocol/2.0/</em>, since its default view won&rsquo;t populating the necessary attributes. Here is how I was able to accomplish that:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-XML" data-lang="XML">    
    <span style="">&lt;</span>%@ page session=&#34;false&#34; contentType=&#34;application/xml; charset=UTF-8&#34; %&gt;
    <span style="">&lt;</span>%@ taglib prefix=&#34;c&#34; uri=&#34;http://java.sun.com/jsp/jstl/core&#34; %&gt;
    <span style="">&lt;</span>%@ taglib uri=&#34;http://java.sun.com/jsp/jstl/functions&#34; prefix=&#34;fn&#34; %&gt;
    <span style="color:#008000;font-weight:bold">&lt;cas:serviceResponse</span> <span style="color:#b44">xmlns:cas=</span><span style="color:#b44">&#39;http://www.yale.edu/tp/cas&#39;</span><span style="color:#008000;font-weight:bold">&gt;</span>
        <span style="color:#080;font-style:italic">&lt;!--</span><span style="color:#080;font-style:italic"> cas 2 validation success </span><span style="color:#080;font-style:italic">--&gt;</span>
        <span style="color:#008000;font-weight:bold">&lt;cas:authenticationSuccess</span><span style="color:#008000;font-weight:bold">&gt;</span>
            <span style="color:#008000;font-weight:bold">&lt;cas:user</span><span style="color:#008000;font-weight:bold">&gt;</span>${fn:escapeXml(assertion.primaryAuthentication.principal.id)}<span style="color:#008000;font-weight:bold">&lt;/cas:user&gt;</span>
            <span style="color:#008000;font-weight:bold">&lt;c:if</span> <span style="color:#b44">test=</span><span style="color:#b44">&#34;${not empty assertion.primaryAuthentication.principal.attributes}&#34;</span><span style="color:#008000;font-weight:bold">&gt;</span>
            <span style="color:#008000;font-weight:bold">&lt;cas:attributes</span><span style="color:#008000;font-weight:bold">&gt;</span>
                <span style="color:#008000;font-weight:bold">&lt;c:forEach</span> <span style="color:#b44">var=</span><span style="color:#b44">&#34;attr&#34;</span> <span style="color:#b44">items=</span><span style="color:#b44">&#34;${assertion.primaryAuthentication.principal.attributes}&#34;</span> <span style="color:#008000;font-weight:bold">&gt;</span>
                    <span style="color:#008000;font-weight:bold">&lt;cas:</span><span style="">$</span><span style="">{</span><span style="">f</span><span style="">n</span><span style="">:</span><span style="">e</span><span style="">s</span><span style="">c</span><span style="">a</span><span style="">p</span><span style="">e</span><span style="">X</span><span style="">m</span><span style="">l</span><span style="">(</span><span style="">a</span><span style="">t</span><span style="">t</span><span style="">r</span><span style="">.</span><span style="">k</span><span style="">e</span><span style="">y</span><span style="">)</span><span style="">}</span><span style="color:#008000;font-weight:bold">&gt;</span><span style="color:#080">&lt;![CDATA[${attr.value}]]&gt;</span><span style="">&lt;</span>/cas:${fn:escapeXml(attr.key)}&gt;
                <span style="color:#008000;font-weight:bold">&lt;/c:forEach&gt;</span>
            <span style="color:#008000;font-weight:bold">&lt;/cas:attributes&gt;</span>
            <span style="color:#008000;font-weight:bold">&lt;/c:if&gt;</span>
            <span style="color:#008000;font-weight:bold">&lt;c:if</span> <span style="color:#b44">test=</span><span style="color:#b44">&#34;${not empty pgtIou}&#34;</span><span style="color:#008000;font-weight:bold">&gt;</span>
                    <span style="color:#008000;font-weight:bold">&lt;cas:proxyGrantingTicket</span><span style="color:#008000;font-weight:bold">&gt;</span>${pgtIou}<span style="color:#008000;font-weight:bold">&lt;/cas:proxyGrantingTicket&gt;</span>
            <span style="color:#008000;font-weight:bold">&lt;/c:if&gt;</span>
            <span style="color:#008000;font-weight:bold">&lt;c:if</span> <span style="color:#b44">test=</span><span style="color:#b44">&#34;${fn:length(assertion.chainedAuthentications) &gt; 1}&#34;</span><span style="color:#008000;font-weight:bold">&gt;</span>
              <span style="color:#008000;font-weight:bold">&lt;cas:proxies</span><span style="color:#008000;font-weight:bold">&gt;</span>
                <span style="color:#008000;font-weight:bold">&lt;c:forEach</span> <span style="color:#b44">var=</span><span style="color:#b44">&#34;proxy&#34;</span> <span style="color:#b44">items=</span><span style="color:#b44">&#34;${assertion.chainedAuthentications}&#34;</span> <span style="color:#b44">varStatus=</span><span style="color:#b44">&#34;loopStatus&#34;</span> <span style="color:#b44">begin=</span><span style="color:#b44">&#34;0&#34;</span> <span style="color:#b44">end=</span><span style="color:#b44">&#34;${fn:length(assertion.chainedAuthentications)-2}&#34;</span> <span style="color:#b44">step=</span><span style="color:#b44">&#34;1&#34;</span><span style="color:#008000;font-weight:bold">&gt;</span>
                     <span style="color:#008000;font-weight:bold">&lt;cas:proxy</span><span style="color:#008000;font-weight:bold">&gt;</span>${fn:escapeXml(proxy.principal.id)}<span style="color:#008000;font-weight:bold">&lt;/cas:proxy&gt;</span>
                <span style="color:#008000;font-weight:bold">&lt;/c:forEach&gt;</span>
              <span style="color:#008000;font-weight:bold">&lt;/cas:proxies&gt;</span>
            <span style="color:#008000;font-weight:bold">&lt;/c:if&gt;</span>
        <span style="color:#008000;font-weight:bold">&lt;/cas:authenticationSuccess&gt;</span>
    <span style="color:#008000;font-weight:bold">&lt;/cas:serviceResponse&gt;</span>
</code></pre></div><p>One thing that I love about <strong>CAS</strong>, even if you correctly extracted the attribute at this page (or maybe you just got hacked at this page), <strong>CAS</strong> is able to protect the returned attributes by changing the services registry configuration. see the <em>HTTPSandIMAPS-10000001.json</em> file. I’ve put <em>ReturnAllAttributeReleasePolicy</em> type for debuging all the attributes returned, you can change it later to make your application more secure as well.</p>
<h4 id="3-apache-ignite-for-ticket-replication">3. Apache Ignite For Ticket Replication</h4>
<p>To have a production readiness we need to somehow manage a high availability requirement, so we&rsquo;re not just using a single <strong>CAS</strong> server. That is why we needed to have a centralized or distributed ticket repository, to allow <strong>CAS</strong> to scale. To scale the ticket repository, I chose <a href="https://ignite.apache.org/">Apache Ignite</a> for distributing the tickets. To Implement is very simple, and is also written about in <a href="https://www.apereo.org/projects/cas">Apereo CAS</a> documentation.</p>
<h3 id="client-side-development">Client side development:</h3>
<h4 id="1-the-spring-voter">1. The Spring Voter</h4>
<p><strong>Spring</strong> is a great framework, they allow you to add your own interceptors to use your own implementation. <em>WebExpressionVoter</em> is the class you need to extend in order to override the normal spring decision mechanism.  Usually you will use xml + regex for registering the condition. However, xml + regex is not the approach I wanted for my development team. See below code snippet, to understand what I did to make this more dynamic.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java">      <span style="color:#a2f">@Override</span>
      <span style="color:#a2f">@SuppressWarnings</span><span style="color:#666">(</span><span style="color:#b44">&#34;static-access&#34;</span><span style="color:#666">)</span>
      <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#0b0;font-weight:bold">int</span> <span style="color:#00a000">vote</span><span style="color:#666">(</span>Authentication authentication<span style="color:#666">,</span> FilterInvocation fi<span style="color:#666">,</span>
          Collection<span style="color:#666">&lt;</span>ConfigAttribute<span style="color:#666">&gt;</span> attributes<span style="color:#666">)</span> <span style="color:#666">{</span>
        Authentication securityContextAuthentication <span style="color:#666">=</span>
            SecurityContextHolder<span style="color:#666">.</span><span style="color:#b44">getContext</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">getAuthentication</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#0b0;font-weight:bold">int</span> result <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">super</span><span style="color:#666">.</span><span style="color:#b44">vote</span><span style="color:#666">(</span>securityContextAuthentication<span style="color:#666">,</span> fi<span style="color:#666">,</span> attributes<span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>System<span style="color:#666">.</span><span style="color:#b44">getenv</span><span style="color:#666">(</span>IAM_SECURITY_PARAMETER<span style="color:#666">)</span> <span style="color:#666">!</span><span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">null</span><span style="color:#666">)</span> <span style="color:#666">{</span>
          LOG<span style="color:#666">.</span><span style="color:#b44">warn</span><span style="color:#666">(</span><span style="color:#b44">&#34;iam security is disable, enable all access mode is enable&#34;</span><span style="color:#666">)</span><span style="color:#666">;</span>
          <span style="color:#a2f;font-weight:bold">return</span> result<span style="color:#666">;</span>
        <span style="color:#666">}</span> <span style="color:#a2f;font-weight:bold">else</span> <span style="color:#666">{</span>
          LOG<span style="color:#666">.</span><span style="color:#b44">debug</span><span style="color:#666">(</span><span style="color:#b44">&#34;authentication = {}&#34;</span><span style="color:#666">,</span>
              ToStringBuilder<span style="color:#666">.</span><span style="color:#b44">reflectionToString</span><span style="color:#666">(</span>securityContextAuthentication<span style="color:#666">)</span><span style="color:#666">)</span><span style="color:#666">;</span>
          LOG<span style="color:#666">.</span><span style="color:#b44">debug</span><span style="color:#666">(</span><span style="color:#b44">&#34;super vote for : {}&#34;</span><span style="color:#666">,</span> result<span style="color:#666">)</span><span style="color:#666">;</span>
          <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span><span style="color:#a2f;font-weight:bold">super</span><span style="color:#666">.</span><span style="color:#b44">ACCESS_GRANTED</span> <span style="color:#666">=</span><span style="color:#666">=</span> result<span style="color:#666">)</span> <span style="color:#666">{</span>
            String requestMethod <span style="color:#666">=</span> fi<span style="color:#666">.</span><span style="color:#b44">getRequest</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">getMethod</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">toLowerCase</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">;</span>
            String filterUrl <span style="color:#666">=</span> getFilterUrl<span style="color:#666">(</span>fi<span style="color:#666">.</span><span style="color:#b44">getHttpRequest</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">)</span><span style="color:#666">;</span>
            <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>filterUrl <span style="color:#666">=</span><span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">null</span><span style="color:#666">)</span> <span style="color:#666">{</span>
              <span style="color:#a2f;font-weight:bold">return</span> result<span style="color:#666">;</span>
            <span style="color:#666">}</span>
            <span style="color:#a2f;font-weight:bold">try</span> <span style="color:#666">{</span>
              CasAuthenticationToken casAuthenticationToken <span style="color:#666">=</span>
                  <span style="color:#666">(</span><span style="color:#666">(</span>CasAuthenticationToken<span style="color:#666">)</span> securityContextAuthentication<span style="color:#666">)</span><span style="color:#666">;</span>
              LOG<span style="color:#666">.</span><span style="color:#b44">debug</span><span style="color:#666">(</span><span style="color:#b44">&#34;assertion : {}&#34;</span><span style="color:#666">,</span>
                  ToStringBuilder<span style="color:#666">.</span><span style="color:#b44">reflectionToString</span><span style="color:#666">(</span>casAuthenticationToken<span style="color:#666">.</span><span style="color:#b44">getAssertion</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">)</span><span style="color:#666">)</span><span style="color:#666">;</span>
              String iamSessionXml <span style="color:#666">=</span> <span style="color:#666">(</span>String<span style="color:#666">)</span> casAuthenticationToken<span style="color:#666">.</span><span style="color:#b44">getAssertion</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">getAttributes</span><span style="color:#666">(</span><span style="color:#666">)</span>
                  <span style="color:#666">.</span><span style="color:#b44">get</span><span style="color:#666">(</span>IAM_SESSION_ATTRIBUTE_KEY<span style="color:#666">)</span><span style="color:#666">;</span>
              LOG<span style="color:#666">.</span><span style="color:#b44">debug</span><span style="color:#666">(</span><span style="color:#b44">&#34;iam session xml == {}&#34;</span><span style="color:#666">,</span> iamSessionXml<span style="color:#666">)</span><span style="color:#666">;</span>
              Session iamSession <span style="color:#666">=</span> sessionCache<span style="color:#666">.</span><span style="color:#b44">getIfPresent</span><span style="color:#666">(</span>casAuthenticationToken<span style="color:#666">.</span><span style="color:#b44">getKeyHash</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">)</span><span style="color:#666">;</span>
              <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>iamSession <span style="color:#666">=</span><span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">null</span><span style="color:#666">)</span> <span style="color:#666">{</span>
                Unmarshaller unmarshaller <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">null</span><span style="color:#666">;</span>
                <span style="color:#a2f;font-weight:bold">try</span> <span style="color:#666">{</span>
                  unmarshaller <span style="color:#666">=</span> context<span style="color:#666">.</span><span style="color:#b44">createUnmarshaller</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">;</span>
                <span style="color:#666">}</span> <span style="color:#a2f;font-weight:bold">catch</span> <span style="color:#666">(</span>JAXBException ex<span style="color:#666">)</span> <span style="color:#666">{</span>
                  LOG<span style="color:#666">.</span><span style="color:#b44">warn</span><span style="color:#666">(</span><span style="color:#b44">&#34;cannot create unmarshaller : &#34;</span><span style="color:#666">,</span> ex<span style="color:#666">)</span><span style="color:#666">;</span>
                <span style="color:#666">}</span>
                iamSession <span style="color:#666">=</span> <span style="color:#666">(</span>Session<span style="color:#666">)</span> unmarshaller<span style="color:#666">.</span><span style="color:#b44">unmarshal</span><span style="color:#666">(</span><span style="color:#a2f;font-weight:bold">new</span> StringReader<span style="color:#666">(</span>iamSessionXml<span style="color:#666">)</span><span style="color:#666">)</span><span style="color:#666">;</span>
                sessionCache<span style="color:#666">.</span><span style="color:#b44">put</span><span style="color:#666">(</span>casAuthenticationToken<span style="color:#666">.</span><span style="color:#b44">getKeyHash</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">,</span> iamSession<span style="color:#666">)</span><span style="color:#666">;</span>
              <span style="color:#666">}</span>
              StringBuilder sessionPermissionKeyBuilder <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">new</span> StringBuilder<span style="color:#666">(</span>iamSession<span style="color:#666">.</span><span style="color:#b44">getSessionId</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">append</span><span style="color:#666">(</span>filterUrl<span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">append</span><span style="color:#666">(</span>requestMethod<span style="color:#666">)</span><span style="color:#666">;</span>
              Boolean isAllowed <span style="color:#666">=</span> accessCache<span style="color:#666">.</span><span style="color:#b44">getIfPresent</span><span style="color:#666">(</span>sessionPermissionKeyBuilder<span style="color:#666">.</span><span style="color:#b44">toString</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">)</span><span style="color:#666">;</span>
              <span style="color:#a2f;font-weight:bold">if</span><span style="color:#666">(</span>isAllowed <span style="color:#666">=</span><span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">null</span><span style="color:#666">)</span> <span style="color:#666">{</span>
                isAllowed <span style="color:#666">=</span> accessManager<span style="color:#666">.</span><span style="color:#b44">checkAccess</span><span style="color:#666">(</span>iamSession<span style="color:#666">,</span> <span style="color:#a2f;font-weight:bold">new</span> Permission<span style="color:#666">(</span>filterUrl<span style="color:#666">,</span> requestMethod<span style="color:#666">)</span><span style="color:#666">)</span><span style="color:#666">;</span>
                accessCache<span style="color:#666">.</span><span style="color:#b44">put</span><span style="color:#666">(</span>sessionPermissionKeyBuilder<span style="color:#666">.</span><span style="color:#b44">toString</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">,</span> isAllowed<span style="color:#666">)</span><span style="color:#666">;</span>
              <span style="color:#666">}</span>
              LOG<span style="color:#666">.</span><span style="color:#b44">debug</span><span style="color:#666">(</span><span style="color:#b44">&#34;{} is {} to access {} with method {}&#34;</span><span style="color:#666">,</span>
                  <span style="color:#a2f;font-weight:bold">new</span> Object<span style="color:#666">[</span><span style="color:#666">]</span> <span style="color:#666">{</span>securityContextAuthentication<span style="color:#666">.</span><span style="color:#b44">getName</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">,</span>
                      isAllowed <span style="color:#666">?</span> <span style="color:#b44">&#34;granted&#34;</span> <span style="color:#666">:</span> <span style="color:#b44">&#34;denied&#34;</span><span style="color:#666">,</span> filterUrl<span style="color:#666">,</span> requestMethod<span style="color:#666">}</span><span style="color:#666">)</span><span style="color:#666">;</span>
              <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>isAllowed<span style="color:#666">)</span> <span style="color:#666">{</span>
                <span style="color:#a2f;font-weight:bold">return</span> <span style="color:#a2f;font-weight:bold">super</span><span style="color:#666">.</span><span style="color:#b44">ACCESS_GRANTED</span><span style="color:#666">;</span>
              <span style="color:#666">}</span>
            <span style="color:#666">}</span> <span style="color:#a2f;font-weight:bold">catch</span> <span style="color:#666">(</span>Exception e<span style="color:#666">)</span> <span style="color:#666">{</span>
              LOG<span style="color:#666">.</span><span style="color:#b44">error</span><span style="color:#666">(</span><span style="color:#b44">&#34;catch exception when communicate with iam server&#34;</span><span style="color:#666">,</span> e<span style="color:#666">)</span><span style="color:#666">;</span>
            <span style="color:#666">}</span>
          <span style="color:#666">}</span>
          <span style="color:#a2f;font-weight:bold">return</span> <span style="color:#a2f;font-weight:bold">super</span><span style="color:#666">.</span><span style="color:#b44">ACCESS_DENIED</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>
      <span style="color:#666">}</span>
</code></pre></div><p>Yep, I&rsquo;m calling fortress to check if the user is allowed to access fortress permissions or not.</p>
<h5 id="2-userdetail-populator">2. UserDetail Populator</h5>
<p>Spring uses the implementation of <em>AbstractCasAssertionUserDetailsService</em> to populate user details following successful authentication, you can see the example at <em>IamUserDetails</em> code, here is the snipet of that class:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java">    <span style="color:#a2f">@Override</span>
      <span style="color:#a2f;font-weight:bold">protected</span> UserDetails <span style="color:#00a000">loadUserDetails</span><span style="color:#666">(</span><span style="color:#a2f;font-weight:bold">final</span> Assertion assertion<span style="color:#666">)</span> <span style="color:#666">{</span>
        List<span style="color:#666">&lt;</span>GrantedAuthority<span style="color:#666">&gt;</span> grantedAuthorities <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">new</span> ArrayList<span style="color:#666">&lt;</span><span style="color:#666">&gt;</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">;</span>
        LOG<span style="color:#666">.</span><span style="color:#b44">debug</span><span style="color:#666">(</span><span style="color:#b44">&#34;user asssertion : {}&#34;</span><span style="color:#666">,</span> ToStringBuilder<span style="color:#666">.</span><span style="color:#b44">reflectionToString</span><span style="color:#666">(</span>assertion<span style="color:#666">)</span><span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#0b0;font-weight:bold">boolean</span> accountNonExpired <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">true</span><span style="color:#666">;</span>
        <span style="color:#0b0;font-weight:bold">boolean</span> credentialsNonExpired <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">true</span><span style="color:#666">;</span>
        <span style="color:#0b0;font-weight:bold">boolean</span> accountNonLocked <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">true</span><span style="color:#666">;</span>
        <span style="color:#0b0;font-weight:bold">boolean</span> enabled <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">true</span><span style="color:#666">;</span>
        <span style="color:#a2f;font-weight:bold">for</span> <span style="color:#666">(</span>String attribute <span style="color:#666">:</span> <span style="color:#a2f;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#b44">attributes</span><span style="color:#666">)</span> <span style="color:#666">{</span>
          String value <span style="color:#666">=</span> <span style="color:#666">(</span>String<span style="color:#666">)</span> assertion<span style="color:#666">.</span><span style="color:#b44">getPrincipal</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">getAttributes</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">get</span><span style="color:#666">(</span>attribute<span style="color:#666">)</span><span style="color:#666">;</span>
          LOG<span style="color:#666">.</span><span style="color:#b44">debug</span><span style="color:#666">(</span><span style="color:#b44">&#34;value = {}&#34;</span><span style="color:#666">,</span> value<span style="color:#666">)</span><span style="color:#666">;</span>
          <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#666">(</span>value <span style="color:#666">!</span><span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">null</span><span style="color:#666">)</span> <span style="color:#666">{</span>
            LOG<span style="color:#666">.</span><span style="color:#b44">debug</span><span style="color:#666">(</span><span style="color:#b44">&#34;adding default authorization to user&#34;</span><span style="color:#666">)</span><span style="color:#666">;</span>
        grantedAuthorities<span style="color:#666">.</span><span style="color:#b44">add</span><span style="color:#666">(</span><span style="color:#a2f;font-weight:bold">new</span> SimpleGrantedAuthority<span style="color:#666">(</span>ROLE_USER<span style="color:#666">)</span><span style="color:#666">)</span><span style="color:#666">;</span>    

            Unmarshaller unmarshaller <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">null</span><span style="color:#666">;</span>    
            Session iamSession <span style="color:#666">=</span> <span style="color:#a2f;font-weight:bold">null</span><span style="color:#666">;</span>
            <span style="color:#a2f;font-weight:bold">try</span> <span style="color:#666">{</span>
              unmarshaller <span style="color:#666">=</span> context<span style="color:#666">.</span><span style="color:#b44">createUnmarshaller</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">;</span>
              iamSession <span style="color:#666">=</span> <span style="color:#666">(</span>Session<span style="color:#666">)</span> unmarshaller<span style="color:#666">.</span><span style="color:#b44">unmarshal</span><span style="color:#666">(</span><span style="color:#a2f;font-weight:bold">new</span> StringReader<span style="color:#666">(</span>value<span style="color:#666">)</span><span style="color:#666">)</span><span style="color:#666">;</span>
              <span style="color:#a2f;font-weight:bold">for</span> <span style="color:#666">(</span>UserRole role <span style="color:#666">:</span> iamSession<span style="color:#666">.</span><span style="color:#b44">getRoles</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">)</span> <span style="color:#666">{</span>
                LOG<span style="color:#666">.</span><span style="color:#b44">debug</span><span style="color:#666">(</span><span style="color:#b44">&#34;adding {} authorization to user&#34;</span><span style="color:#666">,</span> role<span style="color:#666">.</span><span style="color:#b44">getName</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">toUpperCase</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">)</span><span style="color:#666">;</span>
                grantedAuthorities<span style="color:#666">.</span><span style="color:#b44">add</span><span style="color:#666">(</span><span style="color:#a2f;font-weight:bold">new</span> SimpleGrantedAuthority<span style="color:#666">(</span>role<span style="color:#666">.</span><span style="color:#b44">getName</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">toUpperCase</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">)</span><span style="color:#666">)</span><span style="color:#666">;</span>
              <span style="color:#666">}</span>
            <span style="color:#666">}</span> <span style="color:#a2f;font-weight:bold">catch</span> <span style="color:#666">(</span>Exception ex<span style="color:#666">)</span> <span style="color:#666">{</span>
              LOG<span style="color:#666">.</span><span style="color:#b44">error</span><span style="color:#666">(</span><span style="color:#b44">&#34;cannot generate user details&#34;</span><span style="color:#666">,</span> ex<span style="color:#666">)</span><span style="color:#666">;</span>
            <span style="color:#666">}</span>
          <span style="color:#666">}</span>
        <span style="color:#666">}</span>
        LOG<span style="color:#666">.</span><span style="color:#b44">debug</span><span style="color:#666">(</span>
            <span style="color:#b44">&#34;accountNonExpired : {}, credentialsNonExpired : {}, accountNonLocked : {}, enabled : {}&#34;</span><span style="color:#666">,</span>
            <span style="color:#a2f;font-weight:bold">new</span> Object<span style="color:#666">[</span><span style="color:#666">]</span> <span style="color:#666">{</span>accountNonExpired<span style="color:#666">,</span> credentialsNonExpired<span style="color:#666">,</span> accountNonLocked<span style="color:#666">,</span> enabled<span style="color:#666">}</span><span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#a2f;font-weight:bold">return</span> <span style="color:#a2f;font-weight:bold">new</span> User<span style="color:#666">(</span>assertion<span style="color:#666">.</span><span style="color:#b44">getPrincipal</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">getName</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">toLowerCase</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">.</span><span style="color:#b44">trim</span><span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">,</span> NON_EXISTENT_PASSWORD_VALUE<span style="color:#666">,</span> enabled<span style="color:#666">,</span>
            accountNonExpired<span style="color:#666">,</span> credentialsNonExpired<span style="color:#666">,</span> accountNonLocked<span style="color:#666">,</span> grantedAuthorities<span style="color:#666">)</span><span style="color:#666">;</span>
      <span style="color:#666">}</span>
</code></pre></div><p>You can change the implementation later for your needs.</p>
<h5 id="3-network-might-be-a-problem">3. Network Might Be a Problem</h5>
<p>Since this is running inside a production environment, we needed to consider that sometimes there might be a trouble over our network that causes problems and requires retries. That is why it&rsquo;s important to allow a little delay time in our application.  Here&rsquo;s an example of how allow a small delay, in order to allow temporary network glitches and slowdowns to work themselves out.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Java" data-lang="Java">    <span style="color:#080;font-style:italic">/*
</span><span style="color:#080;font-style:italic">     * Copyright 2017 to PT. Global Digital Niaga(Blibli.com)
</span><span style="color:#080;font-style:italic">     * 
</span><span style="color:#080;font-style:italic">     * Licensed under the Apache License, Version 2.0; you may not use this file except in compliance
</span><span style="color:#080;font-style:italic">     * with the License. You may obtain a copy of the License at
</span><span style="color:#080;font-style:italic">     * 
</span><span style="color:#080;font-style:italic">     * http://www.apache.org/licenses/LICENSE-2.0
</span><span style="color:#080;font-style:italic">     * 
</span><span style="color:#080;font-style:italic">     * Unless required by applicable law or agreed to in writing, software distributed under the License
</span><span style="color:#080;font-style:italic">     * is distributed on an &#34;AS IS&#34; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
</span><span style="color:#080;font-style:italic">     * or implied. See the License for the specific language governing permissions and limitations under
</span><span style="color:#080;font-style:italic">     * the License.
</span><span style="color:#080;font-style:italic">     */</span>
    <span style="color:#a2f;font-weight:bold">package</span> <span style="color:#00f;font-weight:bold">com.gdn.iam.spring.security</span><span style="color:#666">;</span>
    
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.slf4j.Logger</span><span style="color:#666">;</span>
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.slf4j.LoggerFactory</span><span style="color:#666">;</span>
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.springframework.security.cas.authentication.CasAuthenticationProvider</span><span style="color:#666">;</span>
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.springframework.security.core.Authentication</span><span style="color:#666">;</span>
    <span style="color:#a2f;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">org.springframework.security.core.AuthenticationException</span><span style="color:#666">;</span>
    
    <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#a2f;font-weight:bold">class</span> <span style="color:#00f">GdnCasAuthenticationProvider</span> <span style="color:#a2f;font-weight:bold">extends</span> CasAuthenticationProvider <span style="color:#666">{</span>
    
      <span style="color:#a2f;font-weight:bold">private</span> <span style="color:#a2f;font-weight:bold">static</span> <span style="color:#a2f;font-weight:bold">transient</span> Logger LOG <span style="color:#666">=</span> LoggerFactory<span style="color:#666">.</span><span style="color:#b44">getLogger</span><span style="color:#666">(</span>GdnCasAuthenticationProvider<span style="color:#666">.</span><span style="color:#b44">class</span><span style="color:#666">)</span><span style="color:#666">;</span>
      <span style="color:#a2f;font-weight:bold">private</span> <span style="color:#0b0;font-weight:bold">long</span> sleepForDistributeTicketTime <span style="color:#666">=</span> 300<span style="color:#666">;</span>
    
      <span style="color:#a2f">@Override</span>
      <span style="color:#a2f;font-weight:bold">public</span> Authentication <span style="color:#00a000">authenticate</span><span style="color:#666">(</span>Authentication authentication<span style="color:#666">)</span> <span style="color:#a2f;font-weight:bold">throws</span> AuthenticationException <span style="color:#666">{</span>
        <span style="color:#a2f;font-weight:bold">try</span> <span style="color:#666">{</span>
          LOG<span style="color:#666">.</span><span style="color:#b44">trace</span><span style="color:#666">(</span>
              <span style="color:#b44">&#34;will try to sleep for waiting ticket to be distributed to other node, sleep time : {}&#34;</span><span style="color:#666">,</span>
              getSleepForDistributeTicketTime<span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">)</span><span style="color:#666">;</span>
          Thread<span style="color:#666">.</span><span style="color:#b44">sleep</span><span style="color:#666">(</span>getSleepForDistributeTicketTime<span style="color:#666">(</span><span style="color:#666">)</span><span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#666">}</span> <span style="color:#a2f;font-weight:bold">catch</span> <span style="color:#666">(</span>InterruptedException e<span style="color:#666">)</span> <span style="color:#666">{</span>
          LOG<span style="color:#666">.</span><span style="color:#b44">error</span><span style="color:#666">(</span><span style="color:#b44">&#34;something wrong when sleeping&#34;</span><span style="color:#666">,</span> e<span style="color:#666">)</span><span style="color:#666">;</span>
        <span style="color:#666">}</span>
        <span style="color:#a2f;font-weight:bold">return</span> <span style="color:#a2f;font-weight:bold">super</span><span style="color:#666">.</span><span style="color:#b44">authenticate</span><span style="color:#666">(</span>authentication<span style="color:#666">)</span><span style="color:#666">;</span>
      <span style="color:#666">}</span>
    
      <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#0b0;font-weight:bold">long</span> <span style="color:#00a000">getSleepForDistributeTicketTime</span><span style="color:#666">(</span><span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#a2f;font-weight:bold">return</span> sleepForDistributeTicketTime<span style="color:#666">;</span>
      <span style="color:#666">}</span>
    
      <span style="color:#a2f;font-weight:bold">public</span> <span style="color:#0b0;font-weight:bold">void</span> <span style="color:#00a000">setSleepForDistributeTicketTime</span><span style="color:#666">(</span><span style="color:#0b0;font-weight:bold">long</span> sleepForDistributeTicketTime<span style="color:#666">)</span> <span style="color:#666">{</span>
        <span style="color:#a2f;font-weight:bold">this</span><span style="color:#666">.</span><span style="color:#b44">sleepForDistributeTicketTime</span> <span style="color:#666">=</span> sleepForDistributeTicketTime<span style="color:#666">;</span>
      <span style="color:#666">}</span>
    
    <span style="color:#666">}</span>
</code></pre></div><h3 id="descriptions-of-authentication-flow">Descriptions of authentication flow</h3>
<p>The <strong>CAS</strong> authentication flow will be the same, no changes are required in terms of that authentication flow. Furthermore, you can see that flow at <a href="https://www.apereo.org/projects/cas">Apereo CAS</a> 4.2.x documentation page.</p>
<p>The main difference now is we don&rsquo;t put the ticket registry inside an in-memory database, we put it inside an <a href="https://ignite.apache.org/">Apache Ignite</a> cache, so when other nodes are there it can replicate the ticket between them which increases efficiencies.</p>
<h3 id="descriptions-of-authorization-flow">Descriptions of authorization flow</h3>
<p><strong>Spring Security</strong> usually has the authorization role configuration inside your spring <em>context xml</em> file or using annotations in source. This is the only difference between plain spring security and that using my extended framework solution.  We put the configuration inside of <strong>Fortress</strong>. Everytime the user changes the URL, it will check the user has access to that specific URL and not through the extended voter class. If the user is authorized then the app will give them the correct page, otherwise it will route to 40X http error status page.</p>
<h3 id="instructions-to-test">Instructions to test</h3>
<p>For testing this example, you need to understand that <strong>Apache Fortress</strong> configuration is necessary to find <em>fortress.properties</em> on the classpath so it might be good if you put that configuration file at the same classpath, for instance, if you are using <strong>Apache Tomcat</strong> remove all the <em>fortress.properties</em> inside the classes directory and put it on <em>$TOMCAT_HOME/lib/</em> folder. Make sure get <strong>Apache Fortress</strong> running at the first step. Here are the detailed instructions for testing this example:</p>
<h4 id="server-section">Server Section</h4>
<h5 id="1-read-and-find-the-instructions-at">1. Read and find the instructions at:</h5>
<ul>
<li><a href="https://github.com/apache/directory-fortress-core">https://github.com/apache/directory-fortress-core</a></li>
<li><a href="https://github.com/apache/directory-fortress-enmasse">https://github.com/apache/directory-fortress-enmasse</a></li>
<li><a href="https://github.com/apache/directory-fortress-commander">https://github.com/apache/directory-fortress-commander</a></li>
</ul>
<p>and configure your <strong>Apache Fortress</strong> properly.</p>
<h5 id="2-clone-the-project-from-link-at-where-to-download-section-below-change-the-configuration-properly-inside-cas-fortress-serverssrcmainresources-folder-and-package-it-using">2. Clone the project from link at <em>Where to download</em> section below, change the configuration properly inside <em>cas-fortress-servers/src/main/resources</em> folder and package it using:</h5>
<pre><code class="language-Maven" data-lang="Maven">    mvn clean package.
</code></pre><p>Copy the war file from <em>cas-fortress-server/target</em> into the <em>web-container</em> deploy directory.</p>
<h5 id="3-start-your-web-container-and-you-get-cas-fortress-integrated">3. Start your web-container and you get CAS fortress integrated.</h5>
<h4 id="client-section">Client Section</h4>
<ul>
<li>Simply put the war file inside the <em>web-container</em> deploy directory.</li>
<li>Open and login to your commander(fortress-web)</li>
<li>Create a user with role <em>ROLE_USER</em> (you can change to what ever role). The role need to align with spring-security.xml for this statement <em>&gt;intercept-url pattern=&rdquo;/**&rdquo; access=&quot;hasRole(&lsquo;ROLE_USER&rsquo;)&rdquo; /&lt;</em>. This is the mandatory role, with this role we are seperate between the anonymous role and authenticate one.</li>
<li>Create a permission object containing your restricted url, for instance <em>http://localhost:8080/cas-fortress-client/profile</em> and <em>http://localhost:8080/cas-fortress-client/catalog</em>.</li>
<li>Map the permission object and role at permission tab at your commander. Currently we only support get for both of the url.</li>
<li>Start your web-container and play with your <em>cas-fortress-client</em> later on.</li>
</ul>
<h3 id="where-to-download">Where to download</h3>
<ul>
<li><a href="https://github.com/bliblidotcom/cas-fortress-example">https://github.com/bliblidotcom/cas-fortress-example</a></li>
</ul>
<h2 id="next-steps">Next Steps</h2>
<p>Next should be implementing <strong>ARBAC</strong> solution. Since I don&rsquo;t allow people to create conditional statements inside their application code to check for roles, buttons or page elements that should be not accessible for specific users will appear on their pages, even they can&rsquo;t perform that particular action.  This causes some confusion in terms or usability for my users. With ARBAC I believe I can do a whitelist for the page attributes and increase the usability for the user.</p>


            

        </div>
        <div id="endContent"></div>
    </div>

    <div id="footer">
    &copy; 2003-2021, <a href="http://www.apache.org">The Apache Software Foundation</a> - <a href="/privacy-policy.html">Privacy Policy</a><br />
    Apache Directory, ApacheDS, Apache Directory Server, Apache Directory Studio, Apache LDAP API, Apache Triplesec,
    Triplesec, Apache Mavibot, Mavibot, Apache eSCIMo, eSCIMo, Apache SCIMple, SCIMple,Fortress, Apache Fortress, EnMasse,
    Apache EnMasse, Apache Kerby, Kerby, Apache, the Apache feather logo, and the Apache Directory project logos are
    trademarks of The Apache Software Foundation.
</div>

</div>

</body>

</html>
